- **å®˜æ–¹æ–‡æ¡£**ï¼šhttps://docs.python.org/zh-cn/3.13/library/concurrency.html

# Python å¹¶å‘ç¼–ç¨‹å®Œå…¨æŒ‡å—

---

# ç¬¬ä¸€éƒ¨åˆ†ï¼šå¹¶å‘ç¼–ç¨‹åŸºç¡€ç†è®º

## 1. å¹¶å‘ç¼–ç¨‹æ¦‚è¿°

### 1.1 å¹¶å‘ç¼–ç¨‹çš„æ¦‚å¿µä¸ç›®æ ‡

å¹¶å‘ç¼–ç¨‹çš„æ ¸å¿ƒç›®æ ‡æ˜¯æé«˜ç¨‹åºæ‰§è¡Œæ•ˆç‡ï¼Œå……åˆ†åˆ©ç”¨å¤šæ ¸CPUèµ„æºï¼Œä½¿å¾—å¤šä¸ªä»»åŠ¡èƒ½å¤Ÿåœ¨åŒä¸€æ—¶é—´æ®µå†…è¿›è¡Œå¤„ç†ï¼Œè¾¾åˆ°æé«˜è®¡ç®—æœºèµ„æºåˆ©ç”¨ç‡çš„æ•ˆæœã€‚å¹¶å‘ç¼–ç¨‹ä¸ä»…èƒ½æ”¹å–„ç¨‹åºæ€§èƒ½ï¼Œè¿˜èƒ½åœ¨I/Oå¯†é›†å‹ä»»åŠ¡ä¸­å‡å°‘ç­‰å¾…æ—¶é—´ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚

### 1.2 å¹¶è¡Œ vs å¹¶å‘ vs ä¸²è¡Œ

```mermaid
graph TD
    A[ä»»åŠ¡æ‰§è¡Œæ–¹å¼] --> B[ä¸²è¡Œ Serial]
    A --> C[å¹¶å‘ Concurrent]
    A --> D[å¹¶è¡Œ Parallel]

    B --> B1[ä»»åŠ¡1 â†’ ä»»åŠ¡2 â†’ ä»»åŠ¡3<br/>ä¾æ¬¡æ‰§è¡Œï¼Œä¸€ä¸ªä»»åŠ¡å®Œæˆåæ‰å¼€å§‹ä¸‹ä¸€ä¸ª]
    C --> C1[ä»»åŠ¡1ã€ä»»åŠ¡2ã€ä»»åŠ¡3<br/>åœ¨å•æ ¸CPUä¸Šäº¤æ›¿æ‰§è¡Œï¼Œçœ‹ä¼¼åŒæ—¶è¿›è¡Œ]
    D --> D1[ä»»åŠ¡1ã€ä»»åŠ¡2ã€ä»»åŠ¡3<br/>åœ¨å¤šæ ¸CPUä¸ŠçœŸæ­£åŒæ—¶æ‰§è¡Œ]

    style B1 fill:#ffcccc
    style C1 fill:#ffffcc
    style D1 fill:#ccffcc
```

- **ä¸²è¡Œï¼ˆSerialï¼‰**ï¼šå¤šä¸ªä»»åŠ¡ä¾æ¬¡æ‰§è¡Œï¼Œä¸€ä¸ªä»»åŠ¡å®Œæˆåï¼Œæ‰å¼€å§‹ä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚
- **å¹¶å‘ï¼ˆConcurrentï¼‰**ï¼šå¤šä¸ªä»»åŠ¡åœ¨åŒä¸€ä¸ªCPUæ ¸å¿ƒä¸Šäº¤æ›¿æ‰§è¡Œï¼Œçœ‹ä¼¼åŒæ—¶è¿›è¡Œï¼Œå®é™…ä¸Šä»»åŠ¡æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼Œé€‚ç”¨äºå•æ ¸CPUã€‚
- **å¹¶è¡Œï¼ˆParallelï¼‰**ï¼šå¤šä¸ªä»»åŠ¡åœ¨å¤šä¸ªCPUæ ¸å¿ƒä¸ŠåŒæ—¶æ‰§è¡Œï¼Œé€‚ç”¨äºå¤šæ ¸CPUçš„ç¯å¢ƒã€‚

### 1.3 å®ç°å¤šä»»åŠ¡çš„ä¸‰ç§æ–¹å¼

#### 1.3.1 è¿›ç¨‹ (Process)

- **å®šä¹‰**ï¼šè¿›ç¨‹æ˜¯æ“ä½œç³»ç»Ÿä¸­èµ„æºåˆ†é…å’Œç‹¬ç«‹æ‰§è¡Œçš„åŸºæœ¬å•ä½ã€‚æ¯ä¸ªè¿›ç¨‹æœ‰ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ã€ä»£ç æ®µã€æ•°æ®æ®µã€å †æ ˆç­‰ï¼Œæ“ä½œç³»ç»Ÿä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…èµ„æºã€‚
- **ç‰¹ç‚¹**ï¼š
    - è¿›ç¨‹ä¹‹é—´äº’ç›¸ç‹¬ç«‹ï¼Œå½¼æ­¤ä¸å…±äº«å†…å­˜ã€‚
    - ä¸€ä¸ªè¿›ç¨‹å´©æºƒä¸ä¼šç›´æ¥å½±å“åˆ°å…¶ä»–è¿›ç¨‹ã€‚
    - è¿›ç¨‹çš„åˆ›å»ºå’Œé”€æ¯æˆæœ¬è¾ƒé«˜ã€‚
- **é€‚ç”¨åœºæ™¯**ï¼š
    - é€‚åˆæ‰§è¡Œå®Œå…¨ç‹¬ç«‹çš„ä»»åŠ¡ï¼Œä¾‹å¦‚ç‹¬ç«‹çš„æœåŠ¡è¿›ç¨‹ã€è®¡ç®—å¯†é›†å‹ä»»åŠ¡ã€‚
- **æ³¨æ„äº‹é¡¹**ï¼š
    - è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ï¼ˆIPCï¼ŒInter-process Communicationï¼‰é€šå¸¸æ¯”çº¿ç¨‹å¤æ‚ï¼Œä¾‹å¦‚é€šè¿‡ç®¡é“ã€æ¶ˆæ¯é˜Ÿåˆ—æˆ–å…±äº«å†…å­˜ã€‚

#### 1.3.2 çº¿ç¨‹ (Thread)

- **å®šä¹‰**ï¼šçº¿ç¨‹æ˜¯è¿›ç¨‹å†…éƒ¨çš„æœ€å°æ‰§è¡Œå•å…ƒï¼Œæ˜¯æ“ä½œç³»ç»Ÿè°ƒåº¦å’Œæ‰§è¡Œçš„åŸºæœ¬å•ä½ã€‚ä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹å…±äº«è¿›ç¨‹çš„èµ„æºï¼Œå¦‚å†…å­˜ç©ºé—´ã€æ–‡ä»¶æè¿°ç¬¦ç­‰ã€‚
- **ç‰¹ç‚¹**ï¼š
    - çº¿ç¨‹ä¹‹é—´å…±äº«è¿›ç¨‹çš„å†…å­˜ç©ºé—´ï¼Œè¿™ä½¿å¾—çº¿ç¨‹ä¹‹é—´çš„æ•°æ®äº¤æ¢éå¸¸é«˜æ•ˆã€‚
    - çº¿ç¨‹çš„åˆ›å»ºå’Œé”€æ¯æ¯”è¿›ç¨‹è½»é‡ã€‚
    - çº¿ç¨‹é—´çš„èµ„æºç«äº‰å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼Œéœ€ä½¿ç”¨åŒæ­¥æœºåˆ¶ï¼ˆå¦‚é”ï¼‰é¿å…å†²çªã€‚
- **é€‚ç”¨åœºæ™¯**ï¼š
    - é€‚ç”¨äºä»»åŠ¡ç´§å¯†ç›¸å…³çš„å¹¶å‘æ“ä½œï¼Œä¾‹å¦‚WebæœåŠ¡å™¨ã€è®¡ç®—å¯†é›†å‹ä»»åŠ¡ä¸­çš„å¹¶è¡Œå¤„ç†ã€‚
- **æ³¨æ„äº‹é¡¹**ï¼š
    - çº¿ç¨‹æ˜¯è½»é‡çº§çš„ï¼Œä½†ä»ç„¶éœ€è¦æ“ä½œç³»ç»Ÿè¿›è¡Œè°ƒåº¦ã€‚
    - çº¿ç¨‹ä¹‹é—´çš„åŒæ­¥æ˜¯å¹¶å‘ç¼–ç¨‹çš„ä¸€ä¸ªé‡è¦é—®é¢˜ï¼Œå¸¸ç”¨çš„åŒæ­¥æœºåˆ¶æœ‰ï¼šäº’æ–¥é”ï¼ˆmutexï¼‰ã€æ¡ä»¶å˜é‡ã€è¯»å†™é”ç­‰ã€‚

#### 1.3.3 åç¨‹ (Coroutine)

- **å®šä¹‰**ï¼šåç¨‹æ˜¯ç”¨æˆ·æ€çš„è½»é‡çº§çº¿ç¨‹ï¼Œç”±ç¨‹åºå‘˜é€šè¿‡ä»£ç æ§åˆ¶å…¶è°ƒåº¦ã€‚åç¨‹é€šè¿‡è®©å‡ºæ§åˆ¶æƒæ¥æ¨¡æ‹Ÿå¤šçº¿ç¨‹çš„è¡Œä¸ºï¼Œä¸ä¾èµ–æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹è°ƒåº¦ã€‚
- **ç‰¹ç‚¹**ï¼š
    - åç¨‹ä¹‹é—´çš„åˆ‡æ¢éå¸¸è½»é‡ï¼Œé€šå¸¸ä¸éœ€è¦æ“ä½œç³»ç»Ÿå¹²é¢„ã€‚
    - åç¨‹å¯ä»¥åœ¨å•ä¸ªçº¿ç¨‹å†…å®ç°å¹¶å‘ï¼Œé€‚åˆå¤„ç†å¤§é‡I/Oå¯†é›†å‹æ“ä½œã€‚
    - åç¨‹ä¹‹é—´çš„é€šä¿¡éå¸¸é«˜æ•ˆï¼Œå› ä¸ºå®ƒä»¬å…±äº«å†…å­˜ç©ºé—´ã€‚
- **é€‚ç”¨åœºæ™¯**ï¼š
    - é€‚ç”¨äºI/Oå¯†é›†å‹ä»»åŠ¡ï¼Œå¦‚ç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶æ“ä½œç­‰ã€‚é€šè¿‡éé˜»å¡å¼I/Oæ“ä½œï¼Œåç¨‹èƒ½å¤Ÿåœ¨ç­‰å¾…I/Oçš„è¿‡ç¨‹ä¸­æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œä»è€Œæå‡ç¨‹åºçš„å“åº”é€Ÿåº¦ã€‚
- **æ³¨æ„äº‹é¡¹**ï¼š
    - åç¨‹æ˜¯å•çº¿ç¨‹å†…çš„è°ƒåº¦ï¼Œå› æ­¤æ— æ³•ç›´æ¥åˆ©ç”¨å¤šæ ¸CPUè¿›è¡Œå¹¶è¡Œè®¡ç®—ã€‚å¯¹äºè®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼Œåç¨‹çš„ä¼˜åŠ¿ä¸æ˜æ˜¾ã€‚

### 1.4 å„ç§æ–¹å¼çš„å¯¹æ¯”ä¸é€‰æ‹©

| ç‰¹æ€§ | è¿›ç¨‹ | çº¿ç¨‹ | åç¨‹ |
| :--- | :--- | :--- | :--- |
| è°ƒåº¦å•ä½ | æ“ä½œç³»ç»Ÿ | æ“ä½œç³»ç»Ÿ | ç”¨æˆ·ä»£ç  |
| å†…å­˜ç©ºé—´ | ç‹¬ç«‹ | å…±äº« | å…±äº« |
| åˆ›å»º/é”€æ¯æˆæœ¬ | é«˜ | ä¸­ | ä½ |
| å¹¶å‘æ€§èƒ½ | è¾ƒå·® | è¾ƒå¥½ | æœ€å¥½ |
| é€šä¿¡æ–¹å¼ | IPC | å…±äº«å†…å­˜ã€åŒæ­¥ | å…±äº«å†…å­˜ |
| é€‚ç”¨åœºæ™¯ | å®Œå…¨ç‹¬ç«‹ä»»åŠ¡ | å¯†åˆ‡ç›¸å…³ä»»åŠ¡ | I/Oå¯†é›†å‹ä»»åŠ¡ |
| CPUåˆ©ç”¨ | çœŸæ­£å¹¶è¡Œ | å—GILé™åˆ¶ | å•çº¿ç¨‹ |

### 1.5 é€‚ç”¨åœºæ™¯ä¸é€‰æ‹©ç­–ç•¥

```mermaid
flowchart TD
    A[é€‰æ‹©å¹¶å‘æ–¹å¼] --> B{ä»»åŠ¡ç±»å‹?}
    B -->|CPUå¯†é›†å‹| C[å¤šè¿›ç¨‹]
    B -->|I/Oå¯†é›†å‹| D{ä»»åŠ¡æ•°é‡?}
    B -->|æ··åˆå‹| E[è¿›ç¨‹+çº¿ç¨‹]

    D -->|å°‘é‡ä»»åŠ¡| F[å¤šçº¿ç¨‹]
    D -->|å¤§é‡ä»»åŠ¡| G[åç¨‹]

    C --> C1[ä¼˜ç‚¹ï¼šçœŸæ­£å¹¶è¡Œ<br/>ç¼ºç‚¹ï¼šèµ„æºå¼€é”€å¤§]
    F --> F1[ä¼˜ç‚¹ï¼šèµ„æºå¼€é”€ä¸­ç­‰<br/>ç¼ºç‚¹ï¼šå—GILé™åˆ¶]
    G --> G1[ä¼˜ç‚¹ï¼šèµ„æºå¼€é”€æœ€å°<br/>ç¼ºç‚¹ï¼šæ— æ³•åˆ©ç”¨å¤šæ ¸]

    style C1 fill:#ccffcc
    style F1 fill:#ffffcc
    style G1 fill:#ffcccc
```

- **è¿›ç¨‹**é€‚åˆç‹¬ç«‹ã€äº’ä¸å¹²æ‰°çš„ä»»åŠ¡ã€‚æ¯”å¦‚ï¼Œå¤šä¸ªç‹¬ç«‹æœåŠ¡æˆ–è®¡ç®—å¯†é›†å‹ä»»åŠ¡ã€‚
- **çº¿ç¨‹**é€‚åˆä»»åŠ¡ç›¸å…³ã€éœ€è¦å…±äº«æ•°æ®çš„åœºæ™¯ã€‚å¤šçº¿ç¨‹é€šå¸¸ç”¨äºéœ€è¦é«˜å¹¶å‘è®¡ç®—çš„ä»»åŠ¡ï¼Œä½†è¦å°å¿ƒåŒæ­¥é—®é¢˜ã€‚
- **åç¨‹**é€‚åˆI/Oå¯†é›†å‹ä»»åŠ¡ï¼Œå°¤å…¶æ˜¯éœ€è¦é«˜å¹¶å‘å¤„ç†çš„åœºæ™¯ï¼Œå¦‚é«˜å¹¶å‘çš„WebæœåŠ¡å™¨ã€çˆ¬è™«ç¨‹åºç­‰ï¼ˆæœ‰ä¸€ç‚¹åƒæˆ‘ä»¬çš„rtosçš„å¤šä»»åŠ¡ï¼Œä½†æ˜¯åç¨‹æ˜¯åŸºäºyieldå’Œawaitä¸»åŠ¨è®©å‡ºï¼‰ã€‚

## 2. åŒæ­¥ä¸å¼‚æ­¥ã€é˜»å¡ä¸éé˜»å¡

### 2.1 åŸºç¡€æ¦‚å¿µè¯¦è§£

è¿™å››ä¸ªæ¦‚å¿µæœ‰åŠ©äºç†è§£è¿›ç¨‹å’Œçº¿ç¨‹å¦‚ä½•å¤„ç†ä»»åŠ¡ï¼Œå®ƒä»¬æ˜¯å¹¶å‘ç¼–ç¨‹ä¸­çš„é‡è¦ç†è®ºåŸºç¡€ã€‚

```mermaid
graph TD
    A[æ‰§è¡Œæ¨¡å¼åˆ†ç±»] --> B[åŒæ­¥ vs å¼‚æ­¥]
    A --> C[é˜»å¡ vs éé˜»å¡]

    B --> B1[åŒæ­¥ Synchronous<br/>ä»»åŠ¡æŒ‰é¡ºåºæ‰§è¡Œï¼Œéœ€è¦ç­‰å¾…]
    B --> B2[å¼‚æ­¥ Asynchronous<br/>ä»»åŠ¡å¯ä»¥äº¤æ›¿æ‰§è¡Œ]

    C --> C1[é˜»å¡ Blocking<br/>ç­‰å¾…æ—¶CPUåœæ­¢å·¥ä½œ]
    C --> C2[éé˜»å¡ Non-blocking<br/>ç­‰å¾…æ—¶CPUå¯ä»¥åšå…¶ä»–äº‹]
```

#### 2.1.1 åŒæ­¥ä¸å¼‚æ­¥

- **åŒæ­¥ï¼ˆSynchronousï¼‰**ï¼šä»»åŠ¡æ‰§è¡Œæ—¶ï¼Œåç»­ä»»åŠ¡å¿…é¡»ç­‰å¾…å‰ä¸€ä¸ªä»»åŠ¡å®Œæˆã€‚
- **å¼‚æ­¥ï¼ˆAsynchronousï¼‰**ï¼šä»»åŠ¡æ‰§è¡Œæ—¶ï¼Œåç»­ä»»åŠ¡å¯ä»¥åœ¨ç­‰å¾…ä»»åŠ¡å®Œæˆçš„åŒæ—¶æ‰§è¡Œã€‚

#### 2.1.2 é˜»å¡ä¸éé˜»å¡

- **é˜»å¡ï¼ˆBlockingï¼‰**ï¼šä»»åŠ¡ç­‰å¾…æŸä¸ªæ“ä½œå®Œæˆæ—¶ï¼Œå½“å‰ä»»åŠ¡æš‚åœæ‰§è¡Œï¼ŒCPUä¸æ‰§è¡Œå…¶ä»–ä»»åŠ¡ã€‚
- **éé˜»å¡ï¼ˆNon-blockingï¼‰**ï¼šä»»åŠ¡ç­‰å¾…æŸä¸ªæ“ä½œå®Œæˆæ—¶ï¼ŒCPUä»ç„¶å¯ä»¥æ‰§è¡Œå…¶ä»–ä»»åŠ¡ã€‚

### 2.2 å››ç§ç»„åˆæ–¹å¼

è¿™å››ç§æ–¹å¼å¯ä»¥ç»„åˆå½¢æˆä¸åŒçš„æ‰§è¡Œæ¨¡å¼ï¼š

```mermaid
graph TD
    A[æ‰§è¡Œæ¨¡å¼ç»„åˆ] --> B[åŒæ­¥é˜»å¡<br/>Synchronous Blocking]
    A --> C[å¼‚æ­¥é˜»å¡<br/>Asynchronous Blocking]
    A --> D[åŒæ­¥éé˜»å¡<br/>Synchronous Non-blocking]
    A --> E[å¼‚æ­¥éé˜»å¡<br/>Asynchronous Non-blocking]

    B --> B1[ä»»åŠ¡é¡ºåºæ‰§è¡Œ<br/>ç­‰å¾…æ—¶CPUç©ºé—²<br/>æ•ˆç‡æœ€ä½]
    C --> C1[ä»»åŠ¡å¯äº¤æ›¿æ‰§è¡Œ<br/>ä½†é˜»å¡æ—¶CPUç©ºé—²<br/>æ•ˆç‡è¾ƒä½]
    D --> D1[ä»»åŠ¡é¡ºåºæ‰§è¡Œ<br/>ç­‰å¾…æ—¶CPUå¯åˆ‡æ¢<br/>æ•ˆç‡ä¸­ç­‰]
    E --> E1[ä»»åŠ¡å¯äº¤æ›¿æ‰§è¡Œ<br/>ç­‰å¾…æ—¶CPUå¯åˆ‡æ¢<br/>æ•ˆç‡æœ€é«˜]

    style B1 fill:#ffcccc
    style C1 fill:#ffddcc
    style D1 fill:#ffffcc
    style E1 fill:#ccffcc
```

- **åŒæ­¥é˜»å¡**ï¼šä»»åŠ¡ä¸€ä¸ªæ¥ä¸€ä¸ªåœ°æ‰§è¡Œï¼Œç­‰å¾…æ—¶CPUä¸åšå…¶ä»–äº‹ã€‚
- **å¼‚æ­¥é˜»å¡**ï¼šä»»åŠ¡å¯ä»¥äº¤æ›¿æ‰§è¡Œï¼Œä½†ä¸€æ—¦æŸä¸ªä»»åŠ¡é˜»å¡ï¼ŒCPUä¹Ÿä¼šåœé¡¿ã€‚
- **åŒæ­¥éé˜»å¡**ï¼šä»»åŠ¡ä¸€ä¸ªæ¥ä¸€ä¸ªåœ°æ‰§è¡Œï¼Œç­‰å¾…æ—¶CPUå¯ä»¥åˆ‡æ¢åˆ°å…¶ä»–ä»»åŠ¡ã€‚
- **å¼‚æ­¥éé˜»å¡**ï¼šå¤šä¸ªä»»åŠ¡å¯ä»¥äº¤æ›¿æ‰§è¡Œï¼Œä»»ä½•ä»»åŠ¡é˜»å¡æ—¶ï¼ŒCPUä¹Ÿèƒ½ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡ã€‚

### 2.3 ç¤ºä¾‹

```python
import time
import requests

def sync_blocking_example():
    """åŒæ­¥é˜»å¡ç¤ºä¾‹ï¼šä¾æ¬¡è¯·æ±‚å¤šä¸ªURL"""
    urls = ['http://httpbin.org/delay/1'] * 3
    start_time = time.time()

    for url in urls:
        response = requests.get(url)  # é˜»å¡ç­‰å¾…å“åº”
        print(f"Got response: {response.status_code}")

    print(f"Total time: {time.time() - start_time:.2f}s")
    # è¾“å‡ºå¤§çº¦ï¼šTotal time: 3.xx s

```

---

# ç¬¬äºŒéƒ¨åˆ†ï¼šå¤šè¿›ç¨‹

## 3. è¿›ç¨‹åŸºç¡€ç†è®º

### 3.1 è¿›ç¨‹çš„å®šä¹‰ä¸ç»„æˆ

#### 3.1.1 è¿›ç¨‹çš„å®šä¹‰

- **ç‹­ä¹‰å®šä¹‰**ï¼šè¿›ç¨‹æ˜¯æ­£åœ¨è¿è¡Œçš„ç¨‹åºå®ä¾‹ï¼Œæ¯”å¦‚è¿è¡Œä¸€ä¸ªpythonè„šæœ¬ã€‚
- **å¹¿ä¹‰å®šä¹‰**ï¼šè¿›ç¨‹æ˜¯ä¸€ä¸ªç¨‹åºåœ¨æ“ä½œç³»ç»Ÿä¸­çš„ä¸€æ¬¡æ‰§è¡Œå®ä¾‹ï¼ŒåŒ…å«ç¨‹åºã€æ•°æ®ã€ä»¥åŠç³»ç»Ÿä¸ºæ‰§è¡Œè¯¥ç¨‹åºåˆ†é…çš„èµ„æºã€‚

#### 3.1.2 è¿›ç¨‹ä¸ç¨‹åºçš„åŒºåˆ«

- **ç¨‹åº**æ˜¯é™æ€çš„ï¼Œå®ƒåªæ˜¯å­˜å‚¨åœ¨ç£ç›˜ä¸Šçš„ä»£ç æ–‡ä»¶ã€‚
- **è¿›ç¨‹**æ˜¯ç¨‹åºçš„åŠ¨æ€å®ä¾‹ï¼Œæ˜¯æ“ä½œç³»ç»Ÿè¿›è¡Œèµ„æºåˆ†é…å’Œç®¡ç†çš„åŸºæœ¬å•ä½ï¼ŒåŒ…å«ç¨‹åºä»£ç åŠå…¶è¿è¡Œæ—¶æ‰€éœ€çš„èµ„æºã€‚

ä¸€ä¸ªç¨‹åºå¯ä»¥æœ‰å¤šä¸ªè¿›ç¨‹å®ä¾‹ï¼Œæ¯ä¸ªè¿›ç¨‹äº’ç›¸ç‹¬ç«‹æ‰§è¡Œã€‚

#### 3.1.3 è¿›ç¨‹çš„ç»„æˆ

ä¸€ä¸ªè¿›ç¨‹ä¸»è¦ç”±ä»¥ä¸‹éƒ¨åˆ†ç»„æˆï¼š

1. **ç¨‹åºæ®µ**ï¼šå­˜å‚¨åœ¨å†…å­˜ä¸­çš„ä»£ç æ®µï¼Œæ˜¯è¿›ç¨‹æ‰§è¡Œçš„æŒ‡ä»¤é›†ã€‚
2. **æ•°æ®æ®µ**ï¼šè¿›ç¨‹æ‰§è¡Œæ—¶æ‰€éœ€çš„æ•°æ®ï¼ŒåŒ…æ‹¬å…¨å±€å˜é‡å’Œå±€éƒ¨å˜é‡ç­‰ã€‚
3. **è¿›ç¨‹æ§åˆ¶å—ï¼ˆPCBï¼‰**ï¼šè¿›ç¨‹æ§åˆ¶å—æ˜¯æ“ä½œç³»ç»Ÿç®¡ç†è¿›ç¨‹çš„å…³é”®ï¼Œå®ƒè®°å½•è¿›ç¨‹çš„çŠ¶æ€ã€ç¨‹åºè®¡æ•°å™¨ã€å¯„å­˜å™¨å†…å®¹ç­‰ä¿¡æ¯ã€‚

### 3.2 è¿›ç¨‹æ ‡è¯†ç¬¦ä¸å±‚æ¬¡å…³ç³»

#### 3.2.1 è¿›ç¨‹æ ‡è¯†ç¬¦ï¼ˆPIDï¼‰

æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„è¿›ç¨‹IDï¼ˆPIDï¼‰ï¼Œæ“ä½œç³»ç»Ÿé€šè¿‡PIDæ¥åŒºåˆ†å’Œç®¡ç†è¿›ç¨‹ã€‚é€šè¿‡`os.getpid()`å’Œ`os.getppid()`å¯ä»¥è·å–å½“å‰è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹çš„PIDã€‚

```python
import os
import time

if __name__ == '__main__':
    print(f"å½“å‰è¿›ç¨‹PID: {os.getpid()}")
    print(f"çˆ¶è¿›ç¨‹PID: {os.getppid()}")

    for i in range(3):
        time.sleep(1)
        print(f"ç¬¬{i+1}ç§’ - è¿›ç¨‹{os.getpid()}æ­£åœ¨è¿è¡Œ")
```

#### 3.2.2 çˆ¶è¿›ç¨‹ä¸å­è¿›ç¨‹è¯¦è§£

**çˆ¶è¿›ç¨‹ï¼ˆParent Processï¼‰**ï¼š

- åˆ›å»ºå…¶ä»–è¿›ç¨‹ï¼ˆå­è¿›ç¨‹ï¼‰çš„è¿›ç¨‹
- è´Ÿè´£ç®¡ç†å’Œç›‘æ§å­è¿›ç¨‹çš„æ‰§è¡Œ
- é€šå¸¸éœ€è¦ç­‰å¾…å­è¿›ç¨‹å®Œæˆæˆ–å›æ”¶å­è¿›ç¨‹èµ„æº
- å¯ä»¥é€šè¿‡`os.getppid()`åœ¨å­è¿›ç¨‹ä¸­è·å–çˆ¶è¿›ç¨‹PID

**å­è¿›ç¨‹ï¼ˆChild Processï¼‰**ï¼š

- ç”±çˆ¶è¿›ç¨‹åˆ›å»ºçš„æ–°è¿›ç¨‹
- æ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„è¿›ç¨‹ç©ºé—´å’ŒPID
- åˆ›å»ºæ—¶ä¼šç»§æ‰¿çˆ¶è¿›ç¨‹çš„ä»£ç ï¼Œä½†æ•°æ®ç©ºé—´æ˜¯ç‹¬ç«‹çš„
- å¯ä»¥æ‰§è¡Œä¸çˆ¶è¿›ç¨‹ç›¸åŒæˆ–ä¸åŒçš„ä»»åŠ¡

### 3.3 è¿›ç¨‹çŠ¶æ€ä¸è°ƒåº¦

#### 3.3.1 è¿›ç¨‹çŠ¶æ€

è¿›ç¨‹çš„çŠ¶æ€æè¿°äº†å®ƒåœ¨ç”Ÿå‘½å‘¨æœŸä¸­çš„ä¸åŒé˜¶æ®µï¼š

```mermaid
stateDiagram-v2
    [*] --> æ–°å»º: åˆ›å»ºè¿›ç¨‹
    æ–°å»º --> å°±ç»ª: è·å¾—é™¤CPUå¤–çš„èµ„æº
    å°±ç»ª --> è¿è¡Œ: è·å¾—CPUæ—¶é—´ç‰‡
    è¿è¡Œ --> å°±ç»ª: æ—¶é—´ç‰‡ç”¨å®Œ
    è¿è¡Œ --> é˜»å¡: ç­‰å¾…I/Oæˆ–äº‹ä»¶
    é˜»å¡ --> å°±ç»ª: I/Oå®Œæˆæˆ–äº‹ä»¶å‘ç”Ÿ
    è¿è¡Œ --> [*]: è¿›ç¨‹ç»“æŸ

    å°±ç»ª: Ready State<br/>å·²è·å¾—æ‰§è¡Œæ‰€éœ€èµ„æº<br/>ç­‰å¾…CPUè°ƒåº¦
    è¿è¡Œ: Running State<br/>æ­£åœ¨CPUä¸Šæ‰§è¡Œ<br/>æ‹¥æœ‰CPUæ§åˆ¶æƒ
    é˜»å¡: Blocked State<br/>ç­‰å¾…æŸäº›äº‹ä»¶<br/>å¦‚I/Oæ“ä½œå®Œæˆ
```

ä¸»è¦æœ‰ä¸‰ç§åŸºæœ¬çŠ¶æ€ï¼š

- **å°±ç»ªçŠ¶æ€ï¼ˆReadyï¼‰**ï¼šè¿›ç¨‹å·²è·å¾—æ‰§è¡Œæ‰€éœ€çš„èµ„æºï¼Œä½†æ­£åœ¨ç­‰å¾…CPUèµ„æºã€‚
- **è¿è¡ŒçŠ¶æ€ï¼ˆRunningï¼‰**ï¼šè¿›ç¨‹è·å¾—CPUèµ„æºå¹¶æ­£åœ¨æ‰§è¡Œã€‚
- **é˜»å¡çŠ¶æ€ï¼ˆBlockedï¼‰**ï¼šè¿›ç¨‹å› ç­‰å¾…æŸäº›äº‹ä»¶ï¼ˆå¦‚I/Oæ“ä½œï¼‰è€Œæ— æ³•ç»§ç»­æ‰§è¡Œï¼Œè¿›å…¥é˜»å¡çŠ¶æ€ã€‚

#### 3.3.2 è¿›ç¨‹è°ƒåº¦ç®—æ³•

è¿›ç¨‹çš„è°ƒåº¦æ˜¯æ“ä½œç³»ç»Ÿçš„æ ¸å¿ƒä»»åŠ¡ï¼Œå®ƒå†³å®šäº†å¤šä¸ªè¿›ç¨‹å¦‚ä½•å…±äº«CPUèµ„æºï¼š

```mermaid
graph TD
    A[è¿›ç¨‹è°ƒåº¦ç®—æ³•] --> B[FCFS<br/>å…ˆæ¥å…ˆæœåŠ¡]
    A --> C[SJF<br/>çŸ­ä½œä¸šä¼˜å…ˆ]
    A --> D[RR<br/>æ—¶é—´ç‰‡è½®è½¬]
    A --> E[MFQ<br/>å¤šçº§åé¦ˆé˜Ÿåˆ—]

    B --> B1[æŒ‰åˆ°è¾¾é¡ºåºæ‰§è¡Œ<br/>ç®€å•ä½†å¯èƒ½ç­‰å¾…æ—¶é—´é•¿]
    C --> C1[æ‰§è¡Œæ—¶é—´çŸ­çš„ä¼˜å…ˆ<br/>å¯èƒ½å¯¼è‡´é•¿ä½œä¸šé¥¥é¥¿]
    D --> D1[æ¯ä¸ªè¿›ç¨‹åˆ†é…å›ºå®šæ—¶é—´ç‰‡<br/>å…¬å¹³ä½†æœ‰åˆ‡æ¢å¼€é”€]
    E --> E1[ç»“åˆå¤šç§ç®—æ³•ä¼˜ç‚¹<br/>å¤æ‚ä½†æ•ˆæœå¥½]
```

1. **FCFSï¼ˆå…ˆæ¥å…ˆæœåŠ¡ï¼‰**ï¼šæŒ‰ç…§è¿›ç¨‹åˆ°è¾¾çš„é¡ºåºæ‰§è¡Œï¼Œé€‚åˆé•¿æ—¶é—´è¿è¡Œçš„ä½œä¸šã€‚
2. **SJFï¼ˆçŸ­ä½œä¸šä¼˜å…ˆï¼‰**ï¼šä¼˜å…ˆè°ƒåº¦æ‰§è¡Œæ—¶é—´çŸ­çš„ä½œä¸šï¼Œå¯èƒ½å¯¼è‡´é•¿ä½œä¸šé¥¥é¥¿ã€‚
3. **RRï¼ˆæ—¶é—´ç‰‡è½®è½¬ï¼‰**ï¼šä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…å›ºå®šçš„æ—¶é—´ç‰‡ï¼Œé€‚åˆå¤šä»»åŠ¡å¹¶å‘å¤„ç†ã€‚
4. **MFQï¼ˆå¤šçº§åé¦ˆé˜Ÿåˆ—ï¼‰**ï¼šç»“åˆäº†å¤šç§è°ƒåº¦ç®—æ³•çš„ä¼˜ç‚¹ï¼Œé€‚åˆå¤„ç†ä¸åŒç±»å‹çš„ä»»åŠ¡ã€‚

## 4. ç‰¹æ®Šè¿›ç¨‹ç±»å‹è¯¦è§£

### 4.1 å­¤å„¿è¿›ç¨‹æ·±å…¥è§£æ

**å­¤å„¿è¿›ç¨‹ï¼ˆOrphan Processï¼‰**æ˜¯æŒ‡çˆ¶è¿›ç¨‹åœ¨å­è¿›ç¨‹ç»“æŸä¹‹å‰å°±ç»ˆæ­¢äº†ï¼Œä½¿å¾—å­è¿›ç¨‹å¤±å»çˆ¶è¿›ç¨‹çš„è¿›ç¨‹ã€‚

```mermaid
sequenceDiagram
    participant çˆ¶è¿›ç¨‹ as Parent Process
    participant å­è¿›ç¨‹ as Child Process
    participant initè¿›ç¨‹ as Init Process (PID=1)

    çˆ¶è¿›ç¨‹->>å­è¿›ç¨‹: åˆ›å»ºå­è¿›ç¨‹
    Note over å­è¿›ç¨‹: å­è¿›ç¨‹å¼€å§‹æ‰§è¡Œ
    çˆ¶è¿›ç¨‹->>çˆ¶è¿›ç¨‹: çˆ¶è¿›ç¨‹æ„å¤–ç»ˆæ­¢
    Note over å­è¿›ç¨‹: å­è¿›ç¨‹å˜æˆå­¤å„¿è¿›ç¨‹
    initè¿›ç¨‹->>å­è¿›ç¨‹: initè¿›ç¨‹æ”¶å…»å­¤å„¿è¿›ç¨‹
    Note over å­è¿›ç¨‹: å­è¿›ç¨‹ç»§ç»­æ‰§è¡Œ
    å­è¿›ç¨‹->>initè¿›ç¨‹: å­è¿›ç¨‹ç»“æŸï¼Œå‘initæŠ¥å‘Š
```

#### 4.1.1 å­¤å„¿è¿›ç¨‹çš„ç‰¹ç‚¹

- **äº§ç”ŸåŸå› **ï¼šçˆ¶è¿›ç¨‹åœ¨å­è¿›ç¨‹ç»“æŸå‰æ„å¤–ç»ˆæ­¢æˆ–è¢«å¼ºåˆ¶æ€æ­»
- **ç³»ç»Ÿå¤„ç†**ï¼šå­¤å„¿è¿›ç¨‹ä¼šè¢«pid=1çš„initè¿›ç¨‹ï¼ˆç³»ç»Ÿå®ˆæŠ¤è¿›ç¨‹ï¼‰æ”¶å…»
- **èµ„æºå›æ”¶**ï¼šinitè¿›ç¨‹ä¼šå¯¹æ‰€æœ‰çš„å­¤å„¿è¿›ç¨‹è¿›è¡Œèµ„æºå›æ”¶
- **å±å®³ç¨‹åº¦**ï¼šå­¤å„¿è¿›ç¨‹ä¸ä¼šå¯¹ç³»ç»Ÿé€ æˆå±å®³ï¼Œå› ä¸ºæœ‰initè¿›ç¨‹è´Ÿè´£æ¸…ç†

#### 4.1.2 å­¤å„¿è¿›ç¨‹ç¤ºä¾‹

* æ³¨æ„åœ¨ **ç°ä»£ Linux æ¡Œé¢ç¯å¢ƒ**ï¼ˆUbuntu + systemd ç”¨æˆ·ä¼šè¯ï¼‰ä¸‹ï¼Œå­¤å„¿è¿›ç¨‹ **ä¸ä¼šç›´æ¥è¢« PID=1 çš„ init æ”¶å…»**ã€‚
* è¢«æ”¶å…»çš„å¥½å¤„å°±æ˜¯è‡ªåŠ¨çš„å›æ”¶å­è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€ï¼

```python
import os
import time
from multiprocessing import Process

def child_task():
    print(f"å­è¿›ç¨‹å¯åŠ¨ï¼ŒPID={os.getpid()}ï¼Œçˆ¶PID={os.getppid()}")
    for i in range(30):
        time.sleep(1)
        print(f"{i+1}ç§’ - å­è¿›ç¨‹PID={os.getpid()}ï¼Œçˆ¶PID={os.getppid()}")
        if os.getppid() == 1:
            print("ğŸ‘‰ å·²è¢« init æ”¶å…»ï¼Œæˆä¸ºå­¤å„¿")

if __name__ == "__main__":
    print(f"ä¸»è¿›ç¨‹PID={os.getpid()}")
    p = Process(target=child_task)
    p.start()

    time.sleep(3)
    print("ä¸»è¿›ç¨‹å¼ºåˆ¶é€€å‡º")
    os._exit(0)  # âš ï¸ ä¸»è¿›ç¨‹ç«‹å³æ¶ˆäº¡

```

**æµ‹è¯•æ–¹æ³•**ï¼š

```bash
# è¿è¡Œä¸Šè¿°ä»£ç åï¼Œåœ¨å¦ä¸€ä¸ªç»ˆç«¯ä¸­è§‚å¯Ÿè¿›ç¨‹
ps aux | grep python
```

### 4.2 åƒµå°¸è¿›ç¨‹æˆå› ä¸é¿å…

* çˆ¶è¿›ç¨‹æ­»æ‰æ—¶ï¼Œåƒµå°¸è¿›ç¨‹ä¼šè¢« init å›æ”¶

* ç®€å•ç†è§£å°±æ˜¯çˆ¹è¿˜åœ¨ä½†æ˜¯ä¸ç®¡ä»–å°±å˜åƒµå°¸äº†ï¼ ï¼ˆçˆ¹è¿˜åœ¨æ‰€ä»¥initæ— æ³•æ’æ‰‹å›æ”¶ï¼ï¼‰

**åƒµå°¸è¿›ç¨‹ï¼ˆZombie Processï¼‰**æ˜¯æŒ‡å­è¿›ç¨‹å·²ç»ç»“æŸï¼Œä½†çˆ¶è¿›ç¨‹è¿˜æ²¡æœ‰è°ƒç”¨`wait()`æˆ–ç±»ä¼¼ç³»ç»Ÿè°ƒç”¨æ¥æ”¶é›†å­è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€ä¿¡æ¯ã€‚

```mermaid
sequenceDiagram
    participant çˆ¶è¿›ç¨‹ as Parent Process
    participant å­è¿›ç¨‹ as Child Process
    participant æ“ä½œç³»ç»Ÿ as OS

    çˆ¶è¿›ç¨‹->>å­è¿›ç¨‹: åˆ›å»ºå­è¿›ç¨‹
    å­è¿›ç¨‹->>å­è¿›ç¨‹: æ‰§è¡Œä»»åŠ¡
    å­è¿›ç¨‹->>æ“ä½œç³»ç»Ÿ: ä»»åŠ¡å®Œæˆï¼Œè°ƒç”¨exit()
    Note over å­è¿›ç¨‹: å­è¿›ç¨‹å˜æˆåƒµå°¸çŠ¶æ€<br/>ç­‰å¾…çˆ¶è¿›ç¨‹æ”¶é›†é€€å‡ºä¿¡æ¯
    æ“ä½œç³»ç»Ÿ->>çˆ¶è¿›ç¨‹: å‘é€SIGCHLDä¿¡å·
    Note over çˆ¶è¿›ç¨‹: çˆ¶è¿›ç¨‹å¿™äºå…¶ä»–äº‹åŠ¡<br/>æœªåŠæ—¶å¤„ç†å­è¿›ç¨‹
    Note over å­è¿›ç¨‹: è¿›ç¨‹çŠ¶æ€æ˜¾ç¤ºä¸º Z (Zombie)<br/>å ç”¨è¿›ç¨‹è¡¨é¡¹ä½†æ— å®é™…èµ„æº
```

#### 4.2.1 åƒµå°¸è¿›ç¨‹çš„å±å®³

- **èµ„æºå ç”¨**ï¼šè™½ç„¶ä¸å ç”¨å®é™…çš„å†…å­˜å’ŒCPUï¼Œä½†ä¼šå ç”¨è¿›ç¨‹è¡¨é¡¹
- **ç³»ç»Ÿé™åˆ¶**ï¼šå¤§é‡åƒµå°¸è¿›ç¨‹ä¼šè€—å°½è¿›ç¨‹è¡¨ï¼Œå½±å“ç³»ç»Ÿåˆ›å»ºæ–°è¿›ç¨‹
- **çŠ¶æ€æ ‡è¯†**ï¼šåœ¨`ps`å‘½ä»¤ä¸­æ˜¾ç¤ºçŠ¶æ€ä¸º"Z"

#### 4.2.2 äº§ç”Ÿåƒµå°¸è¿›ç¨‹çš„ç¤ºä¾‹

```python
import time
import multiprocessing
import os

def zombie_child():
    """ä¼šå˜æˆåƒµå°¸è¿›ç¨‹çš„å­è¿›ç¨‹"""
    print(f"å­è¿›ç¨‹å¼€å§‹æ‰§è¡Œï¼ŒPID: {os.getpid()}")
    print("å­è¿›ç¨‹å³å°†ç»“æŸ...")
    time.sleep(2)
    print("å­è¿›ç¨‹ç»“æŸ")
    # å­è¿›ç¨‹ç»“æŸåï¼Œå¦‚æœçˆ¶è¿›ç¨‹ä¸è°ƒç”¨join()ï¼Œå°±ä¼šå˜æˆåƒµå°¸è¿›ç¨‹

if __name__ == '__main__':
    print(f"ä¸»è¿›ç¨‹PID: {os.getpid()}")

    # åˆ›å»ºå¤šä¸ªå­è¿›ç¨‹ä½†ä¸ç­‰å¾…å®ƒä»¬ç»“æŸ
    for i in range(3):
        process = multiprocessing.Process(target=zombie_child)
        process.start()
        # æ³¨æ„ï¼šè¿™é‡Œæ²¡æœ‰è°ƒç”¨ process.join()
        print(f"å­è¿›ç¨‹ {i+1} å·²å¯åŠ¨ï¼ŒPIDå¯èƒ½æ˜¯: {process.pid}")

    print("ä¸»è¿›ç¨‹ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡...")
    time.sleep(30)  # ä¸»è¿›ç¨‹ç»§ç»­è¿è¡Œ30ç§’ï¼Œå­è¿›ç¨‹å˜æˆåƒµå°¸

    print("ä¸»è¿›ç¨‹å³å°†ç»“æŸ")
```

**æ£€æŸ¥åƒµå°¸è¿›ç¨‹**ï¼š

```bash
# åœ¨å¦ä¸€ä¸ªç»ˆç«¯æ‰§è¡Œ
ps -ef | grep python
# ä¼šçœ‹åˆ°çŠ¶æ€ä¸º Z+ æˆ– <defunct> çš„è¿›ç¨‹
```

#### 4.2.3 é¿å…åƒµå°¸è¿›ç¨‹çš„æ–¹æ³•

* ä½¿ç”¨join()ç­‰å¾…å­è¿›ç¨‹ç»“æŸï¼ 

**æ›´ä¼˜é›…çš„å¤„ç†æ–¹å¼**ï¼š

* ä½¿ç”¨èµ„æºç®¡ç†å™¨ï¼Œé€€å‡ºçš„æ—¶å€™è‡ªåŠ¨çš„ç»ˆæ­¢æ‰€æœ‰å­è¿›ç¨‹

```python
import multiprocessing
import os
import time
from contextlib import contextmanager

@contextmanager
def managed_processes():
    """è¿›ç¨‹ç®¡ç†å™¨ï¼Œç¡®ä¿æ‰€æœ‰è¿›ç¨‹è¢«æ­£ç¡®æ¸…ç†"""
    processes = []
    try:
        yield processes
    finally:
        # ç­‰å¾…æ‰€æœ‰è¿›ç¨‹ç»“æŸ
        for process in processes:
            if process.is_alive():
                process.join(timeout=5)  # æœ€å¤šç­‰å¾…5ç§’
                if process.is_alive():
                    process.terminate()  # å¼ºåˆ¶ç»ˆæ­¢
                    process.join()
        print("æ‰€æœ‰è¿›ç¨‹å·²æ¸…ç†å®Œæ¯•")

def worker_task(name, duration):
    print(f"å·¥ä½œè¿›ç¨‹ {name} å¼€å§‹ï¼ŒPID: {os.getpid()}")
    time.sleep(duration)
    print(f"å·¥ä½œè¿›ç¨‹ {name} å®Œæˆ")

if __name__ == '__main__':
    with managed_processes() as processes:
        # åˆ›å»ºå¤šä¸ªè¿›ç¨‹
        for i in range(3):
            p = multiprocessing.Process(
                target=worker_task,
                args=(f"Task-{i+1}", 2)
            )
            p.start()
            processes.append(p)

        print("æ‰€æœ‰è¿›ç¨‹å·²å¯åŠ¨ï¼Œç­‰å¾…å®Œæˆ...")

    print("ç¨‹åºç»“æŸï¼Œæ— åƒµå°¸è¿›ç¨‹")
```

### 4.3 å®ˆæŠ¤è¿›ç¨‹ï¼ˆæ³¨æ„å’Œç³»ç»Ÿçš„å®ˆæŠ¤è¿›ç¨‹ä¸åŒï¼‰

**å®ˆæŠ¤è¿›ç¨‹ï¼ˆDaemon Processï¼‰**ä¹Ÿå«ç²¾çµè¿›ç¨‹ï¼Œæ˜¯ä¸€ç§ç‰¹æ®Šçš„è¿›ç¨‹ï¼Œä¸€èˆ¬åœ¨åå°è¿è¡Œï¼Œä¸ä¸ä»»ä½•æ§åˆ¶ç»ˆç«¯ç›¸å…³è”ï¼Œå¹¶ä¸”å‘¨æœŸæ€§åœ°æ‰§è¡ŒæŸç§ä»»åŠ¡æˆ–ç­‰å¾…å¤„ç†æŸäº›å‘ç”Ÿçš„äº‹ä»¶ã€‚

#### 4.3.1 å®ˆæŠ¤è¿›ç¨‹çš„ç‰¹ç‚¹

1. **ç”Ÿå­˜å‘¨æœŸ**ï¼šä¸€èˆ¬å¯åŠ¨äº†ä»¥åå°±ä¼šä¸€ç›´é©»ç•™åœ¨æ“ä½œç³»ç»Ÿä¸­ï¼Œç›´åˆ°**ä¸»è¿›ç¨‹ç»“æŸ**ã€‚
2. **è‡ªåŠ¨ç»“æŸ**ï¼šä¸»è¿›ç¨‹åˆ›å»ºäº†å®ˆæŠ¤è¿›ç¨‹ä»¥åï¼Œå®ˆæŠ¤è¿›ç¨‹ä½œä¸ºä¸€ä¸ªç‰¹æ®Šçš„å­è¿›ç¨‹ä¼šéšç€ä¸»è¿›ç¨‹çš„ä»£ç ç»“æŸè€Œè‡ªåŠ¨ç»“æŸã€‚
3. **è¿›ç¨‹é™åˆ¶**ï¼šå®ˆæŠ¤è¿›ç¨‹å†…ä¸å…è®¸å†å¼€å­è¿›ç¨‹ï¼ˆå­™å­è¿›ç¨‹ï¼‰ã€‚
4. **ç»ˆç«¯ç‹¬ç«‹**ï¼šå®ˆæŠ¤è¿›ç¨‹æ˜¯åœ¨åå°è¿è¡Œï¼Œå’Œç»ˆç«¯æ— å…³è”ï¼Œä¸ä¼šå ç€ç»ˆç«¯ï¼Œç»ˆç«¯å¯ä»¥æ‰§è¡Œå…¶ä»–å‘½ä»¤æˆ–æ“ä½œã€‚

#### 4.3.2 å®ˆæŠ¤è¿›ç¨‹ç¤ºä¾‹

```python
import time
import os
from multiprocessing import Process

def daemon_task():
    """å®ˆæŠ¤è¿›ç¨‹ä»»åŠ¡"""
    print(f"å®ˆæŠ¤è¿›ç¨‹å¯åŠ¨ï¼ŒPID: {os.getpid()}")
    count = 0
    while True:
        count += 1
        print(f"å®ˆæŠ¤è¿›ç¨‹è¿è¡Œä¸­... è®¡æ•°: {count}")
        time.sleep(2)

        # é¿å…æ— é™è¿è¡Œï¼Œå®é™…å®ˆæŠ¤è¿›ç¨‹é€šå¸¸æ˜¯æ— é™å¾ªç¯
        if count >= 10:
            print("å®ˆæŠ¤è¿›ç¨‹è¾¾åˆ°æœ€å¤§è®¡æ•°ï¼Œå‡†å¤‡ç»“æŸ")
            break

if __name__ == '__main__':
    print(f"ä¸»è¿›ç¨‹PID: {os.getpid()}")

    # åˆ›å»ºå®ˆæŠ¤è¿›ç¨‹
    daemon_process = Process(target=daemon_task)
    daemon_process.daemon = True  # è®¾ç½®ä¸ºå®ˆæŠ¤è¿›ç¨‹ï¼Œå¿…é¡»åœ¨start()ä¹‹å‰è®¾ç½®
    daemon_process.start()

    print("ä¸»è¿›ç¨‹ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡...")

    # ä¸»è¿›ç¨‹æ‰§è¡Œä¸€äº›ä»»åŠ¡
    for i in range(5):
        time.sleep(1)
        print(f"ä¸»è¿›ç¨‹å·¥ä½œä¸­... {i+1}/5")

    print("ä¸»è¿›ç¨‹å³å°†ç»“æŸ")
    time.sleep(1)
    print("ä¸»è¿›ç¨‹ç»“æŸ - å®ˆæŠ¤è¿›ç¨‹ä¹Ÿä¼šè‡ªåŠ¨ç»“æŸ")

    # æ³¨æ„ï¼šä¸éœ€è¦è°ƒç”¨ daemon_process.join()
    # å› ä¸ºå®ˆæŠ¤è¿›ç¨‹ä¼šéšä¸»è¿›ç¨‹ç»“æŸè€Œè‡ªåŠ¨ç»“æŸ
```

#### 4.3.3 å®ˆæŠ¤è¿›ç¨‹ vs æ™®é€šå­è¿›ç¨‹

| ç‰¹æ€§                  | æ™®é€šå­è¿›ç¨‹                                       | å®ˆæŠ¤è¿›ç¨‹ (`daemon=True`)                                     |
| --------------------- | ------------------------------------------------ | ------------------------------------------------------------ |
| **ç”Ÿå‘½å‘¨æœŸ**          | ç‹¬ç«‹è¿è¡Œï¼Œä¸»è¿›ç¨‹ç»“æŸåä»å¯ç»§ç»­æ‰§è¡Œï¼Œç›´åˆ°ä»»åŠ¡å®Œæˆ | éšä¸»è¿›ç¨‹ç»“æŸè€Œå¼ºåˆ¶ç»ˆæ­¢                                       |
| **ç”¨é€”**              | æ‰§è¡Œä¸»è¦ä»»åŠ¡æˆ–éœ€è¦ä¿è¯å®Œæˆçš„å·¥ä½œ                 | æ‰§è¡Œè¾…åŠ©æ€§æˆ–åå°ä»»åŠ¡ï¼Œä¸ä¿è¯å®Œæˆ                             |
| **ä¸»è¿›ç¨‹ç­‰å¾…**        | é»˜è®¤æƒ…å†µä¸‹ï¼Œ`join()` å¯ç­‰å¾…å…¶å®Œæˆ                | ä¸»è¿›ç¨‹é€€å‡ºæ—¶è‡ªåŠ¨ç»“æŸï¼Œ`join()` å¯ç­‰å¾…ï¼Œä½†ä¸»è¿›ç¨‹ç»“æŸå‰å¯èƒ½è¢«ç»ˆæ­¢ |
| **ä¸ç»ˆç«¯/è¾“å‡ºçš„å…³ç³»** | å¯ç»§æ‰¿ä¸»è¿›ç¨‹ç»ˆç«¯ï¼Œè¾“å‡ºå¯è§                       | ä¸ä¾èµ–ç»ˆç«¯ï¼Œé€šå¸¸ç”¨äºåå°è¾…åŠ©ä»»åŠ¡                             |
| **åˆ›å»ºæ–¹å¼**          | `Process(target=func)`                           | `p = Process(target=func); p.daemon = True`                  |
| **å…¸å‹åº”ç”¨**          | æ•°æ®å¤„ç†ã€è®¡ç®—ä»»åŠ¡ã€æ–‡ä»¶æ“ä½œ                     | æ—¥å¿—è®°å½•ã€çŠ¶æ€ç›‘æ§ã€å®šæ—¶æ¸…ç†ã€åå°è½®è¯¢                       |

## 5. è¿›ç¨‹åˆ›å»ºä¸ç®¡ç†

### 5.1 os.fork() çš„å·¥ä½œåŸç†

`os.fork()` æ˜¯åŸºäº Linux/Unix ç³»ç»Ÿçš„ç³»ç»Ÿè°ƒç”¨ï¼Œå®ƒç”¨äºåˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ã€‚Windows ç³»ç»Ÿä¸æ”¯æŒ `fork()`ï¼Œå› æ­¤åœ¨ Windows ä¸‹æ‰§è¡Œæ—¶ä¼šæŠ¥é”™ã€‚

#### 5.1.1 fork() å·¥ä½œæœºåˆ¶

* çˆ¶è¿›ç¨‹è¿”å›çš„æ˜¯å­è¿›ç¨‹çš„pid
* å­è¿›ç¨‹è¿”å›çš„æ˜¯çˆ¶è¿›ç¨‹çš„pidï¼Œå›ºå®šä¸º0

```mermaid
sequenceDiagram
    participant ä¸»è¿›ç¨‹ as Main Process
    participant OS as Operating System
    participant å­è¿›ç¨‹ as Child Process

    ä¸»è¿›ç¨‹->>OS: è°ƒç”¨ os.fork()
    OS->>OS: å¤åˆ¶è¿›ç¨‹å†…å­˜ç©ºé—´
    OS->>å­è¿›ç¨‹: åˆ›å»ºæ–°è¿›ç¨‹
    OS->>ä¸»è¿›ç¨‹: è¿”å›å­è¿›ç¨‹PID
    OS->>å­è¿›ç¨‹: è¿”å›0

    Note over ä¸»è¿›ç¨‹: pid != 0 (å­è¿›ç¨‹PID)
    Note over å­è¿›ç¨‹: pid == 0

    ä¸»è¿›ç¨‹->>ä¸»è¿›ç¨‹: æ‰§è¡Œçˆ¶è¿›ç¨‹ä»£ç åˆ†æ”¯
    å­è¿›ç¨‹->>å­è¿›ç¨‹: æ‰§è¡Œå­è¿›ç¨‹ä»£ç åˆ†æ”¯
```

#### 5.1.2 åŸºç¡€ç¤ºä¾‹

* åˆ›å»ºå­è¿›ç¨‹
* åˆ›å»ºå­è¿›ç¨‹çš„æ—¶å€™ï¼Œå­è¿›ç¨‹ä¸­è¿”å›çš„0ï¼Œçˆ¶è¿›ç¨‹è¿”å›çš„æ˜¯å­è¿›ç¨‹çš„PIDï¼ˆå› ä¸ºä¸€ä¸ªçˆ¶è¿›ç¨‹å¯èƒ½ä¼šæœ‰å¤šä¸ªå­è¿›ç¨‹ï¼‰

```python
import os

if __name__ == '__main__':
    w = 100
    print(f"forkå‰: PID={os.getpid()}, w={w}")

    pid = os.fork()  # åˆ›å»ºå­è¿›ç¨‹

    if pid == 0:
        # å­è¿›ç¨‹æ‰§è¡Œçš„ä»£ç 
        w = 200  # å­è¿›ç¨‹ä¿®æ”¹å˜é‡ï¼ˆä¸å½±å“çˆ¶è¿›ç¨‹ï¼‰
        print(f"å­è¿›ç¨‹: PID={os.getpid()}, PPID={os.getppid()}, w={w}")
        print("å­è¿›ç¨‹å·¥ä½œå®Œæˆ")
    else:
        # çˆ¶è¿›ç¨‹æ‰§è¡Œçš„ä»£ç 
        print(f"çˆ¶è¿›ç¨‹: PID={os.getpid()}, åˆ›å»ºäº†å­è¿›ç¨‹PID={pid}")
        print(f"çˆ¶è¿›ç¨‹: w={w}")  # çˆ¶è¿›ç¨‹çš„wä»ç„¶æ˜¯100

        # ç­‰å¾…å­è¿›ç¨‹ç»“æŸ
        os.waitpid(pid, 0)  # 0ä»£è¡¨é˜»å¡ç­‰å¾…å­è¿›ç¨‹ç»“æŸ
        print("çˆ¶è¿›ç¨‹ï¼šå­è¿›ç¨‹å·²ç»“æŸ")
```

#### 5.1.3 fork() çš„ä¼˜ç¼ºç‚¹

**ä¼˜ç‚¹**ï¼š

- åˆ›å»ºé€Ÿåº¦å¿«ï¼ˆå†™æ—¶å¤åˆ¶æœºåˆ¶ï¼‰
- å®Œå…¨çš„å†…å­˜éš”ç¦»ï¼Œå®‰å…¨æ€§é«˜
- ç¬¦åˆUnixå“²å­¦çš„ç®€æ´è®¾è®¡

**ç¼ºç‚¹**ï¼š

- ä»…æ”¯æŒUnix/Linuxç³»ç»Ÿ
- å†…å­˜ä½¿ç”¨é‡è¾ƒå¤§ï¼ˆè™½ç„¶æœ‰å†™æ—¶å¤åˆ¶ä¼˜åŒ–ï¼‰
- ä¸é€‚åˆéœ€è¦å…±äº«å¤§é‡æ•°æ®çš„åœºæ™¯
- fork åå¦‚æœä¸ `wait()` / `waitpid()` å›æ”¶å­è¿›ç¨‹ â†’ å­è¿›ç¨‹å˜**åƒµå°¸è¿›ç¨‹**

### 5.2 multiprocessing å®ç°å¤šè¿›ç¨‹

`multiprocessing` æ¨¡å—æ˜¯ Python æä¾›çš„å¤šè¿›ç¨‹åº“ï¼Œå®ƒæä¾›äº†æ¯” `os.fork()` æ›´ä¸°å¯Œçš„åŠŸèƒ½ï¼Œå¹¶ä¸”èƒ½åœ¨ Windows å’Œ Linux ä¸‹è·¨å¹³å°ä½¿ç”¨ã€‚

#### 5.2.1 åŸºç¡€ç”¨æ³•

* åˆ›å»ºå¹¶ç­‰å¾…å­è¿›ç¨‹æ‰§è¡Œç»“æŸ

```python
import os
import time
import multiprocessing

def worker_task(name, duration):
    """å·¥ä½œè¿›ç¨‹ä»»åŠ¡"""
    print(f"è¿›ç¨‹ {name} å¼€å§‹å·¥ä½œï¼ŒPID: {os.getpid()}")

    for i in range(duration):
        time.sleep(1)
        print(f"è¿›ç¨‹ {name} å·¥ä½œä¸­... {i+1}/{duration}")

    print(f"è¿›ç¨‹ {name} å·¥ä½œå®Œæˆ")
    return f"è¿›ç¨‹ {name} çš„ç»“æœ"

if __name__ == '__main__':
    print(f"ä¸»è¿›ç¨‹PID: {os.getpid()}")

    # åˆ›å»ºè¿›ç¨‹
    process = multiprocessing.Process(
        target=worker_task,
        args=("Worker-1", 3)
    )

    print("å¯åŠ¨å­è¿›ç¨‹...")
    process.start()

    print("ä¸»è¿›ç¨‹ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡")
    time.sleep(1)

    print("ç­‰å¾…å­è¿›ç¨‹ç»“æŸ...")
    process.join()

    print("æ‰€æœ‰ä»»åŠ¡å®Œæˆ")
```

#### 5.2.2 Processç±»çš„æ–¹æ³•å’Œå±æ€§

**å¸¸ç”¨æ–¹æ³•**ï¼š

| æ–¹æ³•å | æè¿° |
| :--- | :--- |
| p.start() | åœ¨ä¸»è¿›ç¨‹ä¸­å¯åŠ¨å­è¿›ç¨‹pï¼Œå¹¶è°ƒç”¨è¯¥å­è¿›ç¨‹pä¸­çš„run()æ–¹æ³• |
| p.run() | å­è¿›ç¨‹på¯åŠ¨æ—¶è¿è¡Œçš„æ–¹æ³•ï¼Œå»è°ƒç”¨startæ–¹æ³•çš„å‚æ•°targetæŒ‡å®šçš„å‡½æ•°/æ–¹æ³• |
| p.join([timeout]) | ä¸»è¿›ç¨‹ç­‰å¾…å­è¿›ç¨‹ç»“æŸï¼Œå¯æŒ‡å®šè¶…æ—¶æ—¶é—´ |
| p.terminate() | å¼ºåˆ¶ç»ˆæ­¢å­è¿›ç¨‹pï¼ˆéœ€è¦è°¨æ…ä½¿ç”¨ï¼‰ |
| p.is_alive() | æ£€æµ‹è¿›ç¨‹æ˜¯å¦è¿˜å­˜æ´» |
| p.kill() | å¼ºåˆ¶æ€æ­»è¿›ç¨‹ï¼ˆPython 3.7+ï¼‰ |

**å¸¸ç”¨å±æ€§**ï¼š

| å±æ€§å | æè¿° |
| :--- | :--- |
| p.name | è¿›ç¨‹çš„åç§° |
| p.pid | è¿›ç¨‹çš„å”¯ä¸€æ ‡è¯†ç¬¦ |
| p.daemon | æ˜¯å¦ä¸ºå®ˆæŠ¤è¿›ç¨‹ï¼ˆå¿…é¡»åœ¨start()å‰è®¾ç½®ï¼‰ |
| p.exitcode | è¿›ç¨‹çš„é€€å‡ºç  |

#### 5.2.3 ä¼ é€’å‚æ•°ï¼ˆåŒºåˆ«äºipcï¼Œåªæ˜¯åœ¨è¿è¡Œçš„æ—¶å€™ä¼ é€’å‚æ•°ï¼‰

1. **args å¿…é¡»é¡ºåºæ­£ç¡®**ï¼šä½ç½®å‚æ•°æ˜¯é é¡ºåºåŒ¹é…çš„ã€‚
   - å¦‚æœ `args=("å¼ ä¸‰",)` åªç»™äº†ä¸€ä¸ªå‚æ•°ï¼Œå°±ä¼šæŠ¥é”™ç¼ºå°‘ `age`ã€‚
2. **kwargs å¿…é¡»åå­—æ­£ç¡®**ï¼šå…³é”®å­—å‚æ•°è¦å’Œå‡½æ•°ç­¾åé‡Œçš„å‚æ•°åä¸€è‡´ã€‚
   - å¦‚æœå†™é”™ `{"nam": "æå››"}` ä¼šæŠ¥é”™ `unexpected keyword argument 'nam'`ã€‚
3. **æ··åˆæ—¶ï¼Œargs å…ˆåŒ¹é…å‰é¢çš„ä½ç½®å‚æ•°ï¼Œkwargs è´Ÿè´£è¡¥å……/è¦†ç›–**ã€‚

```python
import multiprocessing

def task_with_args(name, age, city="Unknown", **kwargs):
    """æ¥æ”¶ä¸åŒç±»å‹å‚æ•°çš„ä»»åŠ¡"""
    print(f"å§“å: {name}, å¹´é¾„: {age}, åŸå¸‚: {city}")
    print(f"å…¶ä»–ä¿¡æ¯: {kwargs}")

def demonstrate_arguments():
    """æ¼”ç¤ºä¸åŒçš„å‚æ•°ä¼ é€’æ–¹å¼"""
    processes = []

    # æ–¹å¼1: ä½¿ç”¨argsä¼ é€’ä½ç½®å‚æ•°
    p1 = multiprocessing.Process(
        target=task_with_args,
        args=("å¼ ä¸‰", 25)
    )

    # æ–¹å¼2: ä½¿ç”¨kwargsä¼ é€’å…³é”®å­—å‚æ•°
    p2 = multiprocessing.Process(
        target=task_with_args,
        kwargs={"name": "æå››", "age": 30, "city": "åŒ—äº¬"}
    )

    # æ–¹å¼3: æ··åˆä½¿ç”¨
    p3 = multiprocessing.Process(
        target=task_with_args,
        args=("ç‹äº”", 28),
        kwargs={"city": "ä¸Šæµ·", "job": "ç¨‹åºå‘˜", "hobby": "ç¼–ç¨‹"}
    )

    processes = [p1, p2, p3]

    # å¯åŠ¨å¹¶ç­‰å¾…æ‰€æœ‰è¿›ç¨‹
    for p in processes:
        p.start()

    for p in processes:
        p.join()

if __name__ == '__main__':
    demonstrate_arguments()
```

### 5.3 è‡ªå®šä¹‰Processç±»

#### 5.3.1 ç»§æ‰¿Processç±»

* é‡å†™runï¼Œè‡ªå®šä¹‰è¿è¡Œé€»è¾‘ï¼

```python
import os
import time
from multiprocessing import Process, current_process

class CustomWorker(Process):
    """è‡ªå®šä¹‰å·¥ä½œè¿›ç¨‹ç±»"""

    def __init__(self, task_name, work_duration, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.task_name = task_name
        self.work_duration = work_duration
        self.result = None

    def run(self):
        """é‡å†™runæ–¹æ³•ï¼Œå®šä¹‰è¿›ç¨‹è¦æ‰§è¡Œçš„ä»»åŠ¡"""
        current = current_process()
        print(f"è‡ªå®šä¹‰è¿›ç¨‹ {current.name} å¼€å§‹æ‰§è¡Œä»»åŠ¡: {self.task_name}")
        print(f"è¿›ç¨‹PID: {os.getpid()}")

        # æ‰§è¡Œå…·ä½“ä»»åŠ¡
        for i in range(self.work_duration):
            time.sleep(1)
            print(f"{current.name} - {self.task_name} è¿›åº¦: {i+1}/{self.work_duration}")

        self.result = f"{self.task_name} å®Œæˆ"
        print(f"è‡ªå®šä¹‰è¿›ç¨‹ {current.name} ä»»åŠ¡å®Œæˆ")

class DataProcessor(Process):
    """æ•°æ®å¤„ç†è¿›ç¨‹ç±»"""

    def __init__(self, data_list, process_func, name=None):
        super().__init__(name=name)
        self.data_list = data_list
        self.process_func = process_func
        self.processed_data = []

    def run(self):
        """å¤„ç†æ•°æ®"""
        print(f"æ•°æ®å¤„ç†è¿›ç¨‹ {self.name} å¼€å§‹å¤„ç† {len(self.data_list)} ä¸ªæ•°æ®é¡¹")

        for i, data in enumerate(self.data_list):
            processed = self.process_func(data)
            self.processed_data.append(processed)
            print(f"{self.name}: å¤„ç† {i+1}/{len(self.data_list)} - {data} -> {processed}")
            time.sleep(0.5)

        print(f"æ•°æ®å¤„ç†è¿›ç¨‹ {self.name} å®Œæˆ")

def square(x):
    """å¹³æ–¹å‡½æ•°"""
    return x * x

def demonstrate_custom_process():
    """æ¼”ç¤ºè‡ªå®šä¹‰è¿›ç¨‹ç±»"""
    print(f"ä¸»è¿›ç¨‹PID: {os.getpid()}")

    # åˆ›å»ºè‡ªå®šä¹‰å·¥ä½œè¿›ç¨‹
    workers = [
        CustomWorker("æ•°æ®æ¸…æ´—", 3, name="Cleaner"),
        CustomWorker("æ•°æ®åˆ†æ", 4, name="Analyzer"),
        CustomWorker("æŠ¥å‘Šç”Ÿæˆ", 2, name="Reporter")
    ]

    # åˆ›å»ºæ•°æ®å¤„ç†è¿›ç¨‹
    data_processor = DataProcessor(
        data_list=[1, 2, 3, 4, 5],
        process_func=square,
        name="DataProcessor"
    )

    all_processes = workers + [data_processor]

    # å¯åŠ¨æ‰€æœ‰è¿›ç¨‹
    for p in all_processes:
        p.start()
        print(f"å¯åŠ¨è¿›ç¨‹: {p.name}")

    # ç­‰å¾…æ‰€æœ‰è¿›ç¨‹å®Œæˆ
    for p in all_processes:
        p.join()
        print(f"è¿›ç¨‹ {p.name} å·²ç»“æŸ")

    print("æ‰€æœ‰è‡ªå®šä¹‰è¿›ç¨‹å·²å®Œæˆ")

if __name__ == '__main__':
    demonstrate_custom_process()
```

### 5.4 Windows ç³»ç»Ÿç‰¹æ®Šå¤„ç†

åœ¨ Windows ä¸‹ï¼ŒPython ä½¿ç”¨ `multiprocessing` æ¨¡å—æ—¶ä¼šé€šè¿‡å¯¼å…¥çˆ¶è¿›ç¨‹çš„ä»£ç æ¥åˆ›å»ºå­è¿›ç¨‹ï¼Œå› æ­¤éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

#### 5.4.1 Windowsä¸‹çš„è¿›ç¨‹åˆ›å»ºæœºåˆ¶

```mermaid
sequenceDiagram
    participant Main as ä¸»ç¨‹åº
    participant OS as Windows OS
    participant Child as å­è¿›ç¨‹
    participant Interpreter as Pythonè§£é‡Šå™¨

    Main->>OS: è°ƒç”¨ Process.start()
    OS->>Interpreter: å¯åŠ¨æ–°çš„Pythonè§£é‡Šå™¨
    Interpreter->>Main: é‡æ–°å¯¼å…¥ä¸»æ¨¡å—
    Note over Main: æ‰§è¡Œæ‰€æœ‰æ¨¡å—çº§ä»£ç 
    Interpreter->>Child: æ‰¾åˆ°targetå‡½æ•°å¹¶æ‰§è¡Œ
    Child->>Child: æ‰§è¡Œä»»åŠ¡
    Child->>OS: ä»»åŠ¡å®Œæˆï¼Œè¿›ç¨‹ç»“æŸ
```

#### 5.4.2 å¿…é¡»ä½¿ç”¨ `if __name__ == '__main__':`

**é”™è¯¯ç¤ºä¾‹ï¼ˆä¼šå¯¼è‡´æ— é™é€’å½’ï¼‰**ï¼š
```python
# é”™è¯¯ï¼šæ²¡æœ‰ä½¿ç”¨ if __name__ == '__main__'
import multiprocessing

def worker():
    print("å·¥ä½œè¿›ç¨‹æ‰§è¡Œ")

# å±é™©ï¼šåœ¨Windowsä¸‹ä¼šæ— é™åˆ›å»ºè¿›ç¨‹
process = multiprocessing.Process(target=worker)
process.start()
process.join()
```

**æ­£ç¡®ç¤ºä¾‹**ï¼š
```python
import multiprocessing
import os

def worker(name):
    print(f"å·¥ä½œè¿›ç¨‹ {name} æ‰§è¡Œï¼ŒPID: {os.getpid()}")

def safe_windows_example():
    """Windowså®‰å…¨çš„å¤šè¿›ç¨‹ç¤ºä¾‹"""
    print(f"ä¸»è¿›ç¨‹PID: {os.getpid()}")

    processes = []

    for i in range(3):
        p = multiprocessing.Process(
            target=worker,
            args=(f"Worker-{i+1}",)
        )
        processes.append(p)
        p.start()

    for p in processes:
        p.join()

    print("æ‰€æœ‰è¿›ç¨‹å®Œæˆ")

if __name__ == '__main__':
    # åªæœ‰åœ¨ä½œä¸ºä¸»ç¨‹åºè¿è¡Œæ—¶æ‰æ‰§è¡Œå¤šè¿›ç¨‹ä»£ç 
    safe_windows_example()
```

#### 5.4.3 è·¨å¹³å°å…¼å®¹æ€§å¤„ç†

```python
import multiprocessing
import os
import platform

def cross_platform_task(data):
    """è·¨å¹³å°ä»»åŠ¡"""
    system = platform.system()
    pid = os.getpid()
    print(f"ç³»ç»Ÿ: {system}, è¿›ç¨‹PID: {pid}, å¤„ç†æ•°æ®: {data}")
    return data * 2

def get_process_count():
    """æ ¹æ®ç³»ç»Ÿè·å–åˆé€‚çš„è¿›ç¨‹æ•°"""
    cpu_count = multiprocessing.cpu_count()
    system = platform.system()

    if system == "Windows":
        # Windowsä¸‹åˆ›å»ºè¿›ç¨‹å¼€é”€è¾ƒå¤§ï¼Œä½¿ç”¨è¾ƒå°‘çš„è¿›ç¨‹ï¼Œæˆ–æ‰§è¡Œå…¶ä»–çš„æ“ä½œ
        return min(4, cpu_count)
    else:
        # Unix-likeç³»ç»Ÿå¯ä»¥ä½¿ç”¨æ›´å¤šè¿›ç¨‹
        return cpu_count

def cross_platform_demo():
    """è·¨å¹³å°å¤šè¿›ç¨‹æ¼”ç¤º"""
    print(f"å½“å‰ç³»ç»Ÿ: {platform.system()}")
    print(f"CPUæ ¸å¿ƒæ•°: {multiprocessing.cpu_count()}")

    process_count = get_process_count()
    print(f"ä½¿ç”¨è¿›ç¨‹æ•°: {process_count}")

    # å‡†å¤‡æ•°æ®
    data_list = list(range(1, 11))

    # åˆ›å»ºè¿›ç¨‹æ± å¤„ç†æ•°æ®ï¼ˆè¿›ç¨‹æ± å°†åœ¨åé¢è¯¦ç»†ä»‹ç»ï¼‰
    with multiprocessing.Pool(process_count) as pool:
        results = pool.map(cross_platform_task, data_list)

    print(f"å¤„ç†ç»“æœ: {results}")

if __name__ == '__main__':
    cross_platform_demo()
```

## 6. è¿›ç¨‹é—´é€šä¿¡ä¸åŒæ­¥

### 6.1 è¿›ç¨‹æ•°æ®éš”ç¦»

åœ¨æ“ä½œç³»ç»Ÿä¸­ï¼Œçˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹çš„æ•°æ®æ®µæ˜¯éš”ç¦»çš„ã€‚å­è¿›ç¨‹åœ¨åˆ›å»ºæ—¶ä¼šå¤åˆ¶çˆ¶è¿›ç¨‹çš„å†…å­˜ç©ºé—´ï¼Œä½†å®ƒä»¬çš„æ•°æ®æ®µæ˜¯ç‹¬ç«‹çš„ã€‚å³ä½¿çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹æœ‰ç›¸åŒçš„ä»£ç æ®µï¼Œå®ƒä»¬çš„å†…å­˜ä¸­çš„æ•°æ®æ˜¯å„è‡ªç‹¬ç«‹çš„ã€‚

#### 6.1.1 æ•°æ®éš”ç¦»ç¤ºä¾‹

```python
import time, random
from multiprocessing import Process

num = 100

def func():
    global num
    num -= 1

if __name__ == '__main__':
    process_list = []
    for i in range(10):
        p = Process(target=func)
        p.start()
        process_list.append(p)
    t2 = time.time()
    for p in process_list:
        p.join()

    print(num)  # num=?
```



### 6.2 Queue é˜Ÿåˆ—é€šä¿¡

`Queue` æ˜¯ä¸€ä¸ªåŸºäºæ–‡ä»¶ç±»å‹çš„é€šä¿¡é˜Ÿåˆ—å¯¹è±¡ï¼Œå¯ä»¥ç”¨æ¥åœ¨è¿›ç¨‹é—´ä¼ é€’æ•°æ®ã€‚å®ƒæ”¯æŒå…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰æœºåˆ¶ï¼Œå¹¶ä¸”å†…ç½®äº†é”æœºåˆ¶æ¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚

#### 6.2.1 Queue åŸºç¡€ç”¨æ³•

```python
from multiprocessing import Process, Queue
import os
import time

def producer(queue, producer_id, item_count):
    """ç”Ÿäº§è€…è¿›ç¨‹"""
    print(f"ç”Ÿäº§è€… {producer_id} å¼€å§‹ç”Ÿäº§ï¼ŒPID: {os.getpid()}")

    for i in range(item_count):
        item = f"Producer-{producer_id}-Item-{i+1}"
        queue.put(item)
        print(f"ç”Ÿäº§è€… {producer_id} ç”Ÿäº§: {item}")
        time.sleep(0.5)

    # æ”¾å…¥ç»“æŸæ ‡å¿—
    queue.put(f"END-{producer_id}")
    print(f"ç”Ÿäº§è€… {producer_id} å®Œæˆ")

def consumer(queue, consumer_id):
    """æ¶ˆè´¹è€…è¿›ç¨‹"""
    print(f"æ¶ˆè´¹è€… {consumer_id} å¼€å§‹æ¶ˆè´¹ï¼ŒPID: {os.getpid()}")
    consumed_items = []

    while True:
        item = queue.get()  # ä»é˜Ÿåˆ—è·å–æ•°æ®

        if item.startswith("END"):
            print(f"æ¶ˆè´¹è€… {consumer_id} æ”¶åˆ°ç»“æŸä¿¡å·: {item}")
            queue.put(item)  # æŠŠç»“æŸä¿¡å·æ”¾å›å»ï¼Œä¾›å…¶ä»–æ¶ˆè´¹è€…ä½¿ç”¨
            break

        consumed_items.append(item)
        print(f"æ¶ˆè´¹è€… {consumer_id} æ¶ˆè´¹: {item}")
        time.sleep(0.3)

    print(f"æ¶ˆè´¹è€… {consumer_id} å®Œæˆï¼Œå…±æ¶ˆè´¹ {len(consumed_items)} ä¸ªå•†å“")

def queue_demo():
    """é˜Ÿåˆ—é€šä¿¡æ¼”ç¤º"""
    # åˆ›å»ºé˜Ÿåˆ—
    q = Queue(maxsize=10)  # è®¾ç½®æœ€å¤§å®¹é‡

    processes = []

    # åˆ›å»ºç”Ÿäº§è€…è¿›ç¨‹
    for i in range(2):
        p = Process(target=producer, args=(q, i+1, 3))
        p.start()
        processes.append(p)

    # åˆ›å»ºæ¶ˆè´¹è€…è¿›ç¨‹
    for i in range(2):
        p = Process(target=consumer, args=(q, i+1))
        p.start()
        processes.append(p)

    # ç­‰å¾…æ‰€æœ‰è¿›ç¨‹å®Œæˆ
    for p in processes:
        p.join()

    print("æ‰€æœ‰è¿›ç¨‹å®Œæˆ")

if __name__ == '__main__':
    queue_demo()
```

#### 6.2.2 ä½¿ç”¨Queueè¿›è¡Œä»»åŠ¡åˆ†å‘

```python
from multiprocessing import Process, Queue, current_process
import time
import random

def calculate_task(task_data):
    """è®¡ç®—ä»»åŠ¡"""
    task_id, numbers = task_data
    result = sum(x * x for x in numbers)
    time.sleep(random.uniform(0.5, 2.0))  # æ¨¡æ‹Ÿè®¡ç®—æ—¶é—´
    return task_id, result

def worker_process(task_queue, result_queue):
    """å·¥ä½œè¿›ç¨‹"""
    process = current_process()
    print(f"{process.name} å¼€å§‹å·¥ä½œ")

    completed_tasks = 0

    while True:
        try:
            # ä»ä»»åŠ¡é˜Ÿåˆ—è·å–ä»»åŠ¡
            task_data = task_queue.get(timeout=2)

            if task_data is None:  # ç»“æŸæ ‡å¿—
                print(f"{process.name} æ”¶åˆ°ç»“æŸä¿¡å·")
                break

            # æ‰§è¡Œä»»åŠ¡
            task_id, numbers = task_data
            print(f"{process.name} å¤„ç†ä»»åŠ¡ {task_id}")

            result = calculate_task(task_data)

            # å°†ç»“æœæ”¾å…¥ç»“æœé˜Ÿåˆ—
            result_queue.put(result)
            completed_tasks += 1

        except Exception as e:
            print(f"{process.name} å‘ç”Ÿé”™è¯¯: {e}")
            break

    print(f"{process.name} å®Œæˆ {completed_tasks} ä¸ªä»»åŠ¡")

def task_distribution_demo():
    """ä»»åŠ¡åˆ†å‘æ¼”ç¤º"""
    task_queue = Queue()
    result_queue = Queue()

    # å‡†å¤‡ä»»åŠ¡æ•°æ®
    tasks = []
    for i in range(10):
        numbers = [random.randint(1, 100) for _ in range(5)]
        tasks.append((f"Task-{i+1}", numbers))

    # å°†ä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—
    print("æ­£åœ¨åˆ†å‘ä»»åŠ¡...")
    for task in tasks:
        task_queue.put(task)
        print(f"åˆ†å‘ä»»åŠ¡: {task[0]}")

    # åˆ›å»ºå·¥ä½œè¿›ç¨‹
    workers = []
    for i in range(3):
        p = Process(
            target=worker_process,
            args=(task_queue, result_queue),
            name=f"Worker-{i+1}"
        )
        p.start()
        workers.append(p)

    # ç­‰å¾…ä¸€æ®µæ—¶é—´åå‘é€ç»“æŸä¿¡å·
    time.sleep(1)
    for _ in workers:
        task_queue.put(None)  # å‘é€ç»“æŸä¿¡å·

    # æ”¶é›†ç»“æœ
    print("æ­£åœ¨æ”¶é›†ç»“æœ...")
    results = []
    for _ in tasks:
        result = result_queue.get()
        results.append(result)
        print(f"æ”¶åˆ°ç»“æœ: {result}")

    # ç­‰å¾…æ‰€æœ‰å·¥ä½œè¿›ç¨‹å®Œæˆ
    for p in workers:
        p.join()

    print(f"æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼Œå…±æ”¶åˆ° {len(results)} ä¸ªç»“æœ")

if __name__ == '__main__':
    task_distribution_demo()
```

### 6.3 Pipe ç®¡é“é€šä¿¡

`Pipe` æ˜¯ä¸€ä¸ªåŸºäºæ–‡ä»¶ç±»å‹çš„**åŒå‘é€šä¿¡ç®¡é“**ï¼Œå…è®¸åœ¨ä¸¤ä¸ªè¿›ç¨‹é—´ä¼ é€’æ•°æ®ã€‚ä¸ `Queue` ä¸åŒï¼Œ`Pipe` æ²¡æœ‰å…ˆè¿›å…ˆå‡ºçš„æœºåˆ¶ï¼Œå¹¶ä¸”æ²¡æœ‰å†…ç½®é”ã€‚

#### 6.3.1 Pipe åŸºç¡€ç”¨æ³•

```python
from multiprocessing import Process, Pipe
import os
import time

def sender_process(conn, sender_id):
    """å‘é€è€…è¿›ç¨‹"""
    print(f"å‘é€è€… {sender_id} å¼€å§‹ï¼ŒPID: {os.getpid()}")

    messages = [
        f"Hello from {sender_id}",
        f"Message 1 from {sender_id}",
        f"Message 2 from {sender_id}",
        {"type": "data", "sender": sender_id, "value": 42},
        [1, 2, 3, 4, 5]
    ]

    for i, msg in enumerate(messages):
        conn.send(msg)
        print(f"å‘é€è€… {sender_id} å‘é€: {msg}")
        time.sleep(0.5)

    # å‘é€ç»“æŸä¿¡å·
    conn.send("END")
    conn.close()
    print(f"å‘é€è€… {sender_id} å®Œæˆ")

def receiver_process(conn, receiver_id):
    """æ¥æ”¶è€…è¿›ç¨‹"""
    print(f"æ¥æ”¶è€… {receiver_id} å¼€å§‹ï¼ŒPID: {os.getpid()}")
    received_count = 0

    while True:
        try:
            msg = conn.recv()
            if msg == "END":
                print(f"æ¥æ”¶è€… {receiver_id} æ”¶åˆ°ç»“æŸä¿¡å·")
                break

            received_count += 1
            print(f"æ¥æ”¶è€… {receiver_id} æ¥æ”¶: {msg} (ç±»å‹: {type(msg).__name__})")

        except EOFError:
            print(f"æ¥æ”¶è€… {receiver_id} è¿æ¥å…³é—­")
            break

    conn.close()
    print(f"æ¥æ”¶è€… {receiver_id} å®Œæˆï¼Œå…±æ¥æ”¶ {received_count} æ¡æ¶ˆæ¯")

def simple_pipe_demo():
    """ç®€å•çš„Pipeæ¼”ç¤º"""
    # åˆ›å»ºç®¡é“
    parent_conn, child_conn = Pipe()

    # åˆ›å»ºå‘é€è€…å’Œæ¥æ”¶è€…è¿›ç¨‹
    sender = Process(target=sender_process, args=(child_conn, "Sender-1"))
    receiver = Process(target=receiver_process, args=(parent_conn, "Receiver-1"))

    # å¯åŠ¨è¿›ç¨‹
    sender.start()
    receiver.start()

    # ç­‰å¾…å®Œæˆ
    sender.join()
    receiver.join()

    print("ç®€å•Pipeæ¼”ç¤ºå®Œæˆ")

if __name__ == '__main__':
    simple_pipe_demo()
```

#### 6.3.2 åŒå‘é€šä¿¡ç¤ºä¾‹

```python
from multiprocessing import Process, Pipe
import time
import random

def interactive_process(conn, process_name, message_count):
    """äº¤äº’è¿›ç¨‹ï¼Œæ—¢å‘é€ä¹Ÿæ¥æ”¶æ¶ˆæ¯"""
    print(f"{process_name} å¼€å§‹äº¤äº’")

    for i in range(message_count):
        # å‘é€æ¶ˆæ¯
        message = f"{process_name} çš„æ¶ˆæ¯ {i+1}: {random.randint(1, 100)}"
        conn.send(message)
        print(f"{process_name} å‘é€: {message}")

        # ç­‰å¾…å¹¶æ¥æ”¶å“åº”
        try:
            if conn.poll(timeout=2):  # ç­‰å¾…2ç§’
                response = conn.recv()
                print(f"{process_name} æ¥æ”¶: {response}")
            else:
                print(f"{process_name} æ²¡æœ‰æ”¶åˆ°å“åº”")
        except:
            print(f"{process_name} æ¥æ”¶å¼‚å¸¸")

        time.sleep(0.5)

    # å‘é€ç»“æŸä¿¡å·
    conn.send("FINISH")
    print(f"{process_name} å®Œæˆ")

def bidirectional_pipe_demo():
    """åŒå‘é€šä¿¡æ¼”ç¤º"""
    conn1, conn2 = Pipe()

    # åˆ›å»ºä¸¤ä¸ªäº¤äº’è¿›ç¨‹
    p1 = Process(target=interactive_process, args=(conn1, "Process-A", 3))
    p2 = Process(target=interactive_process, args=(conn2, "Process-B", 3))

    p1.start()
    p2.start()

    p1.join()
    p2.join()

    print("åŒå‘é€šä¿¡æ¼”ç¤ºå®Œæˆ")

if __name__ == '__main__':
    bidirectional_pipe_demo()
```

### 6.4 Queue vs Pipe å¯¹æ¯”

```mermaid
graph TD
    A[è¿›ç¨‹é—´é€šä¿¡æ–¹å¼] --> B[Queue é˜Ÿåˆ—]
    A --> C[Pipe ç®¡é“]

    B --> B1[ç‰¹ç‚¹<br/>- FIFOæœºåˆ¶<br/>- å†…ç½®é”<br/>- æ”¯æŒå¤šè¿›ç¨‹<br/>- çº¿ç¨‹å®‰å…¨]
    C --> C1[ç‰¹ç‚¹<br/>- åŒå‘é€šä¿¡<br/>- æ— å†…ç½®é”<br/>- ä»…æ”¯æŒä¸¤ä¸ªè¿›ç¨‹<br/>- é€Ÿåº¦æ›´å¿«]

    B --> B2[é€‚ç”¨åœºæ™¯<br/>- å¤šç”Ÿäº§è€…/æ¶ˆè´¹è€…<br/>- ä»»åŠ¡åˆ†å‘<br/>- å·¥ä½œé˜Ÿåˆ—]
    C --> C2[é€‚ç”¨åœºæ™¯<br/>- çˆ¶å­è¿›ç¨‹é€šä¿¡<br/>- å®æ—¶æ•°æ®äº¤æ¢<br/>- ç®€å•é€šä¿¡]

    style B1 fill:#ccffcc
    style C1 fill:#ffffcc
```

**å¯¹æ¯”è¡¨**ï¼š

| ç‰¹æ€§ | Queue | Pipe |
|:---|:---|:---|
| é€šä¿¡æ¨¡å¼ | å¤šå¯¹å¤š | ä¸€å¯¹ä¸€ |
| æ•°æ®ç»“æ„ | FIFOé˜Ÿåˆ— | åŒå‘é€šé“ |
| çº¿ç¨‹å®‰å…¨ | æ˜¯ï¼ˆå†…ç½®é”ï¼‰ | å¦ |
| æ€§èƒ½ | è¾ƒæ…¢ | è¾ƒå¿« |
| å†…å­˜ä½¿ç”¨ | è¾ƒå¤§ | è¾ƒå° |
| ç¼“å†²æ”¯æŒ | æ”¯æŒmaxsize | æ—  |
| å¤æ‚åº¦ | è¾ƒå¤æ‚ | ç®€å• |

### 6.5 è¿›ç¨‹é”æœºåˆ¶

åœ¨å¤šè¿›ç¨‹ç¯å¢ƒä¸­ï¼Œå¤šä¸ªè¿›ç¨‹è®¿é—®å…±äº«èµ„æºæ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œå¯ä»¥ä½¿ç”¨ **é”** æ¥åŒæ­¥å¤šä¸ªè¿›ç¨‹å¯¹å…±äº«èµ„æºçš„è®¿é—®ã€‚

#### 6.5.1 æ²¡æœ‰é”çš„é—®é¢˜æ¼”ç¤º

```python
import json
import time
import os
from multiprocessing import Process

def get_ticket_info(username):
    """æŸ¥è¯¢ä½™ç¥¨"""
    with open("ticket.json", "r") as f:
        data = json.load(f)
        print(f"{username} æŸ¥è¯¢ä½™ç¥¨ï¼š{data['count']} å¼ ")
        return data['count']

def buy_ticket_unsafe(username):
    """ä¸å®‰å…¨çš„è´­ç¥¨æ“ä½œ"""
    print(f"{username} å¼€å§‹è´­ç¥¨æµç¨‹")

    # æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
    time.sleep(0.1)

    # è¯»å–ç¥¨æ•°
    with open("ticket.json", "r") as f:
        data = json.load(f)
        print(f"{username} è¯»å–åˆ°ç¥¨æ•°ï¼š{data['count']}")

    if data["count"] > 0:
        # æ¨¡æ‹Ÿè´­ç¥¨å¤„ç†æ—¶é—´
        time.sleep(0.2)

        # å‡å°‘ç¥¨æ•°
        data["count"] -= 1
        print(f"{username} æˆåŠŸè´­ä¹°ç¥¨ï¼ä½™ç¥¨ï¼š{data['count']}")

        # å†™å›æ•°æ®
        with open("ticket.json", "w") as f:
            json.dump(data, f)
    else:
        print(f"{username} è´­ç¥¨å¤±è´¥ï¼ä½™ç¥¨ä¸è¶³")

def prepare_ticket_file():
    """å‡†å¤‡ç¥¨åŠ¡æ•°æ®æ–‡ä»¶"""
    ticket_data = {"count": 5}
    with open("ticket.json", "w") as f:
        json.dump(ticket_data, f)
    print(f"åˆå§‹åŒ–ç¥¨åŠ¡æ•°æ®ï¼š{ticket_data['count']} å¼ ")

def unsafe_ticket_demo():
    """ä¸å®‰å…¨çš„è´­ç¥¨æ¼”ç¤º"""
    print("=== ä¸å®‰å…¨çš„å¤šè¿›ç¨‹è´­ç¥¨æ¼”ç¤º ===")

    # å‡†å¤‡æ•°æ®
    prepare_ticket_file()

    # åˆ›å»ºå¤šä¸ªè´­ç¥¨è¿›ç¨‹
    processes = []
    users = ["Alice", "Bob", "Charlie", "David", "Eve", "Frank", "Grace"]

    for user in users:
        p = Process(target=buy_ticket_unsafe, args=(user,))
        processes.append(p)
        p.start()
        time.sleep(0.05)  # å°å»¶è¿Ÿï¼Œå¢åŠ ç«äº‰æ¦‚ç‡

    # ç­‰å¾…æ‰€æœ‰è¿›ç¨‹å®Œæˆ
    for p in processes:
        p.join()

    # æ£€æŸ¥æœ€ç»ˆç»“æœ
    with open("ticket.json", "r") as f:
        final_data = json.load(f)
        print(f"æœ€ç»ˆä½™ç¥¨ï¼š{final_data['count']} å¼ ")
        print(f"é—®é¢˜ï¼šå¯èƒ½å‡ºç°è¶…å–æƒ…å†µï¼")

    # æ¸…ç†æ–‡ä»¶
    os.remove("ticket.json")

if __name__ == '__main__':
    unsafe_ticket_demo()
```

#### 6.5.2 ä½¿ç”¨Lockè§£å†³é—®é¢˜

* åˆå§‹åŒ–ä¸€æŠŠé”ç„¶åæŠŠé”ä½œä¸ºå‚æ•°ä¼ é€’ç»™è¿›ç¨‹

```python
import json
import time
import os
from multiprocessing import Process, Lock

def buy_ticket_safe(username, lock):
    """å®‰å…¨çš„è´­ç¥¨æ“ä½œï¼ˆä½¿ç”¨é”ï¼‰"""
    print(f"{username} å¼€å§‹è´­ç¥¨æµç¨‹")

    # æŸ¥è¯¢æ“ä½œä¸éœ€è¦é”ï¼ˆåªè¯»ï¼‰
    with open("ticket.json", "r") as f:
        data = json.load(f)
        print(f"{username} æŸ¥è¯¢ä½™ç¥¨ï¼š{data['count']} å¼ ")

    # ä½¿ç”¨é”ä¿æŠ¤è´­ç¥¨æ“ä½œ
    with lock:  # è·å–é”
        print(f"{username} è·å¾—é”ï¼Œå¼€å§‹è´­ç¥¨...")

        # å†æ¬¡è¯»å–ï¼ˆç¡®ä¿æ•°æ®æœ€æ–°ï¼‰
        with open("ticket.json", "r") as f:
            data = json.load(f)

        if data["count"] > 0:
            # æ¨¡æ‹Ÿè´­ç¥¨å¤„ç†æ—¶é—´
            time.sleep(0.1)

            data["count"] -= 1
            print(f"{username} æˆåŠŸè´­ä¹°ç¥¨ï¼ä½™ç¥¨ï¼š{data['count']}")

            # å†™å›æ•°æ®
            with open("ticket.json", "w") as f:
                json.dump(data, f)
        else:
            print(f"{username} è´­ç¥¨å¤±è´¥ï¼ä½™ç¥¨ä¸è¶³")

        print(f"{username} é‡Šæ”¾é”")
    # è‡ªåŠ¨é‡Šæ”¾é”

def safe_ticket_demo():
    """å®‰å…¨çš„è´­ç¥¨æ¼”ç¤º"""
    print("=== å®‰å…¨çš„å¤šè¿›ç¨‹è´­ç¥¨æ¼”ç¤º ===")

    # å‡†å¤‡æ•°æ®
    ticket_data = {"count": 5}
    with open("ticket.json", "w") as f:
        json.dump(ticket_data, f)
    print(f"åˆå§‹åŒ–ç¥¨åŠ¡æ•°æ®ï¼š{ticket_data['count']} å¼ ")

    # åˆ›å»ºé”
    lock = Lock()

    # åˆ›å»ºå¤šä¸ªè´­ç¥¨è¿›ç¨‹
    processes = []
    users = ["Alice", "Bob", "Charlie", "David", "Eve", "Frank", "Grace"]

    for user in users:
        p = Process(target=buy_ticket_safe, args=(user, lock))
        processes.append(p)
        p.start()
        time.sleep(0.05)

    # ç­‰å¾…æ‰€æœ‰è¿›ç¨‹å®Œæˆ
    for p in processes:
        p.join()

    # æ£€æŸ¥æœ€ç»ˆç»“æœ
    with open("ticket.json", "r") as f:
        final_data = json.load(f)
        print(f"æœ€ç»ˆä½™ç¥¨ï¼š{final_data['count']} å¼ ")
        print("ç»“æœï¼šæ­£ç¡®ï¼Œæ²¡æœ‰è¶…å–ï¼")

    # æ¸…ç†æ–‡ä»¶
    os.remove("ticket.json")

if __name__ == '__main__':
    safe_ticket_demo()
```

### 6.6 IPC æ–¹å¼å¯¹æ¯”æ€»ç»“

```mermaid
graph TD
    A[è¿›ç¨‹é—´é€šä¿¡IPCæ–¹å¼] --> B[å†…å­˜å…±äº«ç±»]
    A --> C[æ¶ˆæ¯ä¼ é€’ç±»]
    A --> D[åŒæ­¥åŸè¯­ç±»]

    B --> B1[Queueé˜Ÿåˆ—<br/>Pipeç®¡é“<br/>Value/Array<br/>Manager]
    C --> C1[ä¿¡å·Signal<br/>å¥—æ¥å­—Socket<br/>æ–‡ä»¶File]
    D --> D1[Lockäº’æ–¥é”<br/>RLocké€’å½’é”<br/>Semaphoreä¿¡å·é‡<br/>Eventäº‹ä»¶]

    style B1 fill:#ccffcc
    style C1 fill:#ffffcc
    style D1 fill:#ffcccc
```

**IPCæ–¹å¼å¯¹æ¯”è¡¨**ï¼š

| æ–¹å¼ | å¤æ‚åº¦ | æ€§èƒ½ | å®‰å…¨æ€§ | é€‚ç”¨åœºæ™¯ |
|:---|:---|:---|:---|:---|
| Queue | ä½ | ä¸­ | é«˜ | ä»»åŠ¡åˆ†å‘ã€ç”Ÿäº§è€…æ¶ˆè´¹è€… |
| Pipe | ä½ | é«˜ | ä¸­ | çˆ¶å­è¿›ç¨‹é€šä¿¡ã€å®æ—¶æ•°æ® |
| Lock | ä½ | ä¸­ | é«˜ | ä¿æŠ¤å…±äº«èµ„æº |
| Manager | é«˜ | ä½ | é«˜ | å¤æ‚æ•°æ®å…±äº« |
| Socket | é«˜ | é«˜ | ä¸­ | ç½‘ç»œé€šä¿¡ã€è·¨æœºå™¨ |

## 7. è¿›ç¨‹æ± ä¸å­è¿›ç¨‹ç®¡ç†

### 7.1 è¿›ç¨‹æ±  (Pool) è¯¦è§£

å½“éœ€è¦å¯åŠ¨å¤§é‡çš„å­è¿›ç¨‹æ—¶ï¼Œç›´æ¥ä½¿ç”¨ `Process` åˆ›å»ºè¿›ç¨‹å¯èƒ½ä¼šå¯¼è‡´è¿›ç¨‹åˆ›å»ºå’Œç®¡ç†çš„å¼€é”€å˜å¾—è¿‡å¤§ã€‚ä¸ºäº†æé«˜æ•ˆç‡å’Œç®€åŒ–è¿›ç¨‹ç®¡ç†ï¼Œå¯ä»¥ä½¿ç”¨è¿›ç¨‹æ±  (`Pool`) æ¥æ‰¹é‡ç®¡ç†å­è¿›ç¨‹ã€‚

```mermaid
graph TD
    A[è¿›ç¨‹æ± ä¼˜åŠ¿] --> B[èµ„æºç®¡ç†]
    A --> C[ä»»åŠ¡è°ƒåº¦]
    A --> D[æ€§èƒ½ä¼˜åŒ–]

    B --> B1[é™åˆ¶åŒæ—¶è¿è¡Œè¿›ç¨‹æ•°<br/>é¿å…ç³»ç»Ÿè´Ÿæ‹…è¿‡é‡]
    C --> C1[è‡ªåŠ¨åˆ†é…ä»»åŠ¡åˆ°ç©ºé—²è¿›ç¨‹<br/>è¿›ç¨‹å¯é‡å¤ä½¿ç”¨]
    D --> D1[å‡å°‘è¿›ç¨‹åˆ›å»º/é”€æ¯å¼€é”€<br/>æé«˜æ•´ä½“æ€§èƒ½]

    style B1 fill:#ccffcc
    style C1 fill:#ffffcc
    style D1 fill:#ffcccc
```

#### 7.1.1 åŸºç¡€è¿›ç¨‹æ± ç¤ºä¾‹

```python
from multiprocessing import Pool
import os
import time
import random


def cpu_intensive_task(task_data):
    """è®¡ç®—å¯†é›†å‹ä»»åŠ¡"""
    task_id, numbers = task_data
    worker_pid = os.getpid()

    print(f"Task {task_id} å¼€å§‹ - Worker PID: {worker_pid}")

    # æ¨¡æ‹Ÿå¤æ‚è®¡ç®—
    result = 0
    for num in numbers:
        result += sum(i*i for i in range(num))

    # æ¨¡æ‹Ÿå¯å˜è®¡ç®—æ—¶é—´
    time.sleep(random.uniform(0.5, 2.0))

    print(f"Task {task_id} å®Œæˆ - Worker PID: {worker_pid}, Result: {result}")
    return task_id, result, worker_pid


def basic_pool_demo():
    """åŸºç¡€è¿›ç¨‹æ± æ¼”ç¤º"""
    print("=== åŸºç¡€è¿›ç¨‹æ± æ¼”ç¤º ===")
    print(f"ä¸»è¿›ç¨‹PID: {os.getpid()}")

    # å‡†å¤‡ä»»åŠ¡æ•°æ®
    tasks = []
    for i in range(8):
        numbers = [random.randint(50, 200) for _ in range(3)]
        tasks.append((f"Task-{i+1}", numbers))

    # åˆ›å»ºè¿›ç¨‹æ± ï¼ˆæœ€å¤š4ä¸ªè¿›ç¨‹åŒæ—¶æ‰§è¡Œï¼‰
    with Pool(processes=4) as pool:
        print("è¿›ç¨‹æ± å·²åˆ›å»ºï¼Œå¼€å§‹å¤„ç†ä»»åŠ¡...")

        start_time = time.time()

        # ä½¿ç”¨ map æ–¹æ³•æ‰¹é‡å¤„ç†ä»»åŠ¡
        results = pool.map(cpu_intensive_task, tasks)

        end_time = time.time()

    print(f"\næ‰€æœ‰ä»»åŠ¡å®Œæˆï¼Œæ€»è€—æ—¶: {end_time - start_time:.2f}ç§’")
    print("å¤„ç†ç»“æœ:")
    for task_id, result, worker_pid in results:
        print(f"  {task_id}: {result} (Worker: {worker_pid})")


if __name__ == '__main__':
    basic_pool_demo()

```

#### 7.1.2 è¿›ç¨‹æ± çš„ä¸åŒæ–¹æ³•

| æ–¹æ³•                        | ç‰¹ç‚¹                                                  | åœºæ™¯                                 |
| --------------------------- | ----------------------------------------------------- | ------------------------------------ |
| `pool.map(func, iterable)`  | é˜»å¡å¼ï¼ŒæŒ‰é¡ºåºè¿”å›ç»“æœï¼Œç±»ä¼¼å†…ç½®`map`                 | ä»»åŠ¡ç®€å•ã€é¡ºåºå¤„ç†ã€éœ€å®Œæ•´ç»“æœ       |
| `pool.map_async(...)`       | å¼‚æ­¥éé˜»å¡ï¼Œè¿”å›`AsyncResult`å¯¹è±¡ï¼Œéœ€`.get()`è·å–ç»“æœ | éœ€è¦å¹¶å‘æ‰§è¡Œ + åç»­å¤„ç†              |
| `pool.apply(func, args)`    | å•ä»»åŠ¡é˜»å¡è°ƒç”¨ï¼ˆä¸€æ¬¡åªæ´¾ä¸€ä¸ªä»»åŠ¡ï¼‰                    | è°ƒè¯•æˆ–ç‰¹æ®Šå•ä»»åŠ¡                     |
| `pool.apply_async(...)`     | å•ä»»åŠ¡å¼‚æ­¥è°ƒç”¨ï¼Œè¿”å›`AsyncResult`ï¼Œå¯åŠ å›è°ƒ           | çµæ´»æ§åˆ¶æ¯ä¸ªä»»åŠ¡ + å›è°ƒ              |
| `pool.imap(func, iterable)` | è¿”å›è¿­ä»£å™¨ï¼Œç»“æœæŒ‰è¾“å…¥é¡ºåºé€ä¸ªäº§ç”Ÿï¼Œè¾¹ç®—è¾¹å–          | æ•°æ®é‡å¤§ï¼Œè¾¹è®¡ç®—è¾¹å¤„ç†ï¼Œé™ä½å†…å­˜å ç”¨ |

```python
from multiprocessing import Pool, current_process
import time
import os

def sample_task(x):
    """ç¤ºä¾‹ä»»åŠ¡"""
    process = current_process()
    pid = os.getpid()
    print(f"Processing {x} in {process.name} (PID: {pid})")
    time.sleep(1)
    return x * x

def callback_success(result):
    """æˆåŠŸå›è°ƒå‡½æ•°"""
    print(f"Task completed successfully: {result}")

def callback_error(error):
    """é”™è¯¯å›è°ƒå‡½æ•°"""
    print(f"Task failed with error: {error}")

def pool_methods_demo():
    """è¿›ç¨‹æ± ä¸åŒæ–¹æ³•æ¼”ç¤º"""
    print("=== è¿›ç¨‹æ± æ–¹æ³•æ¼”ç¤º ===")

    with Pool(processes=3) as pool:
        data = [1, 2, 3, 4, 5]

        print("\n1. ä½¿ç”¨ map() - é˜™å¡å¼æ‰¹é‡å¤„ç†")
        results = pool.map(sample_task, data)
        print(f"Map ç»“æœ: {results}")

        print("\n2. ä½¿ç”¨ map_async() - å¼‚æ­¥æ‰¹é‡å¤„ç†")
        async_result = pool.map_async(sample_task, data)
        print("å¼‚æ­¥ä»»åŠ¡å·²æäº¤ï¼Œç­‰å¾…ç»“æœ...")
        results = async_result.get(timeout=10)  # ç­‰å¾…ç»“æœ
        print(f"Map_async ç»“æœ: {results}")

        print("\n3. ä½¿ç”¨ apply() - å•ä¸ªä»»åŠ¡é˜™å¡å¼")
        result = pool.apply(sample_task, (10,))
        print(f"Apply ç»“æœ: {result}")

        print("\n4. ä½¿ç”¨ apply_async() - å•ä¸ªä»»åŠ¡å¼‚æ­¥")
        async_results = []
        for i in range(3):
            ar = pool.apply_async(
                sample_task,
                (i + 20,),
                callback=callback_success,
                error_callback=callback_error
            )
            async_results.append(ar)

        # è·å–æ‰€æœ‰å¼‚æ­¥ç»“æœ
        final_results = [ar.get() for ar in async_results]
        print(f"Apply_async ç»“æœ: {final_results}")

        print("\n5. ä½¿ç”¨ imap() - è¿­ä»£å¼å¤„ç†")
        for i, result in enumerate(pool.imap(sample_task, [30, 31, 32])):
            print(f"Imap ç»“æœ {i+1}: {result}")

if __name__ == '__main__':
    pool_methods_demo()
```

#### 7.1.3 è¿›ç¨‹æ±  vs æ‰‹åŠ¨åˆ›å»ºè¿›ç¨‹å¯¹æ¯”

* **ä¸€æ¬¡æ€§å°ä»»åŠ¡ â†’ `Process` æ›´å¿«**

* **é‡å¤å¤§é‡ä»»åŠ¡ â†’ `Pool` æ›´å¿«ï¼ˆèŠ‚çœè¿›ç¨‹åˆ›å»ºå¼€é”€ï¼‰**

**poolæ›´å¿«ï¼š**

```python
from multiprocessing import Process, Pool
import time


def task(x):
    return sum(i*i for i in range(10_000))

# æ¯æ¬¡æ–°å»º 10 ä¸ªè¿›ç¨‹


def run_processes():
    for _ in range(100):  # é‡å¤ 100 æ‰¹
        ps = []
        for i in range(10):
            p = Process(target=task, args=(i,))
            ps.append(p)
            p.start()
        for p in ps:
            p.join()

# ç”¨è¿›ç¨‹æ± å¤ç”¨è¿›ç¨‹


def run_pool():
    with Pool(10) as pool:
        for _ in range(100):  # é‡å¤ 100 æ‰¹
            pool.map(task, range(10))


if __name__ == '__main__':
    t1 = time.time()
    run_processes()
    print("Process:", time.time()-t1)

    t2 = time.time()
    run_pool()
    print("Pool:", time.time()-t2)

```

**processæ›´å¿«**

```python
from multiprocessing import Process, Pool
import time, os

def task(x):
    return sum(i*i for i in range(10_0000))

# æ‰‹åŠ¨åˆ›å»º 10 ä¸ªè¿›ç¨‹
def run_processes():
    ps = []
    for i in range(10):
        p = Process(target=task, args=(i,))
        ps.append(p)
        p.start()
    for p in ps:
        p.join()

# ç”¨è¿›ç¨‹æ± 
def run_pool():
    with Pool(10) as pool:
        pool.map(task, range(10))

if __name__ == '__main__':
    t1 = time.time(); run_processes(); print("Process:", time.time()-t1)
    t2 = time.time(); run_pool(); print("Pool:", time.time()-t2)

```



### 7.2 subprocess æ¨¡å—è¯¦è§£

`subprocess` æ¨¡å—æ˜¯Pythonä¸­ç”¨äºåˆ›å»ºå’Œç®¡ç†å­è¿›ç¨‹çš„æ ‡å‡†åº“ã€‚å®ƒå…è®¸ä½ å¯åŠ¨æ–°çš„åº”ç”¨ç¨‹åºã€è¿æ¥åˆ°å®ƒä»¬çš„è¾“å…¥/è¾“å‡º/é”™è¯¯ç®¡é“ï¼Œå¹¶è·å¾—è¿”å›ç ã€‚

#### 7.2.1 æ ¸å¿ƒæ¦‚å¿µ

**ä¸»è¦åŠŸèƒ½ï¼š**

- æ‰§è¡Œå¤–éƒ¨å‘½ä»¤å’Œç¨‹åº
- æ•è·å‘½ä»¤çš„è¾“å‡ºå’Œé”™è¯¯
- å‘å­è¿›ç¨‹å‘é€è¾“å…¥
- æ§åˆ¶è¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ

**ä¸¤ç§ä¸»è¦æ–¹å¼ä»¥åŠåŒºåˆ«ï¼š**

**subprocess.run()**

- âœ… **åŒæ­¥** - ç­‰å¾…å‘½ä»¤å®Œæˆæ‰è¿”å›
- âœ… **ç®€å•** - ä¸€è¡Œä»£ç æå®š
- âœ… **å®‰å…¨** - è‡ªåŠ¨èµ„æºæ¸…ç†
- âŒ **é˜»å¡** - æ— æ³•å®æ—¶è·å–è¾“å‡º
- âŒ **æ§åˆ¶æœ‰é™** - åªèƒ½è®¾ç½®è¶…æ—¶

**subprocess.Popen**

- âœ… **å¼‚æ­¥** - ç«‹å³è¿”å›è¿›ç¨‹å¯¹è±¡
- âœ… **å®æ—¶** - å¯ä»¥è¾¹æ‰§è¡Œè¾¹è·å–è¾“å‡º
- âœ… **çµæ´»** - å®Œå…¨æ§åˆ¶è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸ
- âŒ **å¤æ‚** - éœ€è¦æ‰‹åŠ¨ç®¡ç†èµ„æº
- âŒ **å®¹æ˜“å‡ºé”™** - å¿˜è®°cleanupå¯èƒ½é€ æˆåƒµå°¸è¿›ç¨‹

#### 7.2.2 ä½¿ç”¨ subprocess.run()

```python
import subprocess
import sys
import os

def run_basic_commands():
    """è¿è¡ŒåŸºç¡€å‘½ä»¤"""
    print("=== åŸºç¡€å‘½ä»¤æ‰§è¡Œ ===")

    # 1. åŸºç¡€å‘½ä»¤æ‰§è¡Œ
    print("1. æ‰§è¡Œ ls å‘½ä»¤:")
    result = subprocess.run(['ls', '-la'], capture_output=True, text=True)
    print(f"  è¿”å›ç : {result.returncode}")
    print(f"  è¾“å‡ºå‰5è¡Œ:\n{chr(10).join(result.stdout.split(chr(10))[:5])}")

    # 2. æ£€æŸ¥Pythonç‰ˆæœ¬
    print("\n2. æ£€æŸ¥Pythonç‰ˆæœ¬:")
    result = subprocess.run([sys.executable, '--version'],
                          capture_output=True, text=True)
    print(f"  Pythonç‰ˆæœ¬: {result.stdout.strip()}")

    # 3. æ‰§è¡Œç³»ç»Ÿå‘½ä»¤
    if os.name == 'posix':  # Unix-likeç³»ç»Ÿ
        print("\n3. è·å–ç³»ç»Ÿä¿¡æ¯:")
        result = subprocess.run(['uname', '-a'], capture_output=True, text=True)
        print(f"  ç³»ç»Ÿä¿¡æ¯: {result.stdout.strip()}")

    # 4. å¤„ç†é”™è¯¯
    print("\n4. å¤„ç†å‘½ä»¤é”™è¯¯:")
    result = subprocess.run(['nonexistent_command'],
                          capture_output=True, text=True)
    print(f"  è¿”å›ç : {result.returncode}")
    print(f"  é”™è¯¯è¾“å‡º: {result.stderr.strip()}")

def run_with_input():
    """å¸¦è¾“å…¥çš„å‘½ä»¤æ‰§è¡Œ"""
    print("\n=== å¸¦è¾“å…¥çš„å‘½ä»¤æ‰§è¡Œ ===")

    # ä½¿ç”¨grepå‘½ä»¤è¿‡æ»¤æ–‡æœ¬
    text_input = """apple
                    banana
                    cherry
                    apricot
                    blueberry"""

    result = subprocess.run(['grep', 'ap'],
                          input=text_input,
                          text=True,
                          capture_output=True)

    print(f"Grep ç»“æœ:\n{result.stdout}")

def run_python_script():
    """æ‰§è¡ŒPythonä»£ç """
    print("=== æ‰§è¡ŒPythonä»£ç  ===")

    python_code = """
                import sys
                import os
                print(f"Hello from subprocess!")
                print(f"Current PID: {os.getpid()}")
                print(f"Arguments: {sys.argv[1:]}")
                for i in range(3):
                    print(f"Count: {i+1}")
                """

    # æ‰§è¡Œå†…è”Pythonä»£ç 
    result = subprocess.run([sys.executable, '-c', python_code, 'arg1', 'arg2'],
                          capture_output=True, text=True)

    print(f"Pythonè„šæœ¬è¾“å‡º:\n{result.stdout}")

def subprocess_run_demo():
    """
subprocess.run() æ¼”ç¤º"""
    run_basic_commands()
    run_with_input()
    run_python_script()

if __name__ == '__main__':
    subprocess_run_demo()
```

#### 7.2.3 ä½¿ç”¨ subprocess.Popen

`Popen` æä¾›æ›´åº•å±‚çš„æ§åˆ¶ï¼Œé€‚åˆéœ€è¦å®æ—¶äº¤äº’çš„åœºæ™¯ï¼š

```python
import subprocess
import time
import threading

def popen_basic_example():
    """åŸºç¡€Popenç¤ºä¾‹"""
    print("=== åŸºç¡€Popenç¤ºä¾‹ ===")

    # åˆ›å»ºå­è¿›ç¨‹
    process = subprocess.Popen(
        ['python', '-c', '''import time
for i in range(5):
    print(f"Output {i+1}")
    time.sleep(1)'''],
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        text=True
    )

    print(f"å­è¿›ç¨‹PID: {process.pid}")
    print("ç­‰å¾…å­è¿›ç¨‹å®Œæˆ...")

    # ç­‰å¾…å®Œæˆå¹¶è·å–ç»“æœ
    stdout, stderr = process.communicate()

    print(f"è¿”å›ç : {process.returncode}")
    print(f"è¾“å‡º:\n{stdout}")
    if stderr:
        print(f"é”™è¯¯:\n{stderr}")

def popen_realtime_output():
    """å®æ—¶è¾“å‡ºç¤ºä¾‹"""
    print("\n=== å®æ—¶è¾“å‡ºç¤ºä¾‹ ===")

    # åˆ›å»ºä¸€ä¸ªæŒç»­è¾“å‡ºçš„è¿›ç¨‹
    process = subprocess.Popen(
        ['python', '-c', '''
    import time
    import sys
    for i in range(10):
    print(f"Real-time output {i+1}")
    sys.stdout.flush()  # åˆ·æ–°ç¼“å†²åŒº
    time.sleep(0.5)'''],
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        text=True,
        bufsize=1  # è¡Œç¼“å†²
    )

    print("å®æ—¶è¾“å‡º:")

    # è¯»å–å®æ—¶è¾“å‡º
    while True:
        output = process.stdout.readline()
        if output == '' and process.poll() is not None:
            break
        if output:
            print(f"  {output.strip()}")

    # è·å–ä»»ä½•å‰©ä½™è¾“å‡º
    remaining_output, stderr = process.communicate()
    if remaining_output:
        print(f"  {remaining_output}")

    print(f"è¿›ç¨‹ç»“æŸï¼Œè¿”å›ç : {process.returncode}")

def popen_interactive_example():
    """äº¤äº’å¼è¿›ç¨‹ç¤ºä¾‹"""
    print("\n=== äº¤äº’å¼è¿›ç¨‹ç¤ºä¾‹ ===")

    # å¯åŠ¨ä¸€ä¸ªPythonäº¤äº’å¼è§£é‡Šå™¨
    process = subprocess.Popen(
        ['python', '-i'],
        stdin=subprocess.PIPE,
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        text=True,
        bufsize=1
    )

    # å‘é€å‘½ä»¤å¹¶è¯»å–ç»“æœ
    commands = [
        "print('Hello from interactive Python!')",
        "x = 10",
        "y = 20",
        "print(f'x + y = {x + y}')",
        "import math",
        "print(f'sqrt(100) = {math.sqrt(100)}')",
        "exit()"  # é€€å‡ºPython
    ]

    for cmd in commands:
        print(f">>> {cmd}")
        process.stdin.write(cmd + '\n')
        process.stdin.flush()
        time.sleep(0.1)  # ç­‰å¾…è¾“å‡º

    # ç­‰å¾…è¿›ç¨‹ç»“æŸ
    stdout, stderr = process.communicate()

    print("è¾“å‡º:")
    # è¿‡æ»¤ä¸€äº›Pythonäº¤äº’å¼çš„å¹²æ‰°ä¿¡æ¯
    lines = stdout.split('\n')
    for line in lines:
        if line.strip() and not line.startswith('>>>') and not line.startswith('...'):
            print(f"  {line}")

def subprocess_popen_demo():
    """
subprocess.Popen æ¼”ç¤º"""
    popen_basic_example()
    popen_realtime_output()
    popen_interactive_example()

if __name__ == '__main__':
    subprocess_popen_demo()
```

#### 7.2.4 é”™è¯¯å¤„ç†å’Œè¶…æ—¶æ§åˆ¶

```python
import subprocess
import time

def error_handling_demo():
    """é”™è¯¯å¤„ç†æ¼”ç¤º"""
    print("=== é”™è¯¯å¤„ç†æ¼”ç¤º ===")

    # 1. ä½¿ç”¨check=Trueæ£€æŸ¥é”™è¯¯
    try:
        result = subprocess.run(
            ['python', '-c', 'raise ValueError("Something went wrong!")'],
            check=True,  # å¦‚æœè¿”å›ç é0åˆ™æŠ›å‡ºå¼‚å¸¸
            capture_output=True,
            text=True
        )
    except subprocess.CalledProcessError as e:
        print(f"1. å‘½ä»¤æ‰§è¡Œå¤±è´¥:")
        print(f"   è¿”å›ç : {e.returncode}")
        print(f"   é”™è¯¯è¾“å‡º: {e.stderr.strip()}")

    # 2. æ‰‹åŠ¨æ£€æŸ¥è¿”å›ç 
    print("\n2. æ‰‹åŠ¨æ£€æŸ¥è¿”å›ç :")
    result = subprocess.run(
        ['ls', '/nonexistent/directory'],
        capture_output=True,
        text=True
    )

    if result.returncode != 0:
        print(f"   å‘½ä»¤å¤±è´¥ï¼Œè¿”å›ç : {result.returncode}")
        print(f"   é”™è¯¯ä¿¡æ¯: {result.stderr.strip()}")

    # 3. å¤„ç†æ–‡ä»¶ä¸å­˜åœ¨çš„æƒ…å†µ
    try:
        result = subprocess.run(
            ['nonexistent_program'],
            check=True,
            capture_output=True
        )
    except FileNotFoundError:
        print("\n3. ç¨‹åºä¸å­˜åœ¨")
    except subprocess.CalledProcessError as e:
        print(f"\n3. ç¨‹åºæ‰§è¡Œå¤±è´¥: {e}")

def timeout_demo():
    """è¶…æ—¶æ§åˆ¶æ¼”ç¤º"""
    print("\n=== è¶…æ—¶æ§åˆ¶æ¼”ç¤º ===")

    # 1. subprocess.run çš„è¶…æ—¶
    try:
        print("1. æ‰§è¡Œè€æ—¶å‘½ä»¤ï¼ˆè®¾ç½®2ç§’è¶…æ—¶ï¼‰:")
        result = subprocess.run(
            ['python', '-c', 'import time; time.sleep(5); print("Done")'],
            timeout=2,  # 2ç§’è¶…æ—¶
            capture_output=True,
            text=True
        )
        print(f"   ç»“æœ: {result.stdout}")
    except subprocess.TimeoutExpired:
        print("   å‘½ä»¤æ‰§è¡Œè¶…æ—¶")

    # 2. Popen çš„è¶…æ—¶æ§åˆ¶
    print("\n2. Popen è¶…æ—¶æ§åˆ¶:")
    process = subprocess.Popen(
        ['python', '-c', '''
import time
print("Starting long task...")
for i in range(10):
    print(f"Step {i+1}")
    time.sleep(1)
print("Task completed")'''],
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        text=True
    )

    try:
        stdout, stderr = process.communicate(timeout=3)
        print(f"   è¾“å‡º: {stdout}")
    except subprocess.TimeoutExpired:
        print("   è¿›ç¨‹è¶…æ—¶ï¼Œæ­£åœ¨ç»ˆæ­¢...")
        process.kill()  # ç»ˆæ­¢è¿›ç¨‹
        stdout, stderr = process.communicate()  # æ¸…ç†ç¼“å†²åŒº
        print("   è¿›ç¨‹å·²ç»ˆæ­¢")

def advanced_subprocess_demo():
    """é«˜çº§subprocessåŠŸèƒ½æ¼”ç¤º"""
    error_handling_demo()
    timeout_demo()

if __name__ == '__main__':
    advanced_subprocess_demo()
```

## æ€»ç»“

åœ¨ç¬¬äºŒéƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬æ·±å…¥å­¦ä¹ äº†Pythonå¤šè¿›ç¨‹ç¼–ç¨‹çš„æ‰€æœ‰å…³é”®æ¦‚å¿µï¼š

1. **è¿›ç¨‹åŸºç¡€ç†è®º**ï¼šè¿›ç¨‹çš„å®šä¹‰ã€ç»„æˆã€çŠ¶æ€è½¬æ¢å’Œè°ƒåº¦ç®—æ³•
2. **ç‰¹æ®Šè¿›ç¨‹ç±»å‹**ï¼šå­¤å„¿è¿›ç¨‹ã€åƒµå°¸è¿›ç¨‹ã€å®ˆæŠ¤è¿›ç¨‹çš„æ·±å…¥åˆ†æ
3. **è¿›ç¨‹åˆ›å»ºä¸ç®¡ç†**ï¼šos.fork()å’Œmultiprocessingæ¨¡å—çš„å…¨é¢ä½¿ç”¨
4. **è¿›ç¨‹é—´é€šä¿¡**ï¼šQueueã€Pipeç­‰é€šä¿¡æœºåˆ¶å’ŒåŒæ­¥åŸè¯­
5. **é«˜çº§è¿›ç¨‹ç®¡ç†**ï¼šè¿›ç¨‹æ± å’Œsubprocessæ¨¡å—çš„å®é™…åº”ç”¨

# ç¬¬ä¸‰éƒ¨åˆ†ï¼šå¤šçº¿ç¨‹

## 8. çº¿ç¨‹åŸºç¡€ç†è®º

### 8.1 çº¿ç¨‹çš„å®šä¹‰ä¸ç‰¹ç‚¹

**çº¿ç¨‹ï¼ˆThreadï¼‰**æ˜¯è¿›ç¨‹å†…éƒ¨çš„æœ€å°æ‰§è¡Œå•å…ƒï¼Œæ˜¯æ“ä½œç³»ç»Ÿè°ƒåº¦å’Œæ‰§è¡Œçš„åŸºæœ¬å•ä½ã€‚ä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹å…±äº«è¿›ç¨‹çš„èµ„æºã€‚

```mermaid
graph TD
    A[è¿›ç¨‹ Process] --> B[ä¸»çº¿ç¨‹ Main Thread]
    A --> C[å·¥ä½œçº¿ç¨‹1 Worker Thread 1]
    A --> D[å·¥ä½œçº¿ç¨‹2 Worker Thread 2]
    A --> E[å·¥ä½œçº¿ç¨‹3 Worker Thread 3]

    F[å…±äº«èµ„æº] --> G[å†…å­˜ç©ºé—´]
    F --> H[æ–‡ä»¶æè¿°ç¬¦]
    F --> I[å…¨å±€å˜é‡]
    F --> J[å †å†…å­˜]

    B --- F
    C --- F
    D --- F
    E --- F

    K[ç‹¬ç«‹èµ„æº] --> L[ç¨‹åºè®¡æ•°å™¨]
    K --> M[å¯„å­˜å™¨]
    K --> N[å †æ ˆç©ºé—´]

    B --- K
    C --- K
    D --- K
    E --- K

    style F fill:#ccffcc
    style K fill:#ffffcc
```

#### 8.1.1 çº¿ç¨‹çš„ä¸»è¦ç‰¹ç‚¹

**ä¼˜ç‚¹**ï¼š
- **è½»é‡çº§**ï¼šåˆ›å»ºå’Œé”€æ¯å¼€é”€æ¯”è¿›ç¨‹å°
- **èµ„æºå…±äº«**ï¼šçº¿ç¨‹é—´å¯ä»¥é«˜æ•ˆå…±äº«æ•°æ®
- **å“åº”æ€§å¥½**ï¼šé€‚åˆI/Oå¯†é›†å‹ä»»åŠ¡ï¼Œå¯æé«˜ç¨‹åºå“åº”æ€§
- **ä¸Šä¸‹æ–‡åˆ‡æ¢å¿«**ï¼šçº¿ç¨‹é—´åˆ‡æ¢æ¯”è¿›ç¨‹åˆ‡æ¢æ›´å¿«

**ç¼ºç‚¹**ï¼š
- **æ•°æ®ç«äº‰**ï¼šéœ€è¦åŒæ­¥æœºåˆ¶é˜²æ­¢æ•°æ®ä¸ä¸€è‡´
- **è°ƒè¯•å›°éš¾**ï¼šå¤šçº¿ç¨‹ç¨‹åºéš¾ä»¥è°ƒè¯•å’Œæµ‹è¯•
- **GILé™åˆ¶**ï¼šåœ¨Pythonä¸­å—å…¨å±€è§£é‡Šå™¨é”å½±å“
- **æ­»é”é£é™©**ï¼šä¸å½“çš„åŒæ­¥å¯èƒ½å¯¼è‡´æ­»é”

#### 8.1.2 çº¿ç¨‹ vs è¿›ç¨‹è¯¦ç»†å¯¹æ¯”

```mermaid
graph TD
    A[çº¿ç¨‹ vsè¿›ç¨‹å¯¹æ¯”] --> B[èµ„æºå ç”¨]
    A --> C[é€šä¿¡æ–¹å¼]
    A --> D[å®‰å…¨æ€§]
    A --> E[æ‰©å±•æ€§]

    B --> B1[çº¿ç¨‹: å…±äº«å†…å­˜ç©ºé—´<br/>å¼€é”€å°ï¼Œåˆ›å»ºå¿«]
    B --> B2[è¿›ç¨‹: ç‹¬ç«‹å†…å­˜ç©ºé—´<br/>å¼€é”€å¤§ï¼Œåˆ›å»ºæ…¢]

    C --> C1[çº¿ç¨‹: å…±äº«å†…å­˜<br/>é«˜æ•ˆï¼Œä½†éœ€è¦åŒæ­¥]
    C --> C2[è¿›ç¨‹: IPCæœºåˆ¶<br/>å®‰å…¨ï¼Œä½†å¤æ‚ä¸”æ…¢]

    D --> D1[çº¿ç¨‹: ä¸€ä¸ªçº¿ç¨‹å´©æºƒ<br/>å¯èƒ½å½±å“æ•´ä¸ªè¿›ç¨‹]
    D --> D2[è¿›ç¨‹: è¿›ç¨‹é—´éš”ç¦»<br/>ä¸€ä¸ªå´©æºƒä¸å½±å“å…¶ä»–]

    E --> E1[çº¿ç¨‹: å—GILé™åˆ¶<br/>CPUå¯†é›†å‹ä¸èƒ½çœŸæ­£å¹¶è¡Œ]
    E --> E2[è¿›ç¨‹: çœŸæ­£å¹¶è¡Œ<br/>èƒ½å……åˆ†åˆ©ç”¨å¤šæ ¸CPU]

    style B1 fill:#ffffcc
    style B2 fill:#ffcccc
    style C1 fill:#ccffcc
    style C2 fill:#ffffcc
```

| ç‰¹æ€§ | çº¿ç¨‹ | è¿›ç¨‹ |
|:---|:---|:---|
| å†…å­˜å…±äº« | å…±äº«è¿›ç¨‹å†…å­˜ | ç‹¬ç«‹å†…å­˜ç©ºé—´ |
| åˆ›å»ºå¼€é”€ | å° | å¤§ |
| é€šä¿¡æ•ˆç‡ | é«˜ï¼ˆå…±äº«å†…å­˜ï¼‰ | ä½ï¼ˆIPCï¼‰ |
| åŒæ­¥å¤æ‚åº¦ | é«˜ | ä½ |
| è°ƒè¯•éš¾åº¦ | å›°éš¾ | ç›¸å¯¹ç®€å• |
| é”™è¯¯éš”ç¦» | å·® | å¥½ |
| é€‚ç”¨åœºæ™¯ | I/Oå¯†é›†å‹ | CPUå¯†é›†å‹ |

### 8.2 çº¿ç¨‹çŠ¶æ€ä¸ç”Ÿå‘½å‘¨æœŸ

çº¿ç¨‹åœ¨å…¶ç”Ÿå‘½å‘¨æœŸä¸­ä¼šç»å†å¤šä¸ªçŠ¶æ€çš„è½¬æ¢ï¼š

```mermaid
stateDiagram-v2
    [*] --> æ–°å»º: åˆ›å»ºçº¿ç¨‹å¯¹è±¡
    æ–°å»º --> å°±ç»ª: start()
    å°±ç»ª --> è¿è¡Œ: è·å¾—CPUæ—¶é—´ç‰‡
    è¿è¡Œ --> å°±ç»ª: æ—¶é—´ç‰‡è€—å°½/yield()
    è¿è¡Œ --> é˜»å¡: ç­‰å¾…I/Oæˆ–åŒæ­¥åŸè¯­
    é˜»å¡ --> å°±ç»ª: I/Oå®Œæˆæˆ–è·å¾—èµ„æº
    è¿è¡Œ --> ç»ˆæ­¢: ä»»åŠ¡å®Œæˆæˆ–å¼‚å¸¸
    é˜»å¡ --> ç»ˆæ­¢: è¢«ä¸­æ–­æˆ–å¼ºåˆ¶ç»ˆæ­¢
    ç»ˆæ­¢ --> [*]

    æ–°å»º: New<br/>çº¿ç¨‹å¯¹è±¡å·²åˆ›åºº<br/>ä½†æœªè°ƒç”¨start()
    å°±ç»ª: Runnable<br/>å·²å‡†å¤‡å¥½æ‰§è¡Œ<br/>ç­‰å¾…CPUè°ƒåº¦
    è¿è¡Œ: Running<br/>æ­£åœ¨CPUä¸Šæ‰§è¡Œ<br/>æ‹¥æœ‰æ‰§è¡Œæ—¶é—´
    é˜»å¡: Blocked<br/>ç­‰å¾…èµ„æºæˆ–äº‹ä»¶<br/>æ— æ³•ç»§ç»­æ‰§è¡Œ
    ç»ˆæ­¢: Terminated<br/>çº¿ç¨‹æ‰§è¡Œå®Œæˆ<br/>æˆ–è¢«ç»ˆæ­¢
```

#### 8.2.1 çº¿ç¨‹ä¸»è¦çŠ¶æ€

1. **æ–°å»ºçŠ¶æ€ (New)**ï¼š
   - çº¿ç¨‹å¯¹è±¡å·²åˆ›åººä½†æœªè°ƒç”¨ `start()` æ–¹æ³•
   - æ­¤æ—¶ç³»ç»Ÿè¿˜æ²¡æœ‰ä¸ºè¯¥çº¿ç¨‹åˆ†é…èµ„æº

2. **å°±ç»ªçŠ¶æ€ (Runnable)**ï¼š
   - çº¿ç¨‹å·²å‡†å¤‡å¥½æ‰§è¡Œï¼Œç­‰å¾…CPUè°ƒåº¦
   - å…·å¤‡è¿è¡Œæ¡ä»¶ï¼Œä½†ç”±äºCPUèµ„æºæœ‰é™è€Œç­‰å¾…

3. **è¿è¡ŒçŠ¶æ€ (Running)**ï¼š
   - çº¿ç¨‹æ­£åœ¨CPUä¸Šæ‰§è¡Œ
   - åœ¨å•æ ¸ç³»ç»Ÿä¸Šï¼ŒåŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å¤„äºè¿è¡ŒçŠ¶æ€

4. **é˜»å¡çŠ¶æ€ (Blocked)**ï¼š
   - çº¿ç¨‹å› ç­‰å¾…I/Oæ“ä½œæˆ–è·å–åŒæ­¥èµ„æºè€Œæš‚åœæ‰§è¡Œ
   - åªæœ‰å½“ç­‰å¾…çš„æ¡ä»¶æ»¡è¶³æ—¶ï¼Œçº¿ç¨‹æ‰èƒ½è¿”å›å°±ç»ªçŠ¶æ€

5. **ç»ˆæ­¢çŠ¶æ€ (Terminated)**ï¼š
   - çº¿ç¨‹æ‰§è¡Œå®Œæˆæˆ–è¢«å¼ºåˆ¶ç»ˆæ­¢
   - çº¿ç¨‹èµ„æºå·²è¢«é‡Šæ”¾ï¼Œä¸èƒ½å†æ¬¡å¯åŠ¨

### 8.3 çº¿ç¨‹ä¸è¿›ç¨‹çš„è¯¦ç»†åŒºåˆ«

#### 8.3.1 å†…å­˜æ¨¡å‹å¯¹æ¯”

```mermaid
graph TD
    subgraph å¤šè¿›ç¨‹æ¨¡å‹
        A1[è¿›ç¨‹1]
        A2[è¿›ç¨‹2]
        A3[è¿›ç¨‹3]

        A1 --- B1[ç‹¬ç«‹å†…å­˜ç©ºé—´]
        A2 --- B2[ç‹¬ç«‹å†…å­˜ç©ºé—´]
        A3 --- B3[ç‹¬ç«‹å†…å­˜ç©ºé—´]

        B1 --> C1[å…¨å±€å˜é‡å‰¯æœ¬]
        B2 --> C2[å…¨å±€å˜é‡å‰¯æœ¬]
        B3 --> C3[å…¨å±€å˜é‡å‰¯æœ¬]
    end

    subgraph å¤šçº¿ç¨‹æ¨¡å‹
        D1[ä¸»çº¿ç¨‹]
        D2[å·¥ä½œçº¿ç¨‹1]
        D3[å·¥ä½œçº¿ç¨‹2]

        D1 --- E[å…±äº«å†…å­˜ç©ºé—´]
        D2 --- E
        D3 --- E

        E --> F[å…±äº«å…¨å±€å˜é‡]
        E --> G[å…±äº«å †å†…å­˜]
        E --> H[å…±äº«æ–‡ä»¶æè¿°ç¬¦]
    end

    style B1 fill:#ffcccc
    style B2 fill:#ffcccc
    style B3 fill:#ffcccc
    style E fill:#ccffcc
```

#### 8.3.2 å®é™…å¯¹æ¯”ç¤ºä¾‹

* è¿›ç¨‹ä¸å¯ä»¥ç›´æ¥ä½¿ç”¨å…¨å±€å˜é‡ï¼

```python
import threading
import multiprocessing
import time
import os

# å…¨å±€å˜é‡
counter = 0
shared_list = []

def thread_worker(worker_id, iterations):
    """çº¿ç¨‹å·¥ä½œå‡½æ•°"""
    global counter, shared_list

    print(f"Thread Worker {worker_id} started - PID: {os.getpid()}, TID: {threading.get_ident()}")

    for i in range(iterations):
        counter += 1
        shared_list.append(f"Thread-{worker_id}-Item-{i+1}")
        time.sleep(0.01)  # æ¨¡æ‹Ÿå·¥ä½œ

    print(f"Thread Worker {worker_id} finished - counter: {counter}, list_size: {len(shared_list)}")

def process_worker(worker_id, iterations):
    """è¿›ç¨‹å·¥ä½œå‡½æ•°"""
    global counter, shared_list

    print(f"Process Worker {worker_id} started - PID: {os.getpid()}")

    for i in range(iterations):
        counter += 1
        shared_list.append(f"Process-{worker_id}-Item-{i+1}")
        time.sleep(0.01)  # æ¨¡æ‹Ÿå·¥ä½œ

    print(f"Process Worker {worker_id} finished - counter: {counter}, list_size: {len(shared_list)}")

def compare_thread_process():
    """å¯¹æ¯”çº¿ç¨‹å’Œè¿›ç¨‹çš„æ•°æ®å…±äº«"""
    global counter, shared_list

    print("=== çº¿ç¨‹ vs è¿›ç¨‹æ•°æ®å…±äº«å¯¹æ¯” ===")
    print(f"Main process PID: {os.getpid()}")

    # é‡ç½®å…¨å±€å˜é‡
    counter = 0
    shared_list = []

    print(f"\nåˆå§‹çŠ¶æ€ - counter: {counter}, shared_list: {len(shared_list)}")

    # 1. å¤šçº¿ç¨‹æµ‹è¯•
    print("\n=== å¤šçº¿ç¨‹æµ‹è¯• ===")
    threads = []
    start_time = time.time()

    for i in range(3):
        t = threading.Thread(target=thread_worker, args=(i+1, 5))
        threads.append(t)
        t.start()

    for t in threads:
        t.join()

    thread_time = time.time() - start_time
    print(f"Thread ç»“æœ - counter: {counter}, shared_list: {len(shared_list)}")
    print(f"Thread è€—æ—¶: {thread_time:.3f}ç§’")
    print(f"Listå†…å®¹å‰5é¡¹: {shared_list[:5]}")

    # é‡ç½®å˜é‡ä¾›è¿›ç¨‹æµ‹è¯•
    counter = 0
    shared_list = []

    # 2. å¤šè¿›ç¨‹æµ‹è¯•
    print("\n=== å¤šè¿›ç¨‹æµ‹è¯• ===")
    processes = []
    start_time = time.time()

    for i in range(3):
        p = multiprocessing.Process(target=process_worker, args=(i+1, 5))
        processes.append(p)
        p.start()

    for p in processes:
        p.join()

    process_time = time.time() - start_time
    print(f"Process ç»“æœ - counter: {counter}, shared_list: {len(shared_list)}")
    print(f"Process è€—æ—¶: {process_time:.3f}ç§’")

    # æ€»ç»“
    print("\n=== å¯¹æ¯”ç»“æœ ===")
    print(f"Thread: æ•°æ®å…±äº«ï¼Œ3ä¸ªçº¿ç¨‹ä¿®æ”¹åŒä¸€ä¸ªå…¨å±€å˜é‡")
    print(f"Process: æ•°æ®éš”ç¦»ï¼Œ3ä¸ªè¿›ç¨‹å„è‡ªæœ‰ç‹¬ç«‹çš„å˜é‡å‰¯æœ¬")
    print(f"Thread æ€§èƒ½: {thread_time:.3f}s, Process æ€§èƒ½: {process_time:.3f}s")

if __name__ == '__main__':
    compare_thread_process()
```

## 9. çº¿ç¨‹åˆ›å»ºä¸ç®¡ç†

### 9.1 threading æ¨¡å—åŸºç¡€

Pythonçš„`threading`æ¨¡å—æä¾›äº†é«˜çº§çš„çº¿ç¨‹æ¥å£ï¼Œæ˜¯è¿›è¡Œå¤šçº¿ç¨‹ç¼–ç¨‹çš„ä¸»è¦å·¥å…·ã€‚

#### 9.1.1 åŸºç¡€çº¿ç¨‹åˆ›å»ºä»¥åŠå‚æ•°ä¼ é€’

* å¸¦å‚æ•°çš„ä»»åŠ¡ä¼ é€’çš„æ–¹å¼å’Œè¿›ç¨‹ç±»ä¼¼

```python
import threading
import time
import os

def simple_task():
    """ç®€å•çš„çº¿ç¨‹ä»»åŠ¡"""
    thread_name = threading.current_thread().name
    process_id = os.getpid()
    thread_id = threading.get_ident()

    print(f"{thread_name} å¼€å§‹æ‰§è¡Œ - PID: {process_id}, TID: {thread_id}")

    for i in range(5):
        print(f"{thread_name}: æ­¥éª¤ {i+1}")
        time.sleep(0.5)

    print(f"{thread_name} æ‰§è¡Œå®Œæˆ")

def basic_threading_demo():
    """åŸºç¡€çº¿ç¨‹æ¼”ç¤º"""
    print("=== åŸºç¡€çº¿ç¨‹åˆ›å»ºæ¼”ç¤º ===")
    print(f"ä¸»çº¿ç¨‹: {threading.current_thread().name} - PID: {os.getpid()}")

    # æ–¹æ³•1: ä½¿ç”¨Threadç±»
    thread1 = threading.Thread(target=simple_task, name="Worker-1")
    thread2 = threading.Thread(target=simple_task, name="Worker-2")

    print("\nå¯åŠ¨çº¿ç¨‹...")
    thread1.start()
    thread2.start()

    print("ä¸»çº¿ç¨‹ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡...")
    time.sleep(1)

    print("ä¸»çº¿ç¨‹ç­‰å¾…å­çº¿ç¨‹å®Œæˆ...")
    thread1.join()
    thread2.join()

    print("æ‰€æœ‰çº¿ç¨‹å·²å®Œæˆ")

def task_with_parameters(name, count, delay):
    """å¸¦å‚æ•°çš„ä»»åŠ¡"""
    for i in range(count):
        print(f"{name}: ç¬¬{i+1}æ¬¡æ‰§è¡Œ")
        time.sleep(delay)
    return f"{name} å®Œæˆ {count} æ¬¡ä»»åŠ¡"

def threading_with_params():
    """å¸¦å‚æ•°çš„çº¿ç¨‹ç¤ºä¾‹"""
    print("\n=== å¸¦å‚æ•°çš„çº¿ç¨‹ ===")

    threads = []

    # ä½¿ç”¨argsä¼ é€’ä½ç½®å‚æ•°
    t1 = threading.Thread(
        target=task_with_parameters,
        args=("Task-A", 3, 0.5),
        name="Thread-A"
    )

    # ä½¿ç”¨kwargsä¼ é€’å…³é”®å­—å‚æ•°
    t2 = threading.Thread(
        target=task_with_parameters,
        kwargs={"name": "Task-B", "count": 4, "delay": 0.3},
        name="Thread-B"
    )

    # æ··åˆä½¿ç”¨
    t3 = threading.Thread(
        target=task_with_parameters,
        args=("Task-C", 2),
        kwargs={"delay": 0.8},
        name="Thread-C"
    )

    threads = [t1, t2, t3]

    # å¯åŠ¨æ‰€æœ‰çº¿ç¨‹
    for t in threads:
        t.start()

    # ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
    for t in threads:
        t.join()

    print("æ‰€æœ‰å¸¦å‚æ•°çš„çº¿ç¨‹å·²å®Œæˆ")

if __name__ == '__main__':
    basic_threading_demo()
    threading_with_params()
```

#### 9.1.2 Threadç±»çš„å±æ€§å’Œæ–¹æ³•

| æ–¹æ³•                 | å‚æ•°           | è¯´æ˜                                               |
| -------------------- | -------------- | -------------------------------------------------- |
| `start()`            | æ—              | å¯åŠ¨çº¿ç¨‹ï¼Œè°ƒç”¨ç›®æ ‡å‡½æ•°                             |
| `join(timeout=None)` | timeout: float | ç­‰å¾…çº¿ç¨‹å®Œæˆï¼Œå¯è®¾ç½®è¶…æ—¶æ—¶é—´                       |
| `run()`              | æ—              | çº¿ç¨‹æ‰§è¡Œçš„æ–¹æ³•ï¼Œé€šå¸¸ä¸ç›´æ¥è°ƒç”¨ï¼Œ`start()` ä¼šè°ƒç”¨å®ƒ |
| `is_alive()`         | æ—              | åˆ¤æ–­çº¿ç¨‹æ˜¯å¦ä»åœ¨è¿è¡Œ                               |
| `setName(name)`      | name: str      | è®¾ç½®çº¿ç¨‹åç§°ï¼ˆä¹Ÿå¯ç›´æ¥ `t.name = "XXX"`ï¼‰          |
| `getName()`          | æ—              | è·å–çº¿ç¨‹åç§°ï¼ˆä¹Ÿå¯ç›´æ¥ `t.name`ï¼‰                  |
| `daemon`             | True/False     | è®¾ç½®çº¿ç¨‹ä¸ºå®ˆæŠ¤çº¿ç¨‹ï¼ˆå¿…é¡»åœ¨ `start()` å‰è®¾ç½®ï¼‰      |

| å‡½æ•°                         | è¯´æ˜                                      |
| ---------------------------- | ----------------------------------------- |
| `threading.current_thread()` | è·å–å½“å‰çº¿ç¨‹å¯¹è±¡                          |
| `threading.main_thread()`    | è·å–ä¸»çº¿ç¨‹å¯¹è±¡                            |
| `threading.active_count()`   | å½“å‰æ´»è·ƒçº¿ç¨‹æ•°                            |
| `threading.enumerate()`      | è¿”å›æ‰€æœ‰æ´»è·ƒçº¿ç¨‹åˆ—è¡¨                      |
| `threading.get_ident()`      | è·å–å½“å‰çº¿ç¨‹ IDï¼ˆä¸ `thread.ident` ç±»ä¼¼ï¼‰ |

```python
import threading
import time
import random

def demonstrate_thread_methods():
    """æ¼”ç¤ºThreadç±»çš„å„ç§æ–¹æ³•å’Œå±æ€§"""
    print("=== Threadç±»æ–¹æ³•å’Œå±æ€§æ¼”ç¤º ===")

    def worker_task(task_id, work_time):
        """Workerä»»åŠ¡"""
        thread = threading.current_thread()
        print(f"Task {task_id} å¼€å§‹ - Thread: {thread.name} (ID: {thread.ident})")

        for i in range(work_time):
            if not thread.is_alive():
                print(f"Task {task_id} è¢«ç»ˆæ­¢")
                break

            print(f"Task {task_id} å·¥ä½œä¸­... {i+1}/{work_time}")
            time.sleep(1)

        print(f"Task {task_id} å®Œæˆ")

    # åˆ›å»ºçº¿ç¨‹
    threads = []
    for i in range(3):
        t = threading.Thread(
            target=worker_task,
            args=(i+1, random.randint(3, 6)),
            name=f"Worker-{i+1}"
        )
        threads.append(t)

    # æ˜¾ç¤ºçº¿ç¨‹åˆ›å»ºåçš„çŠ¶æ€
    print("\nçº¿ç¨‹åˆ›å»ºåçš„çŠ¶æ€:")
    for t in threads:
        print(f"  {t.name}: is_alive={t.is_alive()}, daemon={t.daemon}, ident={t.ident}")

    # å¯åŠ¨çº¿ç¨‹
    print("\nå¯åŠ¨æ‰€æœ‰çº¿ç¨‹...")
    for t in threads:
        t.start()
        print(f"  å¯åŠ¨: {t.name} (ID: {t.ident})")

    # æ˜¾ç¤ºå¯åŠ¨åçš„çŠ¶æ€
    print("\nçº¿ç¨‹å¯åŠ¨åçš„çŠ¶æ€:")
    for t in threads:
        print(f"  {t.name}: is_alive={t.is_alive()}, ident={t.ident}")

    # ç›‘æ§çº¿ç¨‹æ‰§è¡Œ
    print("\nç›‘æ§çº¿ç¨‹æ‰§è¡Œ:")
    while any(t.is_alive() for t in threads):
        alive_threads = [t.name for t in threads if t.is_alive()]
        print(f"  æ´»è·ƒçº¿ç¨‹: {alive_threads} (Total: {threading.active_count()})")
        time.sleep(1)

    print("\næ‰€æœ‰çº¿ç¨‹æ‰§è¡Œå®Œæˆ")

    # æ˜¾ç¤ºæœ€ç»ˆçŠ¶æ€
    print("\næœ€ç»ˆçŠ¶æ€:")
    for t in threads:
        print(f"  {t.name}: is_alive={t.is_alive()}")

def demonstrate_thread_info():
    """æ¼”ç¤ºçº¿ç¨‹ä¿¡æ¯è·å–"""
    print("\n=== çº¿ç¨‹ä¿¡æ¯è·å– ===")

    def info_task():
        """Display thread information"""
        current = threading.current_thread()
        main = threading.main_thread()

        print(f"\nå½“å‰çº¿ç¨‹ä¿¡æ¯:")
        print(f"  åç§°: {current.name}")
        print(f"  ID: {current.ident}")
        print(f"  æ˜¯å¦å®ˆæŠ¤çº¿ç¨‹: {current.daemon}")
        print(f"  æ˜¯å¦æ´»è·ƒ: {current.is_alive()}")

        print(f"\nä¸»çº¿ç¨‹ä¿¡æ¯:")
        print(f"  åç§°: {main.name}")
        print(f"  ID: {main.ident}")
        print(f"  æ˜¯å¦æ´»è·ƒ: {main.is_alive()}")

        print(f"\nç³»ç»Ÿä¿¡æ¯:")
        print(f"  æ´»è·ƒçº¿ç¨‹æ•°: {threading.active_count()}")
        print(f"  æ‰€æœ‰çº¿ç¨‹: {[t.name for t in threading.enumerate()]}")

    # åˆ›å»ºä¿¡æ¯æ˜¾ç¤ºçº¿ç¨‹
    info_thread = threading.Thread(target=info_task, name="InfoThread")
    info_thread.start()
    info_thread.join()

if __name__ == '__main__':
    demonstrate_thread_methods()
    demonstrate_thread_info()
```

### 9.2 è‡ªå®šä¹‰çº¿ç¨‹ç±»

#### 9.2.1 ç»§æ‰¿Threadç±»

* é‡å†™runå®ç°æ›´å¤šè‡ªå®šä¹‰åŠŸèƒ½ï¼ˆå’Œé‡å†™è¿›ç¨‹ç±»ä¼¼ï¼‰

```python
import threading
import time
import queue
import random

class WorkerThread(threading.Thread):
    """è‡ªå®šä¹‰å·¥ä½œçº¿ç¨‹ç±»"""

    def __init__(self, name, task_queue, result_queue):
        super().__init__(name=name)
        self.task_queue = task_queue
        self.result_queue = result_queue
        self.running = True

    def run(self):
        """Override run method"""
        print(f"{self.name} å¼€å§‹å·¥ä½œ")

        while self.running:
            try:
                # ä»ä»»åŠ¡é˜Ÿåˆ—è·å–ä»»åŠ¡
                task = self.task_queue.get(timeout=1)

                if task is None:  # ç»ˆæ­¢ä¿¡å·
                    print(f"{self.name} æ”¶åˆ°ç»ˆæ­¢ä¿¡å·")
                    break

                # æ‰§è¡Œä»»åŠ¡
                result = self.process_task(task)

                # å°†ç»“æœæ”¾å…¥ç»“æœé˜Ÿåˆ—
                self.result_queue.put(result)

                # æ ‡è®°ä»»åŠ¡å®Œæˆ
                self.task_queue.task_done()

            except queue.Empty:
                # è¶…æ—¶æ— ä»»åŠ¡ï¼Œç»§ç»­ç­‰å¾…
                continue
            except Exception as e:
                print(f"{self.name} å‡ºç°é”™è¯¯: {e}")
                self.result_queue.put(f"Error: {e}")
                if not self.task_queue.empty():
                    self.task_queue.task_done()

        print(f"{self.name} å·¥ä½œç»“æŸ")

    def process_task(self, task):
        """å¤„ç†å…·ä½“ä»»åŠ¡"""
        task_id, data = task
        print(f"{self.name} å¤„ç†ä»»åŠ¡ {task_id}: {data}")

        # æ¨¡æ‹Ÿå¤„ç†æ—¶é—´
        processing_time = random.uniform(0.5, 2.0)
        time.sleep(processing_time)

        # è¿”å›ç»“æœ
        result = {
            'task_id': task_id,
            'input_data': data,
            'result': data * 2 if isinstance(data, (int, float)) else f"Processed: {data}",
            'processing_time': processing_time,
            'worker': self.name
        }

        return result

    def stop(self):
        """åœæ­¢çº¿ç¨‹"""
        self.running = False

class TaskManager(threading.Thread):
    """ä»»åŠ¡ç®¡ç†å™¨çº¿ç¨‹"""

    def __init__(self, task_queue, result_queue, total_tasks):
        super().__init__(name="TaskManager")
        self.task_queue = task_queue
        self.result_queue = result_queue
        self.total_tasks = total_tasks
        self.completed_tasks = 0

    def run(self):
        """Run task manager"""
        print(f"{self.name} å¼€å§‹ç›‘æ§ä»»åŠ¡")

        while self.completed_tasks < self.total_tasks:
            try:
                result = self.result_queue.get(timeout=1)
                self.completed_tasks += 1

                print(f"{self.name} æ”¶åˆ°ç»“æœ {self.completed_tasks}/{self.total_tasks}: "
                      f"Task {result['task_id']} by {result['worker']}")

                self.result_queue.task_done()

            except queue.Empty:
                continue

        print(f"{self.name} æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆ")

def custom_thread_demo():
    """è‡ªå®šä¹‰çº¿ç¨‹æ¼”ç¤º"""
    print("=== è‡ªå®šä¹‰çº¿ç¨‹æ¼”ç¤º ===")

    # åˆ›å»ºé˜Ÿåˆ—
    task_queue = queue.Queue()
    result_queue = queue.Queue()

    # å‡†å¤‡ä»»åŠ¡
    tasks = [
        (1, 10),
        (2, "Hello"),
        (3, 3.14),
        (4, "World"),
        (5, 42),
        (6, "Python"),
        (7, 100),
        (8, "Threading")
    ]

    # å°†ä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—
    for task in tasks:
        task_queue.put(task)

    # åˆ›å»ºå·¥ä½œçº¿ç¨‹
    workers = []
    for i in range(3):
        worker = WorkerThread(f"Worker-{i+1}", task_queue, result_queue)
        workers.append(worker)
        worker.start()

    # åˆ›å»ºä»»åŠ¡ç®¡ç†å™¨
    manager = TaskManager(task_queue, result_queue, len(tasks))
    manager.start()

    # ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
    task_queue.join()

    # åœæ­¢å·¥ä½œçº¿ç¨‹
    for worker in workers:
        worker.stop()
        task_queue.put(None)  # å‘é€ç»ˆæ­¢ä¿¡å·

    # ç­‰å¾…æ‰€æœ‰çº¿ç¨‹ç»“æŸ
    for worker in workers:
        worker.join()
    manager.join()

    print("è‡ªå®šä¹‰çº¿ç¨‹æ¼”ç¤ºå®Œæˆ")

if __name__ == '__main__':
    custom_thread_demo()
```

### 9.3 å®ˆæŠ¤çº¿ç¨‹

å®ˆæŠ¤çº¿ç¨‹ï¼ˆDaemon Threadï¼‰æ˜¯ä¸€ç§åœ¨åå°è¿è¡Œçš„çº¿ç¨‹ï¼Œå½“æ‰€æœ‰éå®ˆæŠ¤çº¿ç¨‹ç»“æŸæ—¶ï¼Œå®ˆæŠ¤çº¿ç¨‹ä¼šè‡ªåŠ¨ç»ˆæ­¢ã€‚

#### 9.3.1 å®ˆæŠ¤çº¿ç¨‹ç‰¹ç‚¹

1. **ç”Ÿå‘½å‘¨æœŸ**ï¼š 
   - ä¸ä¸»çº¿ç¨‹åŒæ­¥å¯åŠ¨ã€‚
   - éšä¸»çº¿ç¨‹ç»“æŸè€Œç»ˆæ­¢ï¼Œæ— æ³•ç‹¬ç«‹å­˜åœ¨ã€‚
2. **è‡ªåŠ¨ç»ˆæ­¢** ï¼šå½“ç¨‹åºä¸­æ‰€æœ‰éå®ˆæŠ¤çº¿ç¨‹ç»“æŸæ—¶ï¼Œç¨‹åºä¸ä¼šç­‰å¾…å®ˆæŠ¤çº¿ç¨‹å®Œæˆï¼Œå®ˆæŠ¤çº¿ç¨‹ä¼šè¢«å¼ºåˆ¶ç»ˆæ­¢ã€‚
3. **åå°è¿è¡Œ**ï¼š åœ¨åå°æ‰§è¡Œï¼Œä¸å ç”¨ç»ˆç«¯ï¼Œä¹Ÿä¸ä¼šå½±å“ç”¨æˆ·äº¤äº’ã€‚
4. **ä¾èµ–ä¸»çº¿ç¨‹**ï¼š æ— æ³•ç‹¬ç«‹å­˜åœ¨ï¼Œä¸»ç¨‹åºç»“æŸæ—¶ï¼Œå®ˆæŠ¤çº¿ç¨‹ä¼šè¢«å¼ºåˆ¶ç»“æŸã€‚

#### 9.3.2 å®ˆæŠ¤çº¿ç¨‹ç¤ºä¾‹

* å®ˆæŠ¤çº¿ç¨‹ä¼šéšç€ä¸»çº¿ç¨‹ç»“æŸå¼ºåˆ¶ç»“æŸ
* ä¸»çº¿ç¨‹ä¼šç­‰å¾…å­çº¿ç¨‹

```python
import threading
import time

def daemon_task():
    """å®ˆæŠ¤çº¿ç¨‹ä»»åŠ¡"""
    count = 0
    while True:
        count += 1
        print(f"Daemon thread æ­£åœ¨è¿è¡Œ... è®¡æ•°: {count}")
        time.sleep(1)

        # æ­£å¸¸æƒ…å†µä¸‹è¿™ä¸ªå¾ªç¯ä¸ä¼šé€€å‡º
        if count > 20:  # ä»…ä¸ºé˜²æ­¢æ— é™è¿è¡Œ
            print("Daemon thread è¶…è¿‡æœ€å¤§è®¡æ•°ï¼Œé€€å‡º")
            break

def regular_task():
    """æ™®é€šçº¿ç¨‹ä»»åŠ¡"""
    for i in range(5):
        print(f"Regular thread æ­¥éª¤ {i+1}/5")
        time.sleep(1)
    print("Regular thread å®Œæˆ")

def daemon_thread_demo():
    """å®ˆæŠ¤çº¿ç¨‹æ¼”ç¤º"""
    print("=== å®ˆæŠ¤çº¿ç¨‹æ¼”ç¤º ===")

    # åˆ›å»ºå®ˆæŠ¤çº¿ç¨‹
    daemon_thread = threading.Thread(target=daemon_task, name="DaemonThread")
    daemon_thread.daemon = True  # è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹

    # åˆ›å»ºæ™®é€šçº¿ç¨‹
    regular_thread = threading.Thread(target=regular_task, name="RegularThread")

    print(f"Daemon thread daemon: {daemon_thread.daemon}")
    print(f"Regular thread daemon: {regular_thread.daemon}")

    # å¯åŠ¨çº¿ç¨‹
    daemon_thread.start()
    regular_thread.start()

    print("ä¸»çº¿ç¨‹ç­‰å¾…æ™®é€šçº¿ç¨‹ç»“æŸ...")
    regular_thread.join()  # åªç­‰å¾…æ™®é€šçº¿ç¨‹

    print("ä¸»çº¿ç¨‹å³å°†ç»“æŸï¼Œå®ˆæŠ¤çº¿ç¨‹ä¹Ÿä¼šè‡ªåŠ¨ç»ˆæ­¢")
    time.sleep(1)  # ç­‰å¾…1ç§’çœ‹å®ˆæŠ¤çº¿ç¨‹çš„æœ€åè¾“å‡º
    print("ä¸»çº¿ç¨‹ç»“æŸ")

def daemon_vs_regular():
    """å®ˆæŠ¤çº¿ç¨‹ vs æ™®é€šçº¿ç¨‹å¯¹æ¯”"""
    print("\n=== å®ˆæŠ¤çº¿ç¨‹ vs æ™®é€šçº¿ç¨‹å¯¹æ¯” ===")

    def long_running_task(name, is_daemon=False):
        """Long running task"""
        thread_type = "Daemon" if is_daemon else "Regular"
        for i in range(10):
            print(f"{thread_type} thread {name} - æ­¥éª¤ {i+1}/10")
            time.sleep(0.5)
        print(f"{thread_type} thread {name} å®Œæˆ")

    # åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹
    regular = threading.Thread(target=long_running_task, args=("A", False), name="Regular-A")
    daemon = threading.Thread(target=long_running_task, args=("B", True), name="Daemon-B")
    daemon.daemon = True

    # å¯åŠ¨çº¿ç¨‹
    regular.start()
    daemon.start()

    print("ä¸»çº¿ç¨‹ç­‰å¾…2ç§’åç»“æŸ...")
    time.sleep(2)
    print("ä¸»çº¿ç¨‹ç»“æŸ - å®ˆæŠ¤çº¿ç¨‹ä¹Ÿä¼šè¢«å¼ºåˆ¶ç»ˆæ­¢")

    # å­çº¿ç¨‹æ²¡æœ‰ç»“æŸæ‰€ä»¥ä¸»çº¿ç¨‹ä¹Ÿä¸ä¼šç»“æŸ

if __name__ == '__main__':
    # daemon_thread_demo()
    daemon_vs_regular()
```

## 10. çº¿ç¨‹åŒæ­¥ä¸å®‰å…¨

### 10.1 çº¿ç¨‹é”æœºåˆ¶è¯¦è§£

åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œå½“å¤šä¸ªçº¿ç¨‹è®¿é—®å…±äº«èµ„æºæ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚é”æ˜¯è§£å†³è¿™ä¸ªé—®é¢˜çš„ä¸»è¦æ‰‹æ®µã€‚

```mermaid
graph TD
    A[çº¿ç¨‹åŒæ­¥åŸè¯­] --> B[Lock äº’æ–¥é”]
    A --> C[RLock é€’å½’é”]
    A --> D[Semaphore ä¿¡å·é‡]
    A --> E[Event äº‹ä»¶]
    A --> F[Condition æ¡ä»¶å˜é‡]

    B --> B1[æœ€åŸºç¡€çš„é”<br/>äº’æ–¥è®¿é—®å…±äº«èµ„æº]
    C --> C1[å¯é‡å…¥é”<br/>åŒä¸€çº¿ç¨‹å¯å¤šæ¬¡è·å–]
    D --> D1[æ§åˆ¶è®¿é—®èµ„æºçš„æ•°é‡<br/>å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®]
    E --> E1[çº¿ç¨‹é—´äº‹ä»¶é€šçŸ¥<br/>ä¸€ä¸ªçº¿ç¨‹é€šçŸ¥å¤šä¸ªçº¿ç¨‹]
    F --> F1[å¤æ‚çš„åŒæ­¥æœºåˆ¶<br/>å…è®¸çº¿ç¨‹ç­‰å¾…ç‰¹å®šæ¡ä»¶]

    style B1 fill:#ccffcc
    style C1 fill:#ffffcc
    style D1 fill:#ffcccc
    style E1 fill:#ffddcc
    style F1 fill:#ddffff
```

#### 10.1.1 Lock äº’æ–¥é”

`threading.Lock()` æ˜¯**æ™®é€šäº’æ–¥é”**ã€‚

**ç‰¹ç‚¹**ï¼š

- åŒä¸€æ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è·å¾—é”ã€‚
- **ä¸å…è®¸åŒä¸€ä¸ªçº¿ç¨‹é‡å¤è·å¾—**ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹å·²ç»æŒæœ‰é”ï¼Œå†æ¬¡å°è¯•è·å–ä¼šé˜»å¡ï¼ˆå¯èƒ½å¯¼è‡´æ­»é”ï¼‰ã€‚

**åº”ç”¨åœºæ™¯**ï¼š

- ç”¨äºä¿æŠ¤å…±äº«èµ„æºï¼ˆä¾‹å¦‚è®¡æ•°å™¨ã€åˆ—è¡¨ã€å­—å…¸ï¼‰ä¸è¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹ï¼Œé¿å…ç«æ€æ¡ä»¶ã€‚

```python
import threading
import time
import random

def demonstrate_race_condition():
    """æ¼”ç¤ºç«æ€æ¡ä»¶é—®é¢˜"""
    print("=== ç«æ€æ¡ä»¶é—®é¢˜æ¼”ç¤º ===")

    # å…±äº«èµ„æº
    shared_counter = {'value': 0}
    shared_list = []

    def unsafe_increment(thread_id, iterations):
        """Unsafe increment operation"""
        for i in range(iterations):
            # è¯»å–ã€ä¿®æ”¹ã€å†™å…¥æ“ä½œä¸æ˜¯åŸå­çš„
            current_value = shared_counter['value']
            time.sleep(0.001)  # æ¨¡æ‹Ÿä¸€äº›å¤„ç†æ—¶é—´
            shared_counter['value'] = current_value + 1
            shared_list.append(f"Thread-{thread_id}-{i+1}")

        print(f"Thread-{thread_id} å®Œæˆï¼Œæœ¬åœ°è®¡æ•°: {iterations}")

    # åˆ›å»ºå¤šä¸ªçº¿ç¨‹
    threads = []
    for i in range(5):
        t = threading.Thread(target=unsafe_increment, args=(i+1, 100))
        threads.append(t)
        t.start()

    # ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
    for t in threads:
        t.join()

    print(f"æœŸæœ›ç»“æœ: 500, å®é™…ç»“æœ: {shared_counter['value']}")
    print(f"List é•¿åº¦: {len(shared_list)}")
    print("é—®é¢˜ï¼šç”±äºç«æ€æ¡ä»¶ï¼Œç»“æœå¯èƒ½ä¸æ­£ç¡®")

def demonstrate_lock_solution():
    """ä½¿ç”¨Lockè§£å†³ç«æ€æ¡ä»¶"""
    print("\n=== ä½¿ç”¨Lockè§£å†³æ–¹æ¡ˆ ===")

    # å…±äº«èµ„æº
    shared_counter = {'value': 0}
    shared_list = []
    lock = threading.Lock()

    def safe_increment(thread_id, iterations):
        """Safe increment with lock"""
        local_count = 0
        for i in range(iterations):
            with lock:  # ä½¿ç”¨ with è¯­å¥è‡ªåŠ¨è·å–å’Œé‡Šæ”¾é”
                current_value = shared_counter['value']
                time.sleep(0.001)  # æ¨¡æ‹Ÿå¤„ç†æ—¶é—´
                shared_counter['value'] = current_value + 1
                shared_list.append(f"Thread-{thread_id}-{i+1}")
                local_count += 1

        print(f"Thread-{thread_id} å®Œæˆï¼Œæœ¬åœ°è®¡æ•°: {local_count}")

    # åˆ›å»ºå¤šä¸ªçº¿ç¨‹
    threads = []
    start_time = time.time()

    for i in range(5):
        t = threading.Thread(target=safe_increment, args=(i+1, 100))
        threads.append(t)
        t.start()

    # ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
    for t in threads:
        t.join()

    end_time = time.time()
    print(f"æœŸæœ›ç»“æœ: 500, å®é™…ç»“æœ: {shared_counter['value']}")
    print(f"List é•¿åº¦: {len(shared_list)}")
    print(f"è€—æ—¶: {end_time - start_time:.3f}ç§’")
    print("ç»“æœï¼šä½¿ç”¨é”åï¼Œç»“æœæ­£ç¡®ä½†æ€§èƒ½é™ä½")

def demonstrate_lock_methods():
    """æ¼”ç¤ºLockçš„ä¸åŒä½¿ç”¨æ–¹æ³•"""
    print("\n=== Lockä½¿ç”¨æ–¹æ³•æ¼”ç¤º ===")

    lock = threading.Lock()
    shared_resource = {'data': 0}

    def method1_with_statement():
        """Method 1: Using with statement (recommended)"""
        thread_name = threading.current_thread().name
        print(f"{thread_name} å°è¯•è·å–é” (with statement)")

        with lock:
            print(f"{thread_name} è·å¾—é”")
            shared_resource['data'] += 10
            time.sleep(0.5)
            print(f"{thread_name} å¤„ç†å®Œæˆï¼Œæ•°æ®: {shared_resource['data']}")
        # è‡ªåŠ¨é‡Šæ”¾é”

        print(f"{thread_name} é‡Šæ”¾é”")

    def method2_acquire_release():
        """Method 2: Manual acquire/release"""
        thread_name = threading.current_thread().name
        print(f"{thread_name} å°è¯•è·å–é” (acquire/release)")

        lock.acquire()
        try:
            print(f"{thread_name} è·å¾—é”")
            shared_resource['data'] += 5
            time.sleep(0.3)
            print(f"{thread_name} å¤„ç†å®Œæˆï¼Œæ•°æ®: {shared_resource['data']}")
        finally:
            lock.release()
            print(f"{thread_name} é‡Šæ”¾é”")

    def method3_timeout():
        """Method 3: Try to acquire with timeout"""
        thread_name = threading.current_thread().name
        print(f"{thread_name} å°è¯•è·å–é” (timeout)")

        if lock.acquire(timeout=1):  # ç­‰å¾…1ç§’
            try:
                print(f"{thread_name} è·å¾—é”")
                shared_resource['data'] += 1
                time.sleep(0.2)
                print(f"{thread_name} å¤„ç†å®Œæˆï¼Œæ•°æ®: {shared_resource['data']}")
            finally:
                lock.release()
                print(f"{thread_name} é‡Šæ”¾é”")
        else:
            print(f"{thread_name} è·å–é”è¶…æ—¶")

    # åˆ›å»ºçº¿ç¨‹æµ‹è¯•ä¸åŒæ–¹æ³•
    threads = [
        threading.Thread(target=method1_with_statement, name="With-Thread"),
        threading.Thread(target=method2_acquire_release, name="Manual-Thread"),
        threading.Thread(target=method3_timeout, name="Timeout-Thread")
    ]

    for t in threads:
        t.start()
        time.sleep(0.1)  # ç¨å¾®é”™å¼€å¯åŠ¨æ—¶é—´

    for t in threads:
        t.join()

    print(f"æœ€ç»ˆæ•°æ®å€¼: {shared_resource['data']}")

if __name__ == '__main__':
    demonstrate_race_condition()
    demonstrate_lock_solution()
    demonstrate_lock_methods()
```

#### 10.1.2 RLock é€’å½’é”

`threading.RLock()`ï¼ˆå¯é‡å…¥é”ï¼‰å…è®¸åŒä¸€ä¸ªçº¿ç¨‹å¤šæ¬¡è·å–åŒä¸€æŠŠé”ï¼Œè€Œä¸ä¼šé˜»å¡è‡ªå·±ã€‚**ä½†**å…¶ä»–çº¿ç¨‹**åœ¨è¯¥é”è¢«æŒæœ‰æœŸé—´ï¼Œ**ä»ç„¶ä¸èƒ½è·å–è¿™æŠŠé”**ï¼Œä¼šé˜»å¡ç­‰å¾…ã€‚

**ç‰¹ç‚¹**ï¼š

- åŒä¸€ä¸ªçº¿ç¨‹å¯ä»¥**å¤šæ¬¡è·å–åŒä¸€æŠŠé”**ï¼Œä¸ä¼šé˜»å¡è‡ªå·±ã€‚
- å†…éƒ¨æœ‰è®¡æ•°å™¨ï¼Œæ¯æ¬¡ `acquire()` å¢åŠ ï¼Œ`release()` å‡å°‘ï¼Œå½“è®¡æ•°å™¨ä¸º 0 æ—¶çœŸæ­£é‡Šæ”¾é”ã€‚

**åº”ç”¨åœºæ™¯**ï¼š

- é€’å½’è°ƒç”¨éœ€è¦è®¿é—®å…±äº«èµ„æºæ—¶ã€‚
- åŒä¸€ä¸ªçº¿ç¨‹è°ƒç”¨å¤šä¸ªæ–¹æ³•ï¼Œæ¯ä¸ªæ–¹æ³•éƒ½éœ€è¦åŠ é”ã€‚

```python
import threading
import time

# åˆ›å»ºé€’å½’é”
rlock = threading.RLock()
counter = 0


def recursive_task(depth):
    global counter
    print(f"{threading.current_thread().name} å°è¯•è·å–é”ï¼Œæ·±åº¦ {depth}")

    with rlock:
        print(f"{threading.current_thread().name} è·å¾—é”ï¼Œæ·±åº¦ {depth}")
        counter += 1
        time.sleep(0.2)

        # é€’å½’è°ƒç”¨è‡ªå·±ï¼Œå†æ¬¡è·å–åŒä¸€æŠŠé”
        if depth < 3:
            recursive_task(depth + 1)

    print(f"{threading.current_thread().name} é‡Šæ”¾é”ï¼Œæ·±åº¦ {depth}")


if __name__ == "__main__":
    t = threading.Thread(target=recursive_task, args=(1,), name="RLockThread")
    t.start()
    t.join()
    print(f"æœ€ç»ˆè®¡æ•°å™¨å€¼: {counter}")

```

### 10.2 æ­»é”é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

æ­»é”æ˜¯å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ä¸€ä¸ªä¸¥é‡çš„é—®é¢˜ï¼Œå‘ç”Ÿåœ¨ä¸¤ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ç›¸äº’ç­‰å¾…å¯¹æ–¹é‡Šæ”¾èµ„æºçš„æƒ…å†µä¸‹ã€‚

#### 10.2.1 æ­»é”çš„ä¸»è¦åŸå› 

1. **äº’æ–¥æ¡ä»¶**
   - èµ„æºä¸€æ¬¡åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹å ç”¨ï¼Œä¾‹å¦‚ Lockã€æ–‡ä»¶å¥æŸ„ã€‚
2. **å æœ‰ä¸”ç­‰å¾…**
   - ä¸€ä¸ªçº¿ç¨‹å·²ç»æŒæœ‰äº†éƒ¨åˆ†èµ„æºï¼Œåˆå»è¯·æ±‚æ–°çš„èµ„æºï¼Œä½†ä¸é‡Šæ”¾å·²æœ‰èµ„æºã€‚
3. **ä¸å¯å‰¥å¤º**
   - çº¿ç¨‹æŒæœ‰çš„èµ„æºåœ¨ä»»åŠ¡å®Œæˆå‰ï¼Œä¸èƒ½è¢«å¼ºè¡Œå‰¥å¤ºã€‚
4. **å¾ªç¯ç­‰å¾…**ï¼ˆæœ€å…¸å‹ï¼‰
   - çº¿ç¨‹ A ç­‰å¾…çº¿ç¨‹ B æŒæœ‰çš„èµ„æºï¼Œè€Œçº¿ç¨‹ B åˆç­‰å¾…çº¿ç¨‹ A çš„èµ„æºï¼Œå½¢æˆç¯è·¯ã€‚

#### 10.2.2 å¸¸è§æ­»é”åœºæ™¯ï¼ˆå¤šçº¿ç¨‹ï¼‰

- **å¤šæŠŠé”äº¤å‰ä½¿ç”¨**

  ```
  Thread 1: è·å–é” A â†’ å†è·å–é” B  
  Thread 2: è·å–é” B â†’ å†è·å–é” A  
  ```

- **é€’å½’è°ƒç”¨ + æ™®é€š Lock**
   åŒä¸€çº¿ç¨‹åœ¨é€’å½’æ—¶å°è¯•å†æ¬¡è·å–è‡ªå·±å·²æŒæœ‰çš„é”ï¼Œä¼šæ­»é”ã€‚

- **ç­‰å¾…æ¡ä»¶å˜é‡æˆ– I/O**
   æŸä¸ªçº¿ç¨‹æ°¸è¿œç­‰ä¸åˆ°æ¡ä»¶æ»¡è¶³ã€‚

#### 10.2.3 é¿å…æ­»é”

1. **é¿å…æ­»é”**

- **å›ºå®šåŠ é”é¡ºåº**
   æ‰€æœ‰çº¿ç¨‹éƒ½æŒ‰ç›¸åŒé¡ºåºç”³è¯·èµ„æºï¼Œé¿å…å¾ªç¯ç­‰å¾…ã€‚
- **ä¸€æ¬¡æ€§ç”³è¯·æ‰€æœ‰éœ€è¦çš„é”**
   é¿å…â€œå æœ‰ä¸”ç­‰å¾…â€ã€‚
- **ä½¿ç”¨è¶…æ—¶æœºåˆ¶**
   `lock.acquire(timeout=...)`ï¼Œé¿å…æ— é™ç­‰å¾…ã€‚
- **ä½¿ç”¨æ›´é«˜å±‚çš„å¹¶å‘å·¥å…·**
   ä¾‹å¦‚ `Queue`ã€`concurrent.futures`ï¼Œé¿å…è‡ªå·±ç®¡ç†é”ã€‚

2. **ä½¿ç”¨é€’å½’é”ï¼ˆRLockï¼‰**

- å½“åŒä¸€çº¿ç¨‹éœ€è¦é‡å¤è·å–åŒä¸€æŠŠé”æ—¶ï¼Œä½¿ç”¨ `RLock` è€Œä¸æ˜¯ `Lock`ï¼Œé¿å…è‡ªæˆ‘æ­»é”ã€‚

3. **æ­»é”æ£€æµ‹ä¸æ¢å¤ï¼ˆè¾ƒå°‘åœ¨åº”ç”¨å±‚ä½¿ç”¨ï¼‰**

- ç³»ç»Ÿå±‚å¯ä»¥é€šè¿‡æ„å»ºâ€œèµ„æºç­‰å¾…å›¾â€æ£€æµ‹å¾ªç¯ç­‰å¾…ï¼Œå‘ç°åå¼ºåˆ¶ç»ˆæ­¢æŸä¸ªçº¿ç¨‹ã€‚



### 10.3 å…¨å±€è§£é‡Šå™¨é” (GIL)

- **å®šä¹‰**ï¼šGIL æ˜¯ **CPython è§£é‡Šå™¨**ï¼ˆPython æœ€å¸¸ç”¨çš„å®ç°ï¼‰ä¸­ä½¿ç”¨çš„ä¸€æŠŠ**å…¨å±€äº’æ–¥é”**ï¼Œå®ƒä¿è¯äº†åœ¨ä»»æ„æ—¶åˆ»ï¼Œåªæœ‰**ä¸€ä¸ªçº¿ç¨‹**èƒ½æ‰§è¡Œ Python å­—èŠ‚ç ã€‚æ¢å¥è¯è¯´ï¼šå³ä½¿ä½ å¼€äº†å¾ˆå¤šçº¿ç¨‹ï¼Œåœ¨å¤šæ ¸ CPU ä¸Šï¼ŒPython çš„å­—èŠ‚ç æ‰§è¡Œ**ä»ç„¶æ˜¯ä¸²è¡Œçš„**ã€‚
- ç”±äºGIL,åœ¨ CPU å¯†é›†å‹ä»»åŠ¡ä¸­ï¼ˆä¾‹å¦‚å¤§å¾ªç¯ã€æ•°å­¦è®¡ç®—ï¼‰ï¼Œå¤šçº¿ç¨‹ **å¹¶ä¸ä¼šæ›´å¿«**ï¼Œç”šè‡³å¯èƒ½æ›´æ…¢ã€‚æ‰€ä»¥å¤šçº¿ç¨‹æ›´é€‚åˆioå¯†é›†çš„ä»»åŠ¡å¦‚ç½‘ç»œè¯·æ±‚æ–‡ä»¶è¯»å†™ã€‚

#### 10.3.1 GILå¯¹å¤šçº¿ç¨‹çš„å½±å“æ¼”ç¤º

* å¯¹äºioå¯†é›†å‹ä»»åŠ¡ä¼˜åŒ–æ˜æ˜¾
* å¯¹äºcpuå¯†é›†å‹ä»»åŠ¡å°±æ²¡æœ‰æ˜æ˜¾ä¼˜åŒ–

```python
import threading
import time
import concurrent.futures

def cpu_intensive_task(name, duration):
    """CPUå¯†é›†å‹ä»»åŠ¡"""
    print(f"å¼€å§‹ {name} - çº¿ç¨‹ID: {threading.get_ident()}")
    start_time = time.time()

    # è®¡ç®—å¯†é›†å‹å·¥ä½œ
    count = 0
    end_time = start_time + duration
    while time.time() < end_time:
        count += 1

    elapsed = time.time() - start_time
    print(f"å®Œæˆ {name} - è€—æ—¶: {elapsed:.2f}ç§’, è®¡ç®—æ¬¡æ•°: {count}")
    return count

def io_intensive_task(name, duration):
    """I/Oå¯†é›†å‹ä»»åŠ¡"""
    print(f"å¼€å§‹ {name} - çº¿ç¨‹ID: {threading.get_ident()}")
    start_time = time.time()

    # æ¨¡æ‹ŸI/Oæ“ä½œ
    for i in range(int(duration * 10)):
        time.sleep(0.1)

    elapsed = time.time() - start_time
    print(f"å®Œæˆ {name} - å®é™…è€—æ—¶: {elapsed:.2f}ç§’")

def demonstrate_gil_impact():
    """æ¼”ç¤ºGILå¯¹ä¸åŒç±»å‹ä»»åŠ¡çš„å½±å“"""
    print("=== GILå¯¹ä¸åŒä»»åŠ¡ç±»å‹çš„å½±å“ ===")

    # CPUå¯†é›†å‹ä»»åŠ¡å¯¹æ¯”
    print("\n1. CPUå¯†é›†å‹ä»»åŠ¡å¯¹æ¯”:")
    start_time = time.time()
    cpu_intensive_task("å•çº¿ç¨‹CPUä»»åŠ¡", 2)
    single_cpu_time = time.time() - start_time

    start_time = time.time()
    with concurrent.futures.ThreadPoolExecutor(max_workers=2) as executor:
        futures = [executor.submit(cpu_intensive_task, f"å¤šçº¿ç¨‹CPU-{i+1}", 2) for i in range(2)]
        [future.result() for future in futures]
    multi_cpu_time = time.time() - start_time

    print(f"CPUä»»åŠ¡ - å•çº¿ç¨‹: {single_cpu_time:.2f}ç§’, å¤šçº¿ç¨‹: {multi_cpu_time:.2f}ç§’")
    print(f"CPUä»»åŠ¡æ€§èƒ½æ¯”: {single_cpu_time / multi_cpu_time:.2f}")

    # I/Oå¯†é›†å‹ä»»åŠ¡å¯¹æ¯”
    print("\n2. I/Oå¯†é›†å‹ä»»åŠ¡å¯¹æ¯”:")
    start_time = time.time()
    for i in range(3):
        io_intensive_task(f"å•çº¿ç¨‹IO-{i+1}", 1)
    single_io_time = time.time() - start_time

    start_time = time.time()
    with concurrent.futures.ThreadPoolExecutor(max_workers=3) as executor:
        futures = [executor.submit(io_intensive_task, f"å¤šçº¿ç¨‹IO-{i+1}", 1) for i in range(3)]
        [future.result() for future in futures]
    multi_io_time = time.time() - start_time

    print(f"I/Oä»»åŠ¡ - å•çº¿ç¨‹: {single_io_time:.2f}ç§’, å¤šçº¿ç¨‹: {multi_io_time:.2f}ç§’")
    print(f"I/Oä»»åŠ¡æ€§èƒ½æå‡: {single_io_time / multi_io_time:.2f}å€")

if __name__ == '__main__':
    demonstrate_gil_impact()
```

### 10.4 ThreadLocal çº¿ç¨‹æœ¬åœ°å­˜å‚¨

`ThreadLocal` æä¾›äº†çº¿ç¨‹å±€éƒ¨å­˜å‚¨ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„æ•°æ®å‰¯æœ¬ï¼Œé¿å…äº†çº¿ç¨‹é—´çš„æ•°æ®å†²çªã€‚

#### 10.4.1 ThreadLocalåŸºç¡€æ¦‚å¿µ

`ThreadLocal` æ˜¯ **çº¿ç¨‹æœ¬åœ°å­˜å‚¨**ï¼ˆThread Local Storage, TLSï¼‰çš„ä¸€ç§å®ç°ã€‚

å®ƒæä¾›äº†ä¸€ç§æœºåˆ¶ï¼šæ¯ä¸ªçº¿ç¨‹éƒ½å¯ä»¥ **ç‹¬ç«‹å­˜å–å±äºè‡ªå·±çš„æ•°æ®å‰¯æœ¬**ï¼Œè€Œä¸ä¼šå’Œå…¶ä»–çº¿ç¨‹äº’ç›¸å¹²æ‰°ã€‚

ç‰¹ç‚¹ï¼š

1. **çº¿ç¨‹éš”ç¦»**
    æ¯ä¸ªçº¿ç¨‹åœ¨ `ThreadLocal` ä¸­å­˜å–çš„å€¼ï¼Œ**åªå¯¹è‡ªå·±å¯è§**ã€‚----å¯ä»¥è·¨å‡½æ•°è®¿é—®ï¼ 
    å°±åƒæ¯ä¸ªçº¿ç¨‹æœ‰ä¸€ä¸ªå°æŠ½å±‰ï¼Œé‡Œé¢çš„ä¸œè¥¿äº’ä¸å¹²æ‰°ã€‚
2. **é¿å…å…±äº«å†²çª**
    ä¸éœ€è¦åŠ é”ï¼ˆLock / RLockï¼‰æ¥ä¿è¯å®‰å…¨ï¼Œå› ä¸ºæ¯ä¸ªçº¿ç¨‹æ‹¿åˆ°çš„éƒ½æ˜¯è‡ªå·±çš„æ•°æ®ã€‚
3. **ç”Ÿå‘½å‘¨æœŸ**
   - æ•°æ®ä¼šè·Ÿéšçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼šçº¿ç¨‹ç»“æŸåï¼Œå¯¹åº”çš„æœ¬åœ°å­˜å‚¨ä¹Ÿä¼šè¢«æ¸…ç†ã€‚

#### 10.4.2 ThreadLocalä½¿ç”¨ç¤ºä¾‹

* ç›¸æ¯”äºç›´æ¥å®šä¹‰å‡½æ•°å†…çš„å±€éƒ¨å˜é‡ä½¿ç”¨localå¯ä»¥åœ¨åŒä¸€ä¸ªçº¿ç¨‹å†…è·¨å‡½æ•°è®¿é—®ï¼ 

```python
import threading
import time

# åˆ›å»ºThreadLocalå¯¹è±¡
thread_local = threading.local()

def function_a():
    """å‡½æ•°Aï¼šè®¾ç½®æ•°æ®"""
    thread_local.user_name = "Alice"
    thread_local.user_id = 12345
    print(f"å‡½æ•°Aè®¾ç½®: user_name={thread_local.user_name}, user_id={thread_local.user_id}")
    
    function_b()  # è°ƒç”¨å‡½æ•°Bï¼Œæ— éœ€ä¼ é€’å‚æ•°

def function_b():
    """å‡½æ•°Bï¼šè¯»å–æ•°æ®å¹¶è°ƒç”¨å‡½æ•°C"""
    print(f"å‡½æ•°Bè¯»å–: user_name={thread_local.user_name}, user_id={thread_local.user_id}")
    
    function_c()  # è°ƒç”¨å‡½æ•°Cï¼Œä»ç„¶æ— éœ€ä¼ é€’å‚æ•°

def function_c():
    """å‡½æ•°Cï¼šä¿®æ”¹æ•°æ®å¹¶è°ƒç”¨å‡½æ•°D"""
    thread_local.timestamp = time.time()
    print(f"å‡½æ•°Cè¯»å–å¹¶æ·»åŠ : user_name={thread_local.user_name}, timestamp={thread_local.timestamp}")
    
    function_d()  # è°ƒç”¨å‡½æ•°D

def function_d():
    """å‡½æ•°Dï¼šæœ€æ·±å±‚çš„å‡½æ•°"""
    print(f"å‡½æ•°Dè®¿é—®æ‰€æœ‰æ•°æ®:")
    print(f"  user_name: {thread_local.user_name}")
    print(f"  user_id: {thread_local.user_id}")
    print(f"  timestamp: {thread_local.timestamp}")

# åœ¨ä¸åŒçº¿ç¨‹ä¸­è¿è¡Œ
def worker(thread_name):
    print(f"\n=== {thread_name} å¼€å§‹æ‰§è¡Œ ===")
    function_a()  # åªéœ€è¦è°ƒç”¨å…¥å£å‡½æ•°
    print(f"=== {thread_name} æ‰§è¡Œå®Œæ¯• ===\n")

# åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹
thread1 = threading.Thread(target=worker, args=("çº¿ç¨‹1",))
thread2 = threading.Thread(target=worker, args=("çº¿ç¨‹2",))

thread1.start()
thread2.start()

thread1.join()
thread2.join()
```

---

## æ€»ç»“

1. **çº¿ç¨‹åŸºç¡€ç†è®º**ï¼š
   - çº¿ç¨‹çš„å®šä¹‰ã€ç‰¹ç‚¹å’Œç”Ÿå‘½å‘¨æœŸ
   - çº¿ç¨‹ä¸è¿›ç¨‹çš„è¯¦ç»†å¯¹æ¯”å’Œé€‚ç”¨åœºæ™¯
   - çº¿ç¨‹çŠ¶æ€è½¬æ¢å’Œç®¡ç†æœºåˆ¶
2. **çº¿ç¨‹åˆ›å»ºä¸ç®¡ç†**ï¼š
   - `threading.Thread`ç±»çš„åŸºç¡€ç”¨æ³•å’Œé«˜çº§ç‰¹æ€§
   - è‡ªå®šä¹‰çº¿ç¨‹ç±»çš„å®ç°æ–¹æ³•
   - å®ˆæŠ¤çº¿ç¨‹çš„æ¦‚å¿µå’Œå®é™…åº”ç”¨
3. **çº¿ç¨‹åŒæ­¥æœºåˆ¶**ï¼š
   - **Lock**: åŸºç¡€äº’æ–¥é”ï¼Œè§£å†³æ•°æ®ç«äº‰é—®é¢˜
   - **RLock**: å¯é‡å…¥é”ï¼Œæ”¯æŒåŒä¸€çº¿ç¨‹å¤šæ¬¡è·å–
   - **Semaphore**: ä¿¡å·é‡ï¼Œæ§åˆ¶èµ„æºè®¿é—®æ•°é‡
   - **Event**: äº‹ä»¶å¯¹è±¡ï¼Œå®ç°çº¿ç¨‹é—´åè°ƒ
   - **Condition**: æ¡ä»¶å˜é‡ï¼Œå®ç°å¤æ‚çš„ç­‰å¾…-é€šçŸ¥æœºåˆ¶
4. **é«˜çº§ä¸»é¢˜**ï¼š
   - **GILå…¨å±€è§£é‡Šå™¨é”**ï¼šæ·±å…¥ç†è§£å…¶å·¥ä½œåŸç†å’Œæ€§èƒ½å½±å“
   - **ThreadLocalçº¿ç¨‹æœ¬åœ°å­˜å‚¨**ï¼šå®ç°çº¿ç¨‹é—´æ•°æ®å®Œå…¨éš”ç¦»
   - **æ­»é”é¢„é˜²ç­–ç•¥**ï¼šè¯†åˆ«ã€é¿å…å’Œè§£å†³æ­»é”é—®é¢˜

---

# ç¬¬å››éƒ¨åˆ†ï¼šåç¨‹ä¸å¼‚æ­¥ç¼–ç¨‹

åç¨‹ï¼ˆCoroutineï¼‰å’Œå¼‚æ­¥ç¼–ç¨‹æ˜¯ç°ä»£Pythonå¹¶å‘ç¼–ç¨‹çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚ä¸ä¼ ç»Ÿçš„å¤šçº¿ç¨‹ç¼–ç¨‹ç›¸æ¯”ï¼Œåç¨‹æä¾›äº†ä¸€ç§æ›´è½»é‡çº§ã€æ›´é«˜æ•ˆçš„å¹¶å‘å¤„ç†æ–¹å¼ï¼Œç‰¹åˆ«é€‚åˆI/Oå¯†é›†å‹ä»»åŠ¡ã€‚

## 11. åç¨‹åŸºç¡€ç†è®º

### 11.1 åç¨‹çš„æœ¬è´¨ä¸å·¥ä½œåŸç†

#### 11.1.1 åç¨‹çš„å®šä¹‰

**åç¨‹ï¼ˆCoroutineï¼‰**æ˜¯ä¸€ç§ç”¨æˆ·æ€çš„è½»é‡çº§çº¿ç¨‹ï¼Œç”±ç”¨æˆ·ç¨‹åºè¿›è¡Œè°ƒåº¦ã€‚åç¨‹æ‹¥æœ‰è‡ªå·±çš„å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆï¼Œåç¨‹è°ƒåº¦åˆ‡æ¢æ—¶ï¼Œå°†å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆä¿å­˜åˆ°å…¶ä»–åœ°æ–¹ï¼Œåœ¨åˆ‡å›æ¥æ—¶æ¢å¤å…ˆå‰ä¿å­˜çš„å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆã€‚

åç¨‹çš„æ ¸å¿ƒç‰¹ç‚¹æ˜¯**åä½œå¼å¤šä»»åŠ¡å¤„ç†**ï¼š
- **ä¸»åŠ¨è®©å‡ºæ§åˆ¶æƒ**ï¼šåç¨‹é€šè¿‡ `await` å…³é”®å­—ä¸»åŠ¨æš‚åœæ‰§è¡Œï¼Œè®©å‡ºCPUæ§åˆ¶æƒ
- **ä¿å­˜æ‰§è¡ŒçŠ¶æ€**ï¼šæš‚åœæ—¶ä¿å­˜å½“å‰çš„æ‰§è¡ŒçŠ¶æ€ï¼ˆå˜é‡å€¼ã€æ‰§è¡Œä½ç½®ç­‰ï¼‰
- **æ¢å¤æ‰§è¡Œ**ï¼šå½“ç­‰å¾…çš„æ“ä½œå®Œæˆåï¼Œä»æš‚åœçš„åœ°æ–¹æ¢å¤æ‰§è¡Œ

#### 11.1.2 åç¨‹vsä¼ ç»Ÿå¹¶å‘æ¨¡å‹çš„æ·±åº¦å¯¹æ¯”

```mermaid
graph TB
    subgraph "ä¼ ç»Ÿçº¿ç¨‹æ¨¡å‹"
        A1[æ“ä½œç³»ç»Ÿ] --> A2[çº¿ç¨‹è°ƒåº¦å™¨]
        A2 --> A3[çº¿ç¨‹1]
        A2 --> A4[çº¿ç¨‹2]
        A2 --> A5[çº¿ç¨‹3]
        A3 --> A6[æŠ¢å å¼åˆ‡æ¢]
        A4 --> A6
        A5 --> A6
    end

    subgraph "åç¨‹æ¨¡å‹"
        B1[äº‹ä»¶å¾ªç¯] --> B2[åç¨‹è°ƒåº¦å™¨]
        B2 --> B3[åç¨‹1]
        B2 --> B4[åç¨‹2]
        B2 --> B5[åç¨‹3]
        B3 --> B6[åä½œå¼åˆ‡æ¢]
        B4 --> B6
        B5 --> B6
    end

    style A6 fill:#ffcccc
    style B6 fill:#ccffcc
```

**å¹¶å‘æ¨¡å‹å¯¹æ¯”åˆ†æ**ï¼š

| ç»´åº¦ | æ“ä½œç³»ç»Ÿçº¿ç¨‹ | åç¨‹ | ä¼˜åŠ¿è§£é‡Š |
|:---|:---|:---|:---|
| **è°ƒåº¦æ–¹å¼** | æŠ¢å å¼ï¼ˆåªæ˜¯åˆ‡æ¢+GILï¼‰ | åä½œå¼ï¼ˆç¨‹åºæ§åˆ¶ï¼‰ | åç¨‹é¿å…äº†ä¸å¿…è¦çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ |
| **åˆ›å»ºå¼€é”€** | ~8MBæ ˆç©ºé—´ | ~2KBå¯¹è±¡å¼€é”€ | åç¨‹å†…å­˜å ç”¨æ˜¯çº¿ç¨‹çš„1/4000 |
| **åˆ‡æ¢æˆæœ¬** | å†…æ ¸æ€åˆ‡æ¢ï¼ˆÎ¼sçº§ï¼‰ | ç”¨æˆ·æ€åˆ‡æ¢ï¼ˆnsçº§ï¼‰ | åç¨‹åˆ‡æ¢æ¯”çº¿ç¨‹å¿«1000å€ |
| **æœ€å¤§æ•°é‡** | å‡ ç™¾åˆ°å‡ åƒ | å‡ ä¸‡åˆ°å‡ åä¸‡ | åç¨‹æ”¯æŒæ›´é«˜çš„å¹¶å‘åº¦ |
| **åŒæ­¥å¤æ‚åº¦** | éœ€è¦é”ã€ä¿¡å·é‡ | å¤©ç„¶ä¸²è¡Œæ‰§è¡Œ | åç¨‹é¿å…äº†å¤§éƒ¨åˆ†åŒæ­¥é—®é¢˜ |

#### 11.1.3 åç¨‹çš„ç”Ÿå‘½å‘¨æœŸä¸çŠ¶æ€è½¬æ¢

```mermaid
stateDiagram-v2
    [*] --> Created: åˆ›å»ºåç¨‹å¯¹è±¡
    Created --> Running: å¼€å§‹æ‰§è¡Œ
    Running --> Suspended: awaitæš‚åœ
    Suspended --> Running: æ“ä½œå®Œæˆ
    Running --> Completed: æ­£å¸¸ç»“æŸ
    Running --> Error: å‘ç”Ÿå¼‚å¸¸
    Suspended --> Cancelled: è¢«å–æ¶ˆ
    Error --> [*]: å¼‚å¸¸å¤„ç†
    Completed --> [*]: æ‰§è¡Œå®Œæˆ
    Cancelled --> [*]: å–æ¶ˆå®Œæˆ
```

**çŠ¶æ€è¯¦è§£**ï¼š
- **Created**ï¼šåç¨‹å¯¹è±¡å·²åˆ›å»ºï¼Œä½†æœªå¼€å§‹æ‰§è¡Œ
- **Running**ï¼šåç¨‹æ­£åœ¨æ‰§è¡Œä»£ç 
- **Suspended**ï¼šåç¨‹å›  `await` æš‚åœï¼Œç­‰å¾…æ“ä½œå®Œæˆ
- **Completed**ï¼šåç¨‹æ­£å¸¸æ‰§è¡Œå®Œæˆ
- **Error**ï¼šåç¨‹æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸
- **Cancelled**ï¼šåç¨‹è¢«å¤–éƒ¨å–æ¶ˆ

#### 11.1.4 ä¸ºä»€ä¹ˆåç¨‹é€‚åˆI/Oå¯†é›†å‹ä»»åŠ¡

**I/Oå¯†é›†å‹ä»»åŠ¡çš„ç‰¹ç‚¹**ï¼š
1. **ç­‰å¾…æ—¶é—´é•¿**ï¼šå¤§é‡æ—¶é—´èŠ±åœ¨ç­‰å¾…ç£ç›˜ã€ç½‘ç»œã€æ•°æ®åº“å“åº”
2. **CPUåˆ©ç”¨ç‡ä½**ï¼šç­‰å¾…æœŸé—´CPUå¤„äºç©ºé—²çŠ¶æ€
3. **å¹¶å‘éœ€æ±‚é«˜**ï¼šéœ€è¦åŒæ—¶å¤„ç†å¤§é‡è¯·æ±‚

**åç¨‹çš„ä¼˜åŠ¿**ï¼š

```python
# ä¼ ç»ŸåŒæ­¥I/Oï¼ˆé˜»å¡å¼ï¼‰
def sync_request():
    data1 = database_query()      # é˜»å¡100ms
    data2 = api_call()           # é˜»å¡200ms
    data3 = file_read()          # é˜»å¡50ms
    # æ€»æ—¶é—´ï¼š350msï¼ŒCPUå¤§éƒ¨åˆ†æ—¶é—´ç©ºé—²

# åç¨‹å¼‚æ­¥I/Oï¼ˆéé˜»å¡å¼ï¼‰
async def async_request():
    data1, data2, data3 = await asyncio.gather(
        async_database_query(),   # 100ms
        async_api_call(),        # 200ms
        async_file_read()        # 50ms
    )
    # æ€»æ—¶é—´ï¼š200msï¼ˆæœ€é•¿çš„æ“ä½œï¼‰ï¼ŒCPUåˆ©ç”¨ç‡é«˜
```


### 11.2 äº‹ä»¶å¾ªç¯æœºåˆ¶

#### 11.2.1 äº‹ä»¶å¾ªç¯çš„æœ¬è´¨ä¸åŸç†

**äº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰**æ˜¯åç¨‹å¼‚æ­¥ç¼–ç¨‹çš„æ ¸å¿ƒæœºåˆ¶ï¼Œå®ƒæ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„æ— é™å¾ªç¯ï¼Œè´Ÿè´£è°ƒåº¦å’Œæ‰§è¡Œåç¨‹ä»»åŠ¡ã€‚

**äº‹ä»¶å¾ªç¯çš„åŸºæœ¬å·¥ä½œæµç¨‹**ï¼š
1. **æ£€æŸ¥ä»»åŠ¡é˜Ÿåˆ—**ï¼šæŸ¥çœ‹æ˜¯å¦æœ‰å¾…æ‰§è¡Œçš„ä»»åŠ¡
2. **æ‰§è¡Œä»»åŠ¡**ï¼šå–å‡ºä»»åŠ¡å¹¶æ‰§è¡Œåˆ°é‡åˆ°`await`æˆ–å®Œæˆ
3. **å¤„ç†I/Oäº‹ä»¶**ï¼šå¦‚æœé‡åˆ°`await`ï¼Œæš‚åœä»»åŠ¡å¹¶æ³¨å†ŒI/Oå›è°ƒ
4. **ç­‰å¾…äº‹ä»¶**ï¼šå¦‚æœæ²¡æœ‰å°±ç»ªä»»åŠ¡ï¼Œç­‰å¾…I/Oäº‹ä»¶å®Œæˆ
5. **å”¤é†’ä»»åŠ¡**ï¼šI/Oäº‹ä»¶å®Œæˆåï¼Œå”¤é†’å¯¹åº”çš„æš‚åœä»»åŠ¡
6. **å¾ªç¯æ‰§è¡Œ**ï¼šé‡å¤ä¸Šè¿°è¿‡ç¨‹

#### 11.2.2 äº‹ä»¶å¾ªç¯çš„å·¥ä½œæµç¨‹è¯¦è§£

**1. åˆå§‹åŒ–é˜¶æ®µ**ï¼š
- åˆ›å»ºäº‹ä»¶å¾ªç¯å¯¹è±¡
- åˆå§‹åŒ–ä»»åŠ¡é˜Ÿåˆ—å’Œå›è°ƒé˜Ÿåˆ—
- è®¾ç½®I/Oå¤šè·¯å¤ç”¨å™¨ï¼ˆselect/epoll/kqueueï¼‰

**2. è¿è¡Œé˜¶æ®µ**ï¼š
```python
# äº‹ä»¶å¾ªç¯çš„ä¼ªä»£ç å®ç°
class EventLoop:
    def __init__(self):
        self.ready_queue = []        # å°±ç»ªä»»åŠ¡é˜Ÿåˆ—
        self.waiting_tasks = {}      # ç­‰å¾…ä¸­çš„ä»»åŠ¡
        self.io_selector = Selector() # I/Oå¤šè·¯å¤ç”¨å™¨

    def run_forever(self):
        while True:
            # 1. æ‰§è¡Œæ‰€æœ‰å°±ç»ªçš„ä»»åŠ¡
            while self.ready_queue:
                task = self.ready_queue.pop(0)
                try:
                    # æ‰§è¡Œä»»åŠ¡ç›´åˆ°é‡åˆ°awaitæˆ–å®Œæˆ
                    task.step()
                except StopIteration:
                    # ä»»åŠ¡å®Œæˆï¼Œè®¾ç½®ç»“æœ
                    task.set_result()
                except Exception as e:
                    task.set_exception(e)

            # 2. å¤„ç†I/Oäº‹ä»¶
            timeout = self._calculate_timeout()
            events = self.io_selector.select(timeout)

            # 3. å”¤é†’ç­‰å¾…I/Oçš„ä»»åŠ¡
            for event in events:
                task = self.waiting_tasks.pop(event)
                self.ready_queue.append(task)
```

#### 11.2.3 äº‹ä»¶å¾ªç¯çš„æ ¸å¿ƒç»„ä»¶

**äº‹ä»¶å¾ªç¯åŒ…å«ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶**ï¼š

- **å°±ç»ªé˜Ÿåˆ—ï¼ˆReady Queueï¼‰**ï¼šå­˜å‚¨å¯ç«‹å³æ‰§è¡Œçš„ä»»åŠ¡
- **ç­‰å¾…é˜Ÿåˆ—ï¼ˆWaiting Queueï¼‰**ï¼šå­˜å‚¨æš‚åœä¸­çš„ä»»åŠ¡
- **I/Oé€‰æ‹©å™¨ï¼ˆI/O Selectorï¼‰**ï¼šç›‘æ§I/Oäº‹ä»¶çš„å®ŒæˆçŠ¶æ€
- **ä»»åŠ¡è°ƒåº¦å™¨ï¼ˆTask Schedulerï¼‰**ï¼šè´Ÿè´£ä»»åŠ¡çš„è°ƒåº¦å’Œæ‰§è¡Œ
- **å®šæ—¶å™¨å †ï¼ˆTimer Heapï¼‰**ï¼šç®¡ç†å»¶æ—¶ä»»åŠ¡
- **å›è°ƒé˜Ÿåˆ—ï¼ˆCallback Queueï¼‰**ï¼šå­˜å‚¨I/Oå®Œæˆåçš„å›è°ƒå‡½æ•°

#### 11.2.4 åç¨‹è°ƒåº¦æœºåˆ¶è¯¦è§£

**åç¨‹çŠ¶æ€è½¬æ¢ä¸è°ƒåº¦**ï¼š

1. **åˆ›å»ºä¸æ³¨å†Œ**ï¼š
```python
async def my_coroutine():
    result = await some_io_operation()
    return result

# åˆ›å»ºä»»åŠ¡å¹¶æ³¨å†Œåˆ°äº‹ä»¶å¾ªç¯
task = loop.create_task(my_coroutine())
# ä»»åŠ¡è¢«æ·»åŠ åˆ°å°±ç»ªé˜Ÿåˆ—ç­‰å¾…æ‰§è¡Œ
```

2. **æ‰§è¡Œä¸æš‚åœ**ï¼š
```python
# åç¨‹æ‰§è¡Œæµç¨‹
def coroutine_step(task):
    try:
        # ä»ä¸Šæ¬¡æš‚åœçš„åœ°æ–¹ç»§ç»­æ‰§è¡Œ
        result = task.coroutine.send(last_result)

        if isinstance(result, Awaitable):
            # é‡åˆ°awaitï¼Œæš‚åœåç¨‹
            task.suspend(result)
            # æ³¨å†Œå”¤é†’æ¡ä»¶ï¼ˆI/Oå®Œæˆã€å®šæ—¶å™¨åˆ°æœŸç­‰ï¼‰
            register_wakeup_condition(task, result)
        else:
            # åç¨‹å®Œæˆ
            task.set_result(result)

    except StopIteration as e:
        # åç¨‹æ­£å¸¸ç»“æŸ
        task.set_result(e.value)
```

3. **å”¤é†’ä¸æ¢å¤**ï¼š
```python
# I/Oæ“ä½œå®Œæˆåçš„å”¤é†’è¿‡ç¨‹
def io_completion_callback(task, io_result):
    # å°†ä»»åŠ¡é‡æ–°æ·»åŠ åˆ°å°±ç»ªé˜Ÿåˆ—
    loop.ready_queue.append(task)
    # è®¾ç½®I/Oæ“ä½œçš„ç»“æœ
    task.set_wakeup_result(io_result)
```

#### 11.2.5 äº‹ä»¶å¾ªç¯çš„æ€§èƒ½ä¼˜åŒ–æœºåˆ¶

**1. I/Oå¤šè·¯å¤ç”¨æŠ€æœ¯**ï¼š
- **Linux**: epollï¼ˆé«˜æ•ˆè½®è¯¢ï¼‰
- **macOS**: kqueueï¼ˆå†…æ ¸äº‹ä»¶é˜Ÿåˆ—ï¼‰
- **Windows**: IOCPï¼ˆI/Oå®Œæˆç«¯å£ï¼‰

**2. ä»»åŠ¡è°ƒåº¦ä¼˜åŒ–**ï¼š
- **å°±ç»ªé˜Ÿåˆ—ä¼˜åŒ–**ï¼šä½¿ç”¨åŒç«¯é˜Ÿåˆ—æé«˜æ’å…¥/åˆ é™¤æ•ˆç‡
- **å®šæ—¶å™¨ä¼˜åŒ–**ï¼šä½¿ç”¨å †ç»“æ„ç®¡ç†å®šæ—¶ä»»åŠ¡
- **å†…å­˜æ± **ï¼šé‡ç”¨ä»»åŠ¡å¯¹è±¡å‡å°‘GCå‹åŠ›

**3. ç³»ç»Ÿè°ƒç”¨å‡å°‘**ï¼š
- **æ‰¹é‡å¤„ç†**ï¼šä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨å¤„ç†å¤šä¸ªI/Oäº‹ä»¶
- **è¾¹ç¼˜è§¦å‘**ï¼šåªåœ¨çŠ¶æ€å˜åŒ–æ—¶é€šçŸ¥ï¼Œå‡å°‘å†—ä½™äº‹ä»¶



## 12. async/await è¯­æ³•è¯¦è§£

### 12.1 å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼ç†è®ºåŸºç¡€

#### 12.1.1 å¼‚æ­¥ç¼–ç¨‹çš„æ ¸å¿ƒæ€æƒ³

**å¼‚æ­¥ç¼–ç¨‹**æ˜¯ä¸€ç§ç¼–ç¨‹èŒƒå¼ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯è®©ç¨‹åºèƒ½å¤Ÿåœ¨ç­‰å¾…I/Oæ“ä½œæ—¶ä¸é˜»å¡ï¼Œè€Œæ˜¯å»æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œä»è€Œæé«˜ç¨‹åºçš„æ•´ä½“æ•ˆç‡ã€‚

**åŒæ­¥ç¼–ç¨‹æ¨¡å¼ vs å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼**ï¼š

- **åŒæ­¥ç¼–ç¨‹æ¨¡å¼**ï¼šä»»åŠ¡å¿…é¡»æŒ‰é¡ºåºæ‰§è¡Œï¼Œæ¯ä¸ªä»»åŠ¡å®Œæˆåæ‰èƒ½å¼€å§‹ä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚åœ¨ç­‰å¾…I/Oæ“ä½œæ—¶ï¼Œç¨‹åºä¼šé˜»å¡ï¼Œæ— æ³•å¤„ç†å…¶ä»–äº‹åŠ¡ï¼Œå¯¼è‡´CPUèµ„æºæµªè´¹ã€‚

- **å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼**ï¼šå½“é‡åˆ°I/Oæ“ä½œæ—¶ï¼Œç¨‹åºå¯ä»¥æš‚åœå½“å‰ä»»åŠ¡å¹¶è½¬å»æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œå½“I/Oæ“ä½œå®Œæˆåå†æ¢å¤æš‚åœçš„ä»»åŠ¡ã€‚è¿™æ ·èƒ½å¤Ÿå……åˆ†åˆ©ç”¨ç­‰å¾…æ—¶é—´ï¼Œæé«˜ç¨‹åºçš„æ•´ä½“æ•ˆç‡ã€‚

#### 12.1.2 å¼‚æ­¥ç¼–ç¨‹çš„å…³é”®æ¦‚å¿µ

**1. éé˜»å¡I/Oï¼ˆNon-blocking I/Oï¼‰**ï¼š
- **ä¼ ç»Ÿé˜»å¡I/O**ï¼šè°ƒç”¨read()æ—¶ï¼Œç¨‹åºç­‰å¾…ç›´åˆ°æ•°æ®å°±ç»ª
- **éé˜»å¡I/O**ï¼šè°ƒç”¨read()æ—¶ï¼Œå¦‚æœæ•°æ®æœªå°±ç»ªç«‹å³è¿”å›ï¼Œç¨‹åºå¯ä»¥å¤„ç†å…¶ä»–äº‹åŠ¡

**2. å›è°ƒæœºåˆ¶ï¼ˆCallbackï¼‰**ï¼š
- I/Oæ“ä½œå®Œæˆæ—¶ï¼Œç³»ç»Ÿè°ƒç”¨é¢„å…ˆæ³¨å†Œçš„å›è°ƒå‡½æ•°
- é¿å…äº†è½®è¯¢æ£€æŸ¥I/OçŠ¶æ€çš„å¼€é”€

**3. äº‹ä»¶é©±åŠ¨ï¼ˆEvent-Drivenï¼‰**ï¼š
- ç¨‹åºå“åº”äº‹ä»¶ï¼ˆI/Oå®Œæˆã€å®šæ—¶å™¨åˆ°æœŸç­‰ï¼‰è€Œä¸æ˜¯æŒ‰é¡ºåºæ‰§è¡Œ
- äº‹ä»¶å¾ªç¯è´Ÿè´£åˆ†å‘å’Œå¤„ç†äº‹ä»¶

#### 12.1.3 å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼åˆ†ç±»

**å¼‚æ­¥ç¼–ç¨‹çš„ä¸‰ç§ä¸»è¦æ¨¡å¼**ï¼š

1. **å›è°ƒæ¨¡å¼ï¼ˆCallback Patternï¼‰**
   - **ä¼˜ç‚¹**ï¼šå®ç°ç®€å•ç›´æ¥ï¼Œæ€§èƒ½é«˜
   - **ç¼ºç‚¹**ï¼šå®¹æ˜“å½¢æˆå›è°ƒåœ°ç‹±ï¼Œä»£ç éš¾ä»¥ç»´æŠ¤å’Œç†è§£
   - **é€‚ç”¨åœºæ™¯**ï¼šç®€å•çš„å¼‚æ­¥æ“ä½œ

2. **Promise/Futureæ¨¡å¼**
   - **ä¼˜ç‚¹**ï¼šé¿å…å›è°ƒåœ°ç‹±ï¼Œæ”¯æŒé“¾å¼è°ƒç”¨
   - **ç¼ºç‚¹**ï¼šçŠ¶æ€ç®¡ç†å¤æ‚ï¼Œé”™è¯¯å¤„ç†å›°éš¾
   - **é€‚ç”¨åœºæ™¯**ï¼šå¤æ‚çš„å¼‚æ­¥æµç¨‹æ§åˆ¶

3. **åç¨‹æ¨¡å¼ï¼ˆCoroutine Patternï¼‰**
   - **ä¼˜ç‚¹**ï¼šä½¿ç”¨åŒæ­¥é£æ ¼ç¼–å†™å¼‚æ­¥ä»£ç ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤
   - **ç¼ºç‚¹**ï¼šéœ€è¦è¯­è¨€å±‚é¢çš„æ”¯æŒ
   - **é€‚ç”¨åœºæ™¯**ï¼šç°ä»£å¼‚æ­¥ç¼–ç¨‹çš„é¦–é€‰æ–¹å¼

**æ¨¡å¼å¯¹æ¯”**ï¼š

| æ¨¡å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|:---|:---|:---|:---|
| **å›è°ƒæ¨¡å¼** | ç®€å•ç›´æ¥ï¼Œæ€§èƒ½é«˜ | å›è°ƒåœ°ç‹±ï¼Œéš¾ä»¥ç»´æŠ¤ | ç®€å•å¼‚æ­¥æ“ä½œ |
| **Promise/Future** | é¿å…å›è°ƒåœ°ç‹±ï¼Œé“¾å¼è°ƒç”¨ | çŠ¶æ€ç®¡ç†å¤æ‚ | å¤æ‚å¼‚æ­¥æµç¨‹ |
| **åç¨‹æ¨¡å¼** | åŒæ­¥é£æ ¼ï¼Œæ˜“ç†è§£ | éœ€è¦è¯­è¨€å±‚é¢æ”¯æŒ | ç°ä»£å¼‚æ­¥ç¼–ç¨‹ |

### 12.2 async å…³é”®å­—æ·±åº¦è§£æ

#### 12.2.1 asyncå…³é”®å­—çš„æœ¬è´¨

`async` å…³é”®å­—ç”¨äºå®šä¹‰åç¨‹å‡½æ•°ï¼Œå®ƒçš„ä½œç”¨æ˜¯ï¼š
1. **å‡½æ•°æ ‡è®°**ï¼šå‘Šè¯‰Pythonè§£é‡Šå™¨è¿™æ˜¯ä¸€ä¸ªåç¨‹å‡½æ•°
2. **è¿”å›å€¼åŒ…è£…**ï¼šå°†å‡½æ•°çš„è¿”å›å€¼åŒ…è£…æˆåç¨‹å¯¹è±¡
3. **æ‰§è¡Œæ¨¡å¼å˜æ›´**ï¼šå‡½æ•°å†…éƒ¨å¯ä»¥ä½¿ç”¨awaitå…³é”®å­—

```python
# asyncå…³é”®å­—çš„å·¥ä½œæœºåˆ¶æ¼”ç¤º
def normal_function():
    """æ™®é€šå‡½æ•°ï¼šç«‹å³æ‰§è¡Œå¹¶è¿”å›ç»“æœ"""
    return "ç«‹å³è¿”å›çš„ç»“æœ"

async def coroutine_function():
    """åç¨‹å‡½æ•°ï¼šè¿”å›åç¨‹å¯¹è±¡ï¼Œéœ€è¦äº‹ä»¶å¾ªç¯æ‰§è¡Œ"""
    return "åç¨‹è¿”å›çš„ç»“æœ"

# è°ƒç”¨å¯¹æ¯”
result1 = normal_function()        # ç›´æ¥å¾—åˆ°ç»“æœ
print(type(result1))              # <class 'str'>

result2 = coroutine_function()     # å¾—åˆ°åç¨‹å¯¹è±¡
print(type(result2))              # <class 'coroutine'>
print(result2)                    # <coroutine object coroutine_function at 0x...>

# éœ€è¦ç”¨äº‹ä»¶å¾ªç¯æ‰§è¡Œåç¨‹
import asyncio
actual_result = asyncio.run(coroutine_function())
print(actual_result)              # "åç¨‹è¿”å›çš„ç»“æœ"
```

#### 12.2.2 åç¨‹å‡½æ•°çš„ç”Ÿå‘½å‘¨æœŸ

**åç¨‹å‡½æ•°çš„ç”Ÿå‘½å‘¨æœŸæµç¨‹**ï¼š

1. **åˆ›å»ºé˜¶æ®µ**ï¼šè°ƒç”¨`async`å‡½æ•°æ—¶ï¼Œè¿”å›åç¨‹å¯¹è±¡è€Œä¸æ˜¯ç›´æ¥æ‰§è¡Œ
2. **æ³¨å†Œé˜¶æ®µ**ï¼šå°†åç¨‹å¯¹è±¡æäº¤ç»™äº‹ä»¶å¾ªç¯è¿›è¡Œè°ƒåº¦
3. **æ‰§è¡Œé˜¶æ®µ**ï¼šäº‹ä»¶å¾ªç¯å¼€å§‹æ‰§è¡Œåç¨‹ä»£ç 
4. **æš‚åœé˜¶æ®µ**ï¼šé‡åˆ°`await`æ—¶ï¼Œåç¨‹æš‚åœå¹¶å‘èµ·I/Oè¯·æ±‚
5. **åˆ‡æ¢é˜¶æ®µ**ï¼šåç¨‹äº¤å‡ºæ§åˆ¶æƒï¼Œäº‹ä»¶å¾ªç¯å¤„ç†å…¶ä»–ä»»åŠ¡
6. **ç­‰å¾…é˜¶æ®µ**ï¼šI/Oæ“ä½œåœ¨åå°è¿›è¡Œ
7. **å”¤é†’é˜¶æ®µ**ï¼šI/Oå®Œæˆæ—¶ï¼Œäº‹ä»¶å¾ªç¯æ”¶åˆ°é€šçŸ¥
8. **æ¢å¤é˜¶æ®µ**ï¼šäº‹ä»¶å¾ªç¯æ¢å¤åç¨‹æ‰§è¡Œ
9. **å®Œæˆé˜¶æ®µ**ï¼šåç¨‹è¿”å›ç»“æœå¹¶ä¼ é€’ç»™è°ƒç”¨è€…

#### 12.2.3 asyncå‡½æ•°çš„æ·±å…¥ç‰¹æ€§

```python
import asyncio
import inspect
import time

# æ™®é€šå‡½æ•°
def normal_function():
    """æ™®é€šå‡½æ•°ï¼šåŒæ­¥æ‰§è¡Œï¼Œç«‹å³è¿”å›ç»“æœ"""
    return "æ™®é€šå‡½æ•°ç»“æœ"

# åç¨‹å‡½æ•°
async def async_function():
    """åç¨‹å‡½æ•°ï¼šå¼‚æ­¥æ‰§è¡Œï¼Œè¿”å›åç¨‹å¯¹è±¡"""
    return "åç¨‹å‡½æ•°ç»“æœ"

def analyze_function_types():
    """æ·±åº¦åˆ†æä¸åŒå‡½æ•°ç±»å‹çš„ç‰¹æ€§å’Œè¡Œä¸ºå·®å¼‚"""
    print("=== å‡½æ•°ç±»å‹æ·±åº¦åˆ†æ ===")

    # 1. å‡½æ•°å¯¹è±¡ç±»å‹æ£€æŸ¥
    print("1. å‡½æ•°å¯¹è±¡æœ¬èº«çš„ç‰¹æ€§:")
    print(f"   æ™®é€šå‡½æ•°ç±»å‹: {type(normal_function)}")
    print(f"   åç¨‹å‡½æ•°ç±»å‹: {type(async_function)}")
    print(f"   æ™®é€šå‡½æ•°æ˜¯å¦ä¸ºåç¨‹: {inspect.iscoroutinefunction(normal_function)}")
    print(f"   åç¨‹å‡½æ•°æ˜¯å¦ä¸ºåç¨‹: {inspect.iscoroutinefunction(async_function)}")

    # 2. å‡½æ•°è°ƒç”¨ç»“æœå¯¹æ¯”
    print("\n2. å‡½æ•°è°ƒç”¨ç»“æœçš„å·®å¼‚:")

    # æ™®é€šå‡½æ•°è°ƒç”¨ï¼šç«‹å³æ‰§è¡Œå¹¶è¿”å›ç»“æœ
    start_time = time.time()
    normal_result = normal_function()
    normal_exec_time = time.time() - start_time
    print(f"   æ™®é€šå‡½æ•°è°ƒç”¨:")
    print(f"     ç»“æœ: {normal_result}")
    print(f"     ç»“æœç±»å‹: {type(normal_result)}")
    print(f"     æ‰§è¡Œæ—¶é—´: {normal_exec_time:.6f}ç§’ (ç«‹å³æ‰§è¡Œ)")

    # åç¨‹å‡½æ•°è°ƒç”¨ï¼šè¿”å›åç¨‹å¯¹è±¡ï¼Œæœªå®é™…æ‰§è¡Œ
    start_time = time.time()
    async_result = async_function()
    call_time = time.time() - start_time
    print(f"\n   åç¨‹å‡½æ•°è°ƒç”¨:")
    print(f"     è¿”å›å¯¹è±¡: {async_result}")
    print(f"     å¯¹è±¡ç±»å‹: {type(async_result)}")
    print(f"     æ˜¯å¦ä¸ºåç¨‹å¯¹è±¡: {inspect.iscoroutine(async_result)}")
    print(f"     è°ƒç”¨è€—æ—¶: {call_time:.6f}ç§’ (ä»…åˆ›å»ºå¯¹è±¡)")
    print(f"     æ³¨æ„: åç¨‹å‡½æ•°æ­¤æ—¶å¹¶æœªçœŸæ­£æ‰§è¡Œï¼")

    # 3. åç¨‹å¯¹è±¡çš„çŠ¶æ€
    print(f"\n3. åç¨‹å¯¹è±¡çŠ¶æ€ä¿¡æ¯:")
    print(f"   åç¨‹çŠ¶æ€: {inspect.getgeneratorstate(async_result)}")
    print(f"   åç¨‹åç§°: {async_result.__name__ if hasattr(async_result, '__name__') else 'N/A'}")

    # 4. æ­£ç¡®æ‰§è¡Œåç¨‹çš„æ–¹å¼
    print(f"\n4. åç¨‹çš„æ­£ç¡®æ‰§è¡Œæ–¹å¼:")

    async def run_coroutine():
        """æ¼”ç¤ºåç¨‹çš„æ­£ç¡®æ‰§è¡Œæ–¹å¼"""
        start_time = time.time()
        result = await async_function()  # åœ¨è¿™é‡Œæ‰çœŸæ­£æ‰§è¡Œåç¨‹
        exec_time = time.time() - start_time
        print(f"     é€šè¿‡awaitæ‰§è¡Œç»“æœ: {result}")
        print(f"     å®é™…æ‰§è¡Œæ—¶é—´: {exec_time:.6f}ç§’")
        return result

    # ä½¿ç”¨äº‹ä»¶å¾ªç¯æ‰§è¡Œåç¨‹
    print("   ä½¿ç”¨asyncio.run()æ‰§è¡Œåç¨‹:")
    final_result = asyncio.run(run_coroutine())
    print(f"     æœ€ç»ˆç»“æœ: {final_result}")

    # æ¸…ç†æœªæ‰§è¡Œçš„åç¨‹å¯¹è±¡ï¼ˆé¿å…è­¦å‘Šï¼‰
    async_result.close()
    print(f"\n   æ¸…ç†åç¨‹å¯¹è±¡: å·²å…³é—­æœªæ‰§è¡Œçš„åç¨‹ä»¥é¿å…å†…å­˜æ³„æ¼")

# æ¼”ç¤ºåç¨‹çš„æ‰§è¡Œæ—¶æœº
async def demonstrate_execution_timing():
    """æ¼”ç¤ºåç¨‹çš„æ‰§è¡Œæ—¶æœºå’Œé¡ºåº"""
    print("\n=== åç¨‹æ‰§è¡Œæ—¶æœºæ¼”ç¤º ===")

    async def delayed_task(name, delay):
        """å¸¦å»¶è¿Ÿçš„åç¨‹ä»»åŠ¡"""
        print(f"   ä»»åŠ¡ {name} å¼€å§‹æ‰§è¡Œ")
        await asyncio.sleep(delay)  # æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ
        print(f"   ä»»åŠ¡ {name} æ‰§è¡Œå®Œæˆ")
        return f"ä»»åŠ¡ {name} çš„ç»“æœ"

    print("1. åˆ›å»ºåç¨‹å¯¹è±¡ï¼ˆä¸ä¼šç«‹å³æ‰§è¡Œï¼‰:")
    task1 = delayed_task("A", 1)
    task2 = delayed_task("B", 0.5)
    print(f"   å·²åˆ›å»ºåç¨‹å¯¹è±¡: {type(task1)}")
    print("   æ³¨æ„ï¼šæ­¤æ—¶æ²¡æœ‰ä»»ä½•è¾“å‡ºï¼Œå› ä¸ºåç¨‹å°šæœªæ‰§è¡Œ")

    print("\n2. æ‰§è¡Œåç¨‹ï¼ˆç°åœ¨æ‰çœŸæ­£å¼€å§‹ï¼‰:")
    start_time = time.time()

    # å¹¶å‘æ‰§è¡Œå¤šä¸ªåç¨‹
    results = await asyncio.gather(task1, task2)

    total_time = time.time() - start_time
    print(f"   æ‰§è¡Œç»“æœ: {results}")
    print(f"   æ€»æ‰§è¡Œæ—¶é—´: {total_time:.2f}ç§’")
    print(f"   è¯´æ˜: ä¸¤ä¸ªä»»åŠ¡å¹¶å‘æ‰§è¡Œï¼Œæ€»æ—¶é—´çº¦ç­‰äºæœ€é•¿ä»»åŠ¡çš„æ—¶é—´")

if __name__ == '__main__':
    # åˆ†æå‡½æ•°ç±»å‹
    analyze_function_types()

    # æ¼”ç¤ºæ‰§è¡Œæ—¶æœº
    asyncio.run(demonstrate_execution_timing())
```

### 12.3 await å…³é”®å­—æ·±åº¦è§£æ

#### 12.3.1 awaitçš„æœ¬è´¨ä¸å·¥ä½œæœºåˆ¶

`await` å…³é”®å­—æ˜¯åç¨‹æš‚åœå’Œæ¢å¤çš„æ ¸å¿ƒæœºåˆ¶ï¼Œå®ƒçš„ä½œç”¨æ˜¯ï¼š
1. **æš‚åœå½“å‰åç¨‹**ï¼šè®©å‡ºCPUæ§åˆ¶æƒç»™äº‹ä»¶å¾ªç¯
2. **ç­‰å¾…æ“ä½œå®Œæˆ**ï¼šç­‰å¾…è¢«awaitçš„å¯¹è±¡å®Œæˆå…¶å¼‚æ­¥æ“ä½œ
3. **æ¢å¤åç¨‹æ‰§è¡Œ**ï¼šæ“ä½œå®Œæˆåä»æš‚åœç‚¹ç»§ç»­æ‰§è¡Œ
4. **è¿”å›ç»“æœ**ï¼šè·å–å¼‚æ­¥æ“ä½œçš„ç»“æœ

**awaitå…³é”®å­—çš„å·¥ä½œæœºåˆ¶**ï¼š

1. **æš‚åœæ‰§è¡Œ**ï¼šå½“åç¨‹æ‰§è¡Œåˆ°`await`æ—¶ï¼Œå½“å‰åç¨‹ä¼šè¢«æš‚åœ
2. **æ³¨å†Œå›è°ƒ**ï¼šäº‹ä»¶å¾ªç¯æ³¨å†Œç›¸åº”çš„å›è°ƒå‡½æ•°æ¥ç›‘å¬æ“ä½œå®Œæˆ
3. **å‘èµ·è¯·æ±‚**ï¼šå‘I/Oç³»ç»Ÿå‘èµ·å¼‚æ­¥è¯·æ±‚ï¼ˆå¦‚ç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶è¯»å†™ç­‰ï¼‰
4. **åˆ‡æ¢ä»»åŠ¡**ï¼šäº‹ä»¶å¾ªç¯ç»§ç»­å¤„ç†å…¶ä»–å°±ç»ªçš„åç¨‹ä»»åŠ¡
5. **ç­‰å¾…å®Œæˆ**ï¼šI/Oæ“ä½œåœ¨åå°å¼‚æ­¥è¿›è¡Œ
6. **æ¥æ”¶é€šçŸ¥**ï¼šå½“I/Oæ“ä½œå®Œæˆæ—¶ï¼Œäº‹ä»¶å¾ªç¯æ”¶åˆ°å®Œæˆé€šçŸ¥
7. **å”¤é†’åç¨‹**ï¼šäº‹ä»¶å¾ªç¯å”¤é†’ä¹‹å‰æš‚åœçš„åç¨‹
8. **ä¼ é€’ç»“æœ**ï¼šå°†I/Oæ“ä½œçš„ç»“æœä¼ é€’ç»™åç¨‹
9. **ç»§ç»­æ‰§è¡Œ**ï¼šåç¨‹ä»`await`è¯­å¥çš„ä¸‹ä¸€è¡Œç»§ç»­æ‰§è¡Œ

#### 12.3.2 å¯ç­‰å¾…å¯¹è±¡çš„ç±»å‹ä¸ç‰¹æ€§

```python
import asyncio
import time
from typing import Awaitable

async def demonstrate_awaitable_objects():
    """æ·±åº¦æ¼”ç¤ºä¸åŒç±»å‹å¯ç­‰å¾…å¯¹è±¡çš„ç‰¹æ€§å’Œç”¨æ³•"""
    print("=== å¯ç­‰å¾…å¯¹è±¡æ·±åº¦åˆ†æ ===")

    # 1. åç¨‹å¯¹è±¡ (Coroutine Object)
    print("1. åç¨‹å¯¹è±¡ - æœ€åŸºç¡€çš„å¯ç­‰å¾…å¯¹è±¡:")

    async def simple_coroutine(message, delay=0.5):
        """ç®€å•çš„åç¨‹å‡½æ•°ï¼Œæ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ"""
        print(f"   åç¨‹å¼€å§‹: {message}")
        await asyncio.sleep(delay)  # æ¨¡æ‹ŸI/Oæ“ä½œ
        print(f"   åç¨‹å®Œæˆ: {message}")
        return f"åç¨‹ç»“æœ: {message}"

    start_time = time.time()
    result = await simple_coroutine("åŸºç¡€åç¨‹", 0.3)
    elapsed = time.time() - start_time
    print(f"   è¿”å›ç»“æœ: {result}")
    print(f"   æ‰§è¡Œæ—¶é—´: {elapsed:.2f}ç§’")

    # 2. Taskå¯¹è±¡ - åŒ…è£…çš„åç¨‹ï¼Œå¯ä»¥å¹¶å‘æ‰§è¡Œ
    print("\n2. Taskå¯¹è±¡ - åç¨‹çš„å¹¶å‘æ‰§è¡ŒåŒ…è£…:")

    start_time = time.time()
    # åˆ›å»ºTaskå¯¹è±¡ï¼Œç«‹å³å¼€å§‹åœ¨åå°æ‰§è¡Œ
    task = asyncio.create_task(simple_coroutine("Taskåç¨‹", 0.4))
    print(f"   TaskçŠ¶æ€: {task.done()}")  # Falseï¼Œå› ä¸ºè¿˜åœ¨æ‰§è¡Œ
    print(f"   Taskå¯¹è±¡: {task}")

    # ç­‰å¾…Taskå®Œæˆ
    result = await task
    elapsed = time.time() - start_time
    print(f"   Taskç»“æœ: {result}")
    print(f"   TaskçŠ¶æ€: {task.done()}")  # Trueï¼Œå·²å®Œæˆ
    print(f"   æ‰§è¡Œæ—¶é—´: {elapsed:.2f}ç§’")

    # 3. Futureå¯¹è±¡ - æ‰‹åŠ¨æ§åˆ¶çš„å¼‚æ­¥ç»“æœå®¹å™¨
    print("\n3. Futureå¯¹è±¡ - å¼‚æ­¥ç»“æœçš„å®¹å™¨:")

    future = asyncio.Future()
    print(f"   Futureåˆå§‹çŠ¶æ€: done={future.done()}, cancelled={future.cancelled()}")

    # åˆ›å»ºä¸€ä¸ªä»»åŠ¡æ¥è®¾ç½®Futureçš„ç»“æœ
    async def set_future_result(fut, delay):
        """å¼‚æ­¥è®¾ç½®Futureç»“æœ"""
        await asyncio.sleep(delay)
        if not fut.done():  # æ£€æŸ¥æ˜¯å¦å·²ç»è®¾ç½®è¿‡ç»“æœ
            fut.set_result("Futureå¼‚æ­¥ç»“æœ")
            print("   Futureç»“æœå·²è®¾ç½®")

    # å¯åŠ¨è®¾ç½®ç»“æœçš„ä»»åŠ¡
    asyncio.create_task(set_future_result(future, 0.2))

    start_time = time.time()
    result = await future  # ç­‰å¾…Futureè¢«è®¾ç½®ç»“æœ
    elapsed = time.time() - start_time
    print(f"   Futureç»“æœ: {result}")
    print(f"   ç­‰å¾…æ—¶é—´: {elapsed:.2f}ç§’")
    print(f"   Futureæœ€ç»ˆçŠ¶æ€: done={future.done()}")

    # 4. asyncio.gather - å¹¶å‘ç­‰å¾…å¤šä¸ªåç¨‹
    print("\n4. asyncio.gather - å¹¶å‘æ‰§è¡Œå¤šä¸ªå¯ç­‰å¾…å¯¹è±¡:")

    async def worker_task(worker_id, work_duration):
        """å·¥ä½œä»»åŠ¡ï¼Œæ¨¡æ‹Ÿä¸åŒè€—æ—¶çš„æ“ä½œ"""
        print(f"   Worker {worker_id} å¼€å§‹å·¥ä½œ (é¢„è®¡{work_duration}ç§’)")
        await asyncio.sleep(work_duration)
        print(f"   Worker {worker_id} å·¥ä½œå®Œæˆ")
        return f"Worker {worker_id} çš„æˆæœ"

    start_time = time.time()

    # å¹¶å‘æ‰§è¡Œå¤šä¸ªä»»åŠ¡
    results = await asyncio.gather(
        worker_task("A", 0.3),
        worker_task("B", 0.5),
        worker_task("C", 0.2),
        return_exceptions=True  # å³ä½¿æœ‰å¼‚å¸¸ä¹Ÿè¿”å›ç»“æœ
    )

    elapsed = time.time() - start_time
    print(f"   æ‰€æœ‰ä»»åŠ¡ç»“æœ: {results}")
    print(f"   æ€»æ‰§è¡Œæ—¶é—´: {elapsed:.2f}ç§’ (å¹¶å‘æ‰§è¡Œï¼Œæ—¶é—´â‰ˆæœ€æ…¢ä»»åŠ¡)")
    print(f"   æ€§èƒ½è¯´æ˜: ä¸²è¡Œæ‰§è¡Œéœ€è¦ {0.3+0.5+0.2}ç§’ï¼Œå¹¶å‘æ‰§è¡Œåªéœ€ {max(0.3,0.5,0.2)}ç§’")

    # 5. è‡ªå®šä¹‰å¯ç­‰å¾…å¯¹è±¡
    print("\n5. è‡ªå®šä¹‰å¯ç­‰å¾…å¯¹è±¡:")

    class CustomAwaitable:
        """è‡ªå®šä¹‰å¯ç­‰å¾…å¯¹è±¡ï¼Œå®ç°__await__æ–¹æ³•"""
        def __init__(self, value, delay):
            self.value = value
            self.delay = delay

        def __await__(self):
            """å®ç°å¯ç­‰å¾…åè®®"""
            # è¿”å›ä¸€ä¸ªç”Ÿæˆå™¨ï¼Œå®ç°æš‚åœå’Œæ¢å¤
            yield from asyncio.sleep(self.delay).__await__()
            return f"è‡ªå®šä¹‰ç»“æœ: {self.value}"

    custom_awaitable = CustomAwaitable("æµ‹è¯•æ•°æ®", 0.3)
    result = await custom_awaitable
    print(f"   è‡ªå®šä¹‰å¯ç­‰å¾…å¯¹è±¡ç»“æœ: {result}")

    # 6. æ¡ä»¶ç­‰å¾…å’Œè¶…æ—¶æ§åˆ¶
    print("\n6. æ¡ä»¶ç­‰å¾…å’Œè¶…æ—¶æ§åˆ¶:")

    async def slow_operation():
        """æ…¢é€Ÿæ“ä½œï¼Œç”¨äºæ¼”ç¤ºè¶…æ—¶"""
        await asyncio.sleep(2.0)
        return "æ…¢æ“ä½œå®Œæˆ"

    # è¶…æ—¶ç­‰å¾…
    try:
        result = await asyncio.wait_for(slow_operation(), timeout=1.0)
        print(f"   æ“ä½œç»“æœ: {result}")
    except asyncio.TimeoutError:
        print("   æ“ä½œè¶…æ—¶ï¼æ¼”ç¤ºäº†è¶…æ—¶æ§åˆ¶æœºåˆ¶")

    # ç­‰å¾…ç¬¬ä¸€ä¸ªå®Œæˆ
    async def quick_task(task_id, delay):
        await asyncio.sleep(delay)
        return f"ä»»åŠ¡{task_id}å®Œæˆ"

    print("\n   ç­‰å¾…ç¬¬ä¸€ä¸ªä»»åŠ¡å®Œæˆ:")
    done, pending = await asyncio.wait(
        [
            asyncio.create_task(quick_task(1, 0.3)),
            asyncio.create_task(quick_task(2, 0.5)),
            asyncio.create_task(quick_task(3, 0.7))
        ],
        return_when=asyncio.FIRST_COMPLETED
    )

    # è·å–å®Œæˆçš„ä»»åŠ¡ç»“æœ
    completed_task = list(done)[0]
    result = await completed_task
    print(f"   ç¬¬ä¸€ä¸ªå®Œæˆçš„ä»»åŠ¡: {result}")

    # å–æ¶ˆæœªå®Œæˆçš„ä»»åŠ¡
    for task in pending:
        task.cancel()
    print(f"   å–æ¶ˆäº† {len(pending)} ä¸ªæœªå®Œæˆçš„ä»»åŠ¡")

async def await_patterns():
    """å¸¸è§çš„awaitä½¿ç”¨æ¨¡å¼"""
    print("\n=== await ä½¿ç”¨æ¨¡å¼ ===")

    async def fetch_data(source, delay):
        """æ¨¡æ‹Ÿæ•°æ®è·å–"""
        print(f"å¼€å§‹ä» {source} è·å–æ•°æ®...")
        await asyncio.sleep(delay)
        print(f"ä» {source} è·å–æ•°æ®å®Œæˆ")
        return f"æ¥è‡ª {source} çš„æ•°æ®"

    # æ¨¡å¼1: é¡ºåºç­‰å¾…ï¼ˆä¸²è¡Œï¼‰
    print("1. é¡ºåºç­‰å¾… (ä¸²è¡Œ):")
    start_time = time.time()

    data1 = await fetch_data("æ•°æ®åº“", 1)
    data2 = await fetch_data("API", 0.8)
    data3 = await fetch_data("ç¼“å­˜", 0.3)

    serial_time = time.time() - start_time
    print(f"   ä¸²è¡Œæ€»è€—æ—¶: {serial_time:.2f}ç§’")
    print(f"   æ•°æ®: {[data1, data2, data3]}")

    # æ¨¡å¼2: å¹¶å‘ç­‰å¾…ï¼ˆå¹¶è¡Œï¼‰
    print("\n2. å¹¶å‘ç­‰å¾… (å¹¶è¡Œ):")
    start_time = time.time()

    data1, data2, data3 = await asyncio.gather(
        fetch_data("æ•°æ®åº“", 1),
        fetch_data("API", 0.8),
        fetch_data("ç¼“å­˜", 0.3)
    )

    parallel_time = time.time() - start_time
    print(f"   å¹¶è¡Œæ€»è€—æ—¶: {parallel_time:.2f}ç§’")
    print(f"   æ€§èƒ½æå‡: {serial_time / parallel_time:.2f}å€")
    print(f"   æ•°æ®: {[data1, data2, data3]}")

    # æ¨¡å¼3: æœ‰æ¡ä»¶ç­‰å¾…
    print("\n3. æœ‰æ¡ä»¶ç­‰å¾…:")
    async def conditional_fetch():
        # å…ˆå°è¯•ä»ç¼“å­˜è·å–
        cache_data = await fetch_data("ç¼“å­˜", 0.1)

        if "ç¼“å­˜" in cache_data:  # ç¼“å­˜å‘½ä¸­
            return cache_data
        else:  # ç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“è·å–
            return await fetch_data("æ•°æ®åº“", 1)

    result = await conditional_fetch()
    print(f"   æ¡ä»¶è·å–ç»“æœ: {result}")

if __name__ == '__main__':
    # è¿è¡Œå¯ç­‰å¾…å¯¹è±¡æ¼”ç¤º
    asyncio.run(demonstrate_awaitable_objects())
```

#### 12.3.3 awaitä½¿ç”¨çš„æœ€ä½³å®è·µ

**1. æ€§èƒ½ä¼˜åŒ–åŸåˆ™**ï¼š
- **å¹¶å‘ä¼˜äºä¸²è¡Œ**ï¼šä½¿ç”¨ `asyncio.gather()` è€Œä¸æ˜¯é¡ºåºawait
- **é¿å…é˜»å¡æ“ä½œ**ï¼šåœ¨åç¨‹ä¸­ä¸è¦ä½¿ç”¨ `time.sleep()`ï¼Œåº”è¯¥ç”¨ `asyncio.sleep()`
- **åˆç†æ§åˆ¶å¹¶å‘æ•°**ï¼šä½¿ç”¨ `asyncio.Semaphore` é™åˆ¶å¹¶å‘æ•°é‡

**2. é”™è¯¯å¤„ç†ç­–ç•¥**ï¼š
- **ä½¿ç”¨try-exceptåŒ…è£…await**ï¼šå¤„ç†å¯èƒ½çš„å¼‚å¸¸
- **è®¾ç½®åˆç†çš„è¶…æ—¶**ï¼šä½¿ç”¨ `asyncio.wait_for()` é¿å…æ— é™ç­‰å¾…
- **ä¼˜é›…çš„ä»»åŠ¡å–æ¶ˆ**ï¼šæ­£ç¡®å¤„ç† `asyncio.CancelledError`

**3. ä»£ç å¯è¯»æ€§**ï¼š
- **é¿å…æ·±åº¦åµŒå¥—**ï¼šåˆç†æ‹†åˆ†åç¨‹å‡½æ•°
- **æ¸…æ™°çš„å‘½å**ï¼šå‡½æ•°ååº”ä½“ç°å…¶å¼‚æ­¥ç‰¹æ€§
- **é€‚å½“çš„æ³¨é‡Š**ï¼šè¯´æ˜awaitçš„ä½œç”¨å’Œé¢„æœŸè€—æ—¶
```

### 12.3 åç¨‹çš„å¹¶å‘æ§åˆ¶

#### 12.3.1 asyncio.gather() è¯¦è§£

```python
import asyncio
import random
import time

async def worker_task(worker_id, work_time, success_rate=0.8):
    """æ¨¡æ‹Ÿå·¥ä½œä»»åŠ¡"""
    print(f"Worker {worker_id} å¼€å§‹å·¥ä½œ...")
    await asyncio.sleep(work_time)

    # æ¨¡æ‹Ÿä»»åŠ¡å¯èƒ½å¤±è´¥
    if random.random() < success_rate:
        result = f"Worker {worker_id} æˆåŠŸå®Œæˆ"
        print(result)
        return result
    else:
        error_msg = f"Worker {worker_id} æ‰§è¡Œå¤±è´¥"
        print(error_msg)
        raise Exception(error_msg)

async def demonstrate_gather():
    """æ¼”ç¤ºasyncio.gatherçš„ä½¿ç”¨"""
    print("=== asyncio.gather() æ¼”ç¤º ===")

    # 1. åŸºç¡€ç”¨æ³•
    print("1. åŸºç¡€å¹¶å‘æ‰§è¡Œ:")
    start_time = time.time()

    results = await asyncio.gather(
        worker_task(1, 1.0),
        worker_task(2, 0.8),
        worker_task(3, 1.2),
        return_exceptions=False  # é‡åˆ°å¼‚å¸¸ç«‹å³æŠ›å‡º
    )

    elapsed = time.time() - start_time
    print(f"   å®Œæˆæ—¶é—´: {elapsed:.2f}ç§’")
    print(f"   ç»“æœ: {results}")

    # 2. å¼‚å¸¸å¤„ç†
    print("\n2. å¼‚å¸¸å¤„ç†æ¨¡å¼:")
    try:
        results = await asyncio.gather(
            worker_task(4, 0.5, success_rate=1.0),
            worker_task(5, 0.3, success_rate=0.3),  # å¾ˆå¯èƒ½å¤±è´¥
            worker_task(6, 0.7, success_rate=1.0),
            return_exceptions=True  # ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œè¿”å›å¼‚å¸¸å¯¹è±¡
        )

        print("   ç»“æœå¤„ç†:")
        for i, result in enumerate(results, 4):
            if isinstance(result, Exception):
                print(f"     Worker {i} å¤±è´¥: {result}")
            else:
                print(f"     Worker {i} æˆåŠŸ: {result}")

    except Exception as e:
        print(f"   æ•è·å¼‚å¸¸: {e}")

async def demonstrate_task_management():
    """æ¼”ç¤ºä»»åŠ¡ç®¡ç†å’Œå–æ¶ˆ"""
    print("\n=== ä»»åŠ¡ç®¡ç†ä¸å–æ¶ˆæ¼”ç¤º ===")

    async def long_running_task(task_id, duration):
        """é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡"""
        try:
            print(f"é•¿ä»»åŠ¡ {task_id} å¼€å§‹ (é¢„è®¡ {duration}ç§’)")
            for i in range(int(duration * 10)):
                await asyncio.sleep(0.1)
                if i % 10 == 0:
                    print(f"  é•¿ä»»åŠ¡ {task_id} è¿›åº¦: {(i+1)/10:.1f}ç§’")
            print(f"é•¿ä»»åŠ¡ {task_id} æ­£å¸¸å®Œæˆ")
            return f"é•¿ä»»åŠ¡ {task_id} ç»“æœ"
        except asyncio.CancelledError:
            print(f"é•¿ä»»åŠ¡ {task_id} è¢«å–æ¶ˆ")
            raise

    # åˆ›å»ºä»»åŠ¡
    tasks = [
        asyncio.create_task(long_running_task(1, 2.0)),
        asyncio.create_task(long_running_task(2, 3.0)),
        asyncio.create_task(long_running_task(3, 1.5)),
    ]

    # ç­‰å¾…2ç§’åå–æ¶ˆæœªå®Œæˆçš„ä»»åŠ¡
    await asyncio.sleep(2.2)

    print("\nå–æ¶ˆæœªå®Œæˆçš„ä»»åŠ¡...")
    for task in tasks:
        if not task.done():
            print(f"  å–æ¶ˆä»»åŠ¡: {task.get_name()}")
            task.cancel()

    # æ”¶é›†ç»“æœ
    results = await asyncio.gather(*tasks, return_exceptions=True)

    print("\næœ€ç»ˆç»“æœ:")
    for i, result in enumerate(results, 1):
        if isinstance(result, asyncio.CancelledError):
            print(f"  ä»»åŠ¡ {i}: å·²å–æ¶ˆ")
        elif isinstance(result, Exception):
            print(f"  ä»»åŠ¡ {i}: å¼‚å¸¸ - {result}")
        else:
            print(f"  ä»»åŠ¡ {i}: æˆåŠŸ - {result}")

if __name__ == '__main__':
    asyncio.run(demonstrate_gather())
    asyncio.run(demonstrate_task_management())
```

## 13. asyncio æ¨¡å—æ·±åº¦è§£æ

`asyncio` æ˜¯Pythonæ ‡å‡†åº“ä¸­çš„å¼‚æ­¥I/Oåº“ï¼Œæä¾›äº†ç¼–å†™å•çº¿ç¨‹å¹¶å‘ä»£ç çš„åŸºç¡€è®¾æ–½ã€‚

### 13.1 asyncio æ ¸å¿ƒç»„ä»¶

#### 13.1.1 asyncio æ¶æ„æ¦‚è§ˆ



#### 13.1.2 asyncio åŸºç¡€APIè¯¦è§£

```python
import asyncio
import time
import random

async def demonstrate_asyncio_basics():
    """æ¼”ç¤ºasyncioåŸºç¡€API"""
    print("=== asyncio åŸºç¡€APIæ¼”ç¤º ===")

    # 1. åŸºæœ¬åç¨‹æ“ä½œ
    async def simple_coro(name, delay):
        print(f"åç¨‹ {name} å¼€å§‹ï¼Œå»¶è¿Ÿ {delay} ç§’")
        await asyncio.sleep(delay)
        print(f"åç¨‹ {name} å®Œæˆ")
        return f"ç»“æœæ¥è‡ª {name}"

    # å•ä¸ªåç¨‹æ‰§è¡Œ
    print("1. å•ä¸ªåç¨‹æ‰§è¡Œ:")
    result = await simple_coro("å•ç‹¬åç¨‹", 1)
    print(f"   ç»“æœ: {result}\n")

    # 2. åˆ›å»ºå’Œç®¡ç†Task
    print("2. Taskåˆ›å»ºå’Œç®¡ç†:")
    task1 = asyncio.create_task(simple_coro("ä»»åŠ¡1", 0.5))
    task2 = asyncio.create_task(simple_coro("ä»»åŠ¡2", 0.8))
    task3 = asyncio.create_task(simple_coro("ä»»åŠ¡3", 0.3))

    print(f"   ä»»åŠ¡1çŠ¶æ€: {task1.done()}")
    print(f"   ä»»åŠ¡2åç§°: {task2.get_name()}")

    # ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
    results = await asyncio.gather(task1, task2, task3)
    print(f"   æ‰€æœ‰ä»»åŠ¡ç»“æœ: {results}\n")

    # 3. Futureå¯¹è±¡æ“ä½œ
    print("3. Futureå¯¹è±¡æ“ä½œ:")
    future = asyncio.Future()

    async def set_future_later():
        await asyncio.sleep(0.5)
        future.set_result("Futureè®¾ç½®çš„ç»“æœ")

    # å¯åŠ¨è®¾ç½®Futureçš„ä»»åŠ¡
    asyncio.create_task(set_future_later())

    print("   ç­‰å¾…Futureå®Œæˆ...")
    future_result = await future
    print(f"   Futureç»“æœ: {future_result}\n")

async def demonstrate_asyncio_wait():
    """æ¼”ç¤ºasyncio.wait()çš„ä½¿ç”¨"""
    print("=== asyncio.wait() æ¼”ç¤º ===")

    async def worker(name, duration, success_rate=0.8):
        await asyncio.sleep(duration)
        if random.random() < success_rate:
            return f"Worker {name} æˆåŠŸ"
        else:
            raise Exception(f"Worker {name} å¤±è´¥")

    # åˆ›å»ºå¤šä¸ªä»»åŠ¡
    tasks = [
        asyncio.create_task(worker("A", 1.0)),
        asyncio.create_task(worker("B", 2.0)),
        asyncio.create_task(worker("C", 1.5)),
        asyncio.create_task(worker("D", 0.8)),
    ]

    # 1. ç­‰å¾…ç¬¬ä¸€ä¸ªå®Œæˆ
    print("1. ç­‰å¾…ç¬¬ä¸€ä¸ªä»»åŠ¡å®Œæˆ:")
    done, pending = await asyncio.wait(tasks, return_when=asyncio.FIRST_COMPLETED)

    print(f"   å·²å®Œæˆä»»åŠ¡æ•°: {len(done)}")
    print(f"   å¾…å®Œæˆä»»åŠ¡æ•°: {len(pending)}")

    for task in done:
        try:
            result = await task
            print(f"   å®Œæˆç»“æœ: {result}")
        except Exception as e:
            print(f"   ä»»åŠ¡å¼‚å¸¸: {e}")

    # 2. è®¾ç½®è¶…æ—¶ç­‰å¾…
    print("\n2. è¶…æ—¶ç­‰å¾…å‰©ä½™ä»»åŠ¡:")
    try:
        done, pending = await asyncio.wait(pending, timeout=1.0)
        print(f"   è¶…æ—¶å†…å®Œæˆ: {len(done)} ä¸ª")
        print(f"   ä»æœªå®Œæˆ: {len(pending)} ä¸ª")

        # å–æ¶ˆæœªå®Œæˆçš„ä»»åŠ¡
        for task in pending:
            task.cancel()

    except asyncio.TimeoutError:
        print("   ç­‰å¾…è¶…æ—¶")

async def demonstrate_asyncio_as_completed():
    """æ¼”ç¤ºasyncio.as_completed()çš„ä½¿ç”¨"""
    print("\n=== asyncio.as_completed() æ¼”ç¤º ===")

    async def download_file(filename, size):
        """æ¨¡æ‹Ÿæ–‡ä»¶ä¸‹è½½"""
        download_time = size / 1000  # æ¨¡æ‹Ÿä¸‹è½½æ—¶é—´
        await asyncio.sleep(download_time)
        return f"æ–‡ä»¶ {filename} ({size}KB) ä¸‹è½½å®Œæˆ"

    # åˆ›å»ºä¸‹è½½ä»»åŠ¡
    downloads = [
        download_file("file1.txt", 500),
        download_file("file2.jpg", 1200),
        download_file("file3.pdf", 800),
        download_file("file4.mp4", 2000),
    ]

    print("å¼€å§‹ä¸‹è½½æ–‡ä»¶...")
    start_time = time.time()

    # æŒ‰å®Œæˆé¡ºåºå¤„ç†ç»“æœ
    for coro in asyncio.as_completed(downloads):
        result = await coro
        elapsed = time.time() - start_time
        print(f"[{elapsed:.1f}s] {result}")

if __name__ == '__main__':
    asyncio.run(demonstrate_asyncio_basics())
    asyncio.run(demonstrate_asyncio_wait())
    asyncio.run(demonstrate_asyncio_as_completed())
```

### 13.2 å¼‚æ­¥I/Oæ“ä½œ

#### 13.2.1 å¼‚æ­¥æ–‡ä»¶æ“ä½œ

```python
import asyncio
import aiofiles
import os
import time

async def demonstrate_async_file_operations():
    """æ¼”ç¤ºå¼‚æ­¥æ–‡ä»¶æ“ä½œ"""
    print("=== å¼‚æ­¥æ–‡ä»¶æ“ä½œæ¼”ç¤º ===")

    # åˆ›å»ºæµ‹è¯•æ•°æ®
    test_files = {
        "test1.txt": "è¿™æ˜¯æµ‹è¯•æ–‡ä»¶1çš„å†…å®¹\nåŒ…å«å¤šè¡Œæ–‡æœ¬\nç”¨äºæ¼”ç¤ºå¼‚æ­¥è¯»å†™",
        "test2.txt": "æµ‹è¯•æ–‡ä»¶2\nå¼‚æ­¥I/Oæ“ä½œ\næ€§èƒ½å¯¹æ¯”",
        "test3.txt": "ç¬¬ä¸‰ä¸ªæµ‹è¯•æ–‡ä»¶\nåç¨‹æ–‡ä»¶å¤„ç†\nå®é™…åº”ç”¨åœºæ™¯"
    }

    # 1. å¼‚æ­¥å†™å…¥æ–‡ä»¶
    print("1. å¼‚æ­¥å†™å…¥æ–‡ä»¶:")
    start_time = time.time()

    async def write_file(filename, content):
        async with aiofiles.open(filename, 'w', encoding='utf-8') as f:
            await f.write(content)
        print(f"   å†™å…¥å®Œæˆ: {filename}")

    # å¹¶å‘å†™å…¥å¤šä¸ªæ–‡ä»¶
    write_tasks = [write_file(fname, content) for fname, content in test_files.items()]
    await asyncio.gather(*write_tasks)

    write_time = time.time() - start_time
    print(f"   å¼‚æ­¥å†™å…¥è€—æ—¶: {write_time:.2f}ç§’\n")

    # 2. å¼‚æ­¥è¯»å–æ–‡ä»¶
    print("2. å¼‚æ­¥è¯»å–æ–‡ä»¶:")
    start_time = time.time()

    async def read_file(filename):
        async with aiofiles.open(filename, 'r', encoding='utf-8') as f:
            content = await f.read()
        print(f"   è¯»å–å®Œæˆ: {filename} (é•¿åº¦: {len(content)} å­—ç¬¦)")
        return content

    # å¹¶å‘è¯»å–å¤šä¸ªæ–‡ä»¶
    read_tasks = [read_file(fname) for fname in test_files.keys()]
    contents = await asyncio.gather(*read_tasks)

    read_time = time.time() - start_time
    print(f"   å¼‚æ­¥è¯»å–è€—æ—¶: {read_time:.2f}ç§’\n")

    # 3. æ–‡ä»¶å¤„ç†æµæ°´çº¿
    print("3. æ–‡ä»¶å¤„ç†æµæ°´çº¿:")

    async def process_file(filename):
        """æ–‡ä»¶å¤„ç†æµæ°´çº¿ï¼šè¯»å– -> å¤„ç† -> å†™å…¥"""
        # è¯»å–
        async with aiofiles.open(filename, 'r', encoding='utf-8') as f:
            content = await f.read()

        # å¤„ç†ï¼ˆæ¨¡æ‹Ÿæ•°æ®å¤„ç†ï¼‰
        processed_content = content.upper().replace('\n', ' | ')
        await asyncio.sleep(0.1)  # æ¨¡æ‹Ÿå¤„ç†æ—¶é—´

        # å†™å…¥å¤„ç†åçš„æ–‡ä»¶
        output_filename = f"processed_{filename}"
        async with aiofiles.open(output_filename, 'w', encoding='utf-8') as f:
            await f.write(processed_content)

        print(f"   å¤„ç†å®Œæˆ: {filename} -> {output_filename}")
        return output_filename

    # å¹¶å‘å¤„ç†æ‰€æœ‰æ–‡ä»¶
    process_tasks = [process_file(fname) for fname in test_files.keys()]
    processed_files = await asyncio.gather(*process_tasks)

    print(f"   å¤„ç†åçš„æ–‡ä»¶: {processed_files}")

    # æ¸…ç†æµ‹è¯•æ–‡ä»¶
    all_files = list(test_files.keys()) + processed_files
    for filename in all_files:
        if os.path.exists(filename):
            os.remove(filename)

async def file_performance_comparison():
    """æ–‡ä»¶æ“ä½œæ€§èƒ½å¯¹æ¯”"""
    print("\n=== åŒæ­¥vså¼‚æ­¥æ–‡ä»¶æ“ä½œæ€§èƒ½å¯¹æ¯” ===")

    # åˆ›å»ºå¤§é‡æµ‹è¯•æ–‡ä»¶æ•°æ®
    test_data = [f"æµ‹è¯•æ–‡ä»¶ {i}\n" * 100 for i in range(20)]

    # åŒæ­¥æ–‡ä»¶æ“ä½œ
    def sync_file_operations():
        start_time = time.time()

        # å†™å…¥æ–‡ä»¶
        for i, data in enumerate(test_data):
            with open(f"sync_test_{i}.txt", 'w') as f:
                f.write(data)

        # è¯»å–æ–‡ä»¶
        contents = []
        for i in range(len(test_data)):
            with open(f"sync_test_{i}.txt", 'r') as f:
                contents.append(f.read())

        # æ¸…ç†
        for i in range(len(test_data)):
            os.remove(f"sync_test_{i}.txt")

        return time.time() - start_time

    # å¼‚æ­¥æ–‡ä»¶æ“ä½œ
    async def async_file_operations():
        start_time = time.time()

        # å¹¶å‘å†™å…¥
        async def write_async_file(i, data):
            async with aiofiles.open(f"async_test_{i}.txt", 'w') as f:
                await f.write(data)

        write_tasks = [write_async_file(i, data) for i, data in enumerate(test_data)]
        await asyncio.gather(*write_tasks)

        # å¹¶å‘è¯»å–
        async def read_async_file(i):
            async with aiofiles.open(f"async_test_{i}.txt", 'r') as f:
                return await f.read()

        read_tasks = [read_async_file(i) for i in range(len(test_data))]
        contents = await asyncio.gather(*read_tasks)

        # æ¸…ç†
        for i in range(len(test_data)):
            if os.path.exists(f"async_test_{i}.txt"):
                os.remove(f"async_test_{i}.txt")

        return time.time() - start_time

    # æ€§èƒ½æµ‹è¯•
    print("æ­£åœ¨æµ‹è¯•åŒæ­¥æ–‡ä»¶æ“ä½œ...")
    sync_time = sync_file_operations()

    print("æ­£åœ¨æµ‹è¯•å¼‚æ­¥æ–‡ä»¶æ“ä½œ...")
    async_time = await async_file_operations()

    print(f"åŒæ­¥æ“ä½œè€—æ—¶: {sync_time:.2f}ç§’")
    print(f"å¼‚æ­¥æ“ä½œè€—æ—¶: {async_time:.2f}ç§’")
    print(f"æ€§èƒ½æå‡: {sync_time / async_time:.2f}å€")

if __name__ == '__main__':
    asyncio.run(demonstrate_async_file_operations())
    asyncio.run(file_performance_comparison())
```

#### 13.2.2 å¼‚æ­¥ç½‘ç»œæ“ä½œ

```python
import asyncio
import aiohttp
import time
import json

async def demonstrate_async_http():
    """æ¼”ç¤ºå¼‚æ­¥HTTPæ“ä½œ"""
    print("=== å¼‚æ­¥HTTPæ“ä½œæ¼”ç¤º ===")

    # æµ‹è¯•URLåˆ—è¡¨
    test_urls = [
        "https://httpbin.org/delay/1",
        "https://httpbin.org/delay/2",
        "https://httpbin.org/json",
        "https://httpbin.org/headers",
        "https://httpbin.org/ip"
    ]

    async def fetch_url(session, url):
        """è·å–å•ä¸ªURL"""
        try:
            print(f"å¼€å§‹è¯·æ±‚: {url}")
            async with session.get(url, timeout=aiohttp.ClientTimeout(total=10)) as response:
                data = await response.text()
                print(f"å®Œæˆè¯·æ±‚: {url} (çŠ¶æ€: {response.status})")
                return {
                    'url': url,
                    'status': response.status,
                    'data_length': len(data)
                }
        except asyncio.TimeoutError:
            print(f"è¯·æ±‚è¶…æ—¶: {url}")
            return {'url': url, 'error': 'timeout'}
        except Exception as e:
            print(f"è¯·æ±‚å¤±è´¥: {url} - {e}")
            return {'url': url, 'error': str(e)}

    # 1. å¹¶å‘HTTPè¯·æ±‚
    print("1. å¹¶å‘HTTPè¯·æ±‚:")
    start_time = time.time()

    async with aiohttp.ClientSession() as session:
        tasks = [fetch_url(session, url) for url in test_urls]
        results = await asyncio.gather(*tasks, return_exceptions=True)

    parallel_time = time.time() - start_time
    print(f"   å¹¶å‘è¯·æ±‚è€—æ—¶: {parallel_time:.2f}ç§’")
    print(f"   æˆåŠŸè¯·æ±‚æ•°: {len([r for r in results if isinstance(r, dict) and 'error' not in r])}")

    # 2. å¸¦é™åˆ¶çš„å¹¶å‘è¯·æ±‚
    print("\n2. å¸¦å¹¶å‘é™åˆ¶çš„HTTPè¯·æ±‚:")

    async def fetch_with_semaphore(session, url, semaphore):
        """ä½¿ç”¨ä¿¡å·é‡é™åˆ¶å¹¶å‘æ•°"""
        async with semaphore:
            return await fetch_url(session, url)

    # é™åˆ¶æœ€å¤§å¹¶å‘æ•°ä¸º2
    semaphore = asyncio.Semaphore(2)
    start_time = time.time()

    async with aiohttp.ClientSession() as session:
        tasks = [fetch_with_semaphore(session, url, semaphore) for url in test_urls]
        results = await asyncio.gather(*tasks)

    limited_time = time.time() - start_time
    print(f"   é™åˆ¶å¹¶å‘è€—æ—¶: {limited_time:.2f}ç§’")

async def demonstrate_async_server():
    """æ¼”ç¤ºå¼‚æ­¥HTTPæœåŠ¡å™¨"""
    print("\n=== å¼‚æ­¥HTTPæœåŠ¡å™¨æ¼”ç¤º ===")

    async def handle_request(request):
        """å¤„ç†HTTPè¯·æ±‚"""
        path = request.path
        method = request.method

        if path == '/':
            return aiohttp.web.Response(text="Hello, Async World!")
        elif path == '/slow':
            # æ¨¡æ‹Ÿæ…¢å“åº”
            await asyncio.sleep(2)
            return aiohttp.web.Response(text="Slow response completed")
        elif path == '/json':
            data = {
                'message': 'Hello JSON',
                'timestamp': time.time(),
                'method': method
            }
            return aiohttp.web.json_response(data)
        else:
            return aiohttp.web.Response(text="Not Found", status=404)

    # åˆ›å»ºåº”ç”¨å’Œè·¯ç”±
    app = aiohttp.web.Application()
    app.router.add_route('*', '/{path:.*}', handle_request)

    print("å¯åŠ¨å¼‚æ­¥HTTPæœåŠ¡å™¨ (http://localhost:8080)")
    print("å¯ç”¨ç«¯ç‚¹:")
    print("  GET  / - åŸºç¡€å“åº”")
    print("  GET  /slow - æ…¢å“åº”(2ç§’)")
    print("  GET  /json - JSONå“åº”")

    # æ³¨æ„ï¼šè¿™é‡Œåªæ˜¯æ¼”ç¤ºæœåŠ¡å™¨åˆ›å»ºï¼Œå®é™…è¿è¡Œéœ€è¦åœ¨ç‹¬ç«‹ç¯å¢ƒä¸­
    # aiohttp.web.run_app(app, host='localhost', port=8080)

async def websocket_example():
    """WebSocketå¼‚æ­¥é€šä¿¡ç¤ºä¾‹"""
    print("\n=== WebSocketå¼‚æ­¥é€šä¿¡ç¤ºä¾‹ ===")

    # æ¨¡æ‹ŸWebSocketæœåŠ¡å™¨ç«¯å¤„ç†
    class MockWebSocketServer:
        def __init__(self):
            self.clients = set()
            self.message_queue = asyncio.Queue()

        async def handle_client(self, client_id):
            """å¤„ç†å•ä¸ªå®¢æˆ·ç«¯è¿æ¥"""
            print(f"å®¢æˆ·ç«¯ {client_id} è¿æ¥")
            self.clients.add(client_id)

            try:
                # æ¨¡æ‹Ÿæ¥æ”¶å’Œå¤„ç†æ¶ˆæ¯
                for i in range(5):
                    await asyncio.sleep(1)
                    message = f"æ¶ˆæ¯ {i+1} æ¥è‡ªå®¢æˆ·ç«¯ {client_id}"
                    await self.message_queue.put((client_id, message))
                    print(f"æ”¶åˆ°: {message}")

            finally:
                self.clients.discard(client_id)
                print(f"å®¢æˆ·ç«¯ {client_id} æ–­å¼€è¿æ¥")

        async def broadcast_messages(self):
            """å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰å®¢æˆ·ç«¯"""
            while True:
                try:
                    # ç­‰å¾…æ–°æ¶ˆæ¯
                    client_id, message = await asyncio.wait_for(
                        self.message_queue.get(), timeout=1.0
                    )

                    # å¹¿æ’­ç»™å…¶ä»–å®¢æˆ·ç«¯
                    for other_client in self.clients:
                        if other_client != client_id:
                            print(f"å¹¿æ’­ç»™å®¢æˆ·ç«¯ {other_client}: {message}")

                except asyncio.TimeoutError:
                    # æ²¡æœ‰æ–°æ¶ˆæ¯ï¼Œç»§ç»­ç­‰å¾…
                    if not self.clients:
                        break

    # æ¨¡æ‹Ÿå¤šå®¢æˆ·ç«¯è¿æ¥
    server = MockWebSocketServer()

    # å¯åŠ¨æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä»»åŠ¡
    tasks = [
        asyncio.create_task(server.handle_client(f"Client-{i+1}"))
        for i in range(3)
    ]
    tasks.append(asyncio.create_task(server.broadcast_messages()))

    # è¿è¡Œæ‰€æœ‰ä»»åŠ¡
    await asyncio.gather(*tasks, return_exceptions=True)

if __name__ == '__main__':
    # æ³¨æ„ï¼šéœ€è¦å®‰è£… aiohttp å’Œ aiofiles
    # pip install aiohttp aiofiles

    try:
        asyncio.run(demonstrate_async_http())
    except ImportError:
        print("éœ€è¦å®‰è£… aiohttp: pip install aiohttp")

    asyncio.run(demonstrate_async_server())
    asyncio.run(websocket_example())
```

### 13.3 å¼‚æ­¥åŒæ­¥åŸè¯­

#### 13.3.1 å¼‚æ­¥é”å’Œä¿¡å·é‡

```python
import asyncio
import random
import time

async def demonstrate_async_primitives():
    """æ¼”ç¤ºå¼‚æ­¥åŒæ­¥åŸè¯­"""
    print("=== å¼‚æ­¥åŒæ­¥åŸè¯­æ¼”ç¤º ===")

    # 1. å¼‚æ­¥é” (asyncio.Lock)
    print("1. å¼‚æ­¥é”æ¼”ç¤º:")
    shared_resource = {"counter": 0, "data": []}
    async_lock = asyncio.Lock()

    async def worker_with_lock(worker_id, iterations):
        """ä½¿ç”¨å¼‚æ­¥é”çš„å·¥ä½œåç¨‹"""
        for i in range(iterations):
            async with async_lock:
                # ä¸´ç•ŒåŒºæ“ä½œ
                current_value = shared_resource["counter"]
                await asyncio.sleep(0.01)  # æ¨¡æ‹Ÿå¤„ç†æ—¶é—´
                shared_resource["counter"] = current_value + 1
                shared_resource["data"].append(f"Worker-{worker_id}-{i}")

            if i % 5 == 0:
                print(f"   Worker {worker_id} è¿›åº¦: {i+1}/{iterations}")

    # è¿è¡Œå¤šä¸ªå·¥ä½œåç¨‹
    start_time = time.time()
    await asyncio.gather(*[
        worker_with_lock(i+1, 10) for i in range(3)
    ])

    elapsed = time.time() - start_time
    print(f"   æœ€ç»ˆè®¡æ•°å™¨å€¼: {shared_resource['counter']}")
    print(f"   æ•°æ®é¡¹æ•°é‡: {len(shared_resource['data'])}")
    print(f"   æ‰§è¡Œæ—¶é—´: {elapsed:.2f}ç§’\n")

    # 2. å¼‚æ­¥ä¿¡å·é‡ (asyncio.Semaphore)
    print("2. å¼‚æ­¥ä¿¡å·é‡æ¼”ç¤º:")

    # åˆ›å»ºä¿¡å·é‡ï¼Œé™åˆ¶åŒæ—¶è®¿é—®èµ„æºçš„åç¨‹æ•°é‡
    semaphore = asyncio.Semaphore(2)  # æœ€å¤š2ä¸ªåç¨‹åŒæ—¶è®¿é—®

    async def limited_resource_access(task_id, access_time):
        """æœ‰é™åˆ¶çš„èµ„æºè®¿é—®"""
        print(f"   ä»»åŠ¡ {task_id} ç­‰å¾…èµ„æºè®¿é—®...")
        async with semaphore:
            print(f"   ä»»åŠ¡ {task_id} è·å¾—èµ„æºè®¿é—®æƒ")
            await asyncio.sleep(access_time)  # æ¨¡æ‹Ÿèµ„æºä½¿ç”¨
            print(f"   ä»»åŠ¡ {task_id} é‡Šæ”¾èµ„æº")
        return f"ä»»åŠ¡ {task_id} å®Œæˆ"

    # åˆ›å»ºå¤šä¸ªéœ€è¦è®¿é—®å—é™èµ„æºçš„ä»»åŠ¡
    tasks = [
        limited_resource_access(i+1, random.uniform(1, 2))
        for i in range(5)
    ]

    start_time = time.time()
    results = await asyncio.gather(*tasks)
    elapsed = time.time() - start_time

    print(f"   æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼Œè€—æ—¶: {elapsed:.2f}ç§’")
    print(f"   ç»“æœ: {results}\n")

    # 3. å¼‚æ­¥äº‹ä»¶ (asyncio.Event)
    print("3. å¼‚æ­¥äº‹ä»¶æ¼”ç¤º:")

    event = asyncio.Event()
    results_list = []

    async def waiter(waiter_id):
        """ç­‰å¾…äº‹ä»¶çš„åç¨‹"""
        print(f"   ç­‰å¾…è€… {waiter_id} å¼€å§‹ç­‰å¾…äº‹ä»¶...")
        await event.wait()  # ç­‰å¾…äº‹ä»¶è¢«è®¾ç½®
        processing_time = random.uniform(0.5, 1.5)
        await asyncio.sleep(processing_time)
        result = f"ç­‰å¾…è€… {waiter_id} å¤„ç†å®Œæˆ"
        results_list.append(result)
        print(f"   {result}")
        return result

    async def event_setter():
        """è®¾ç½®äº‹ä»¶çš„åç¨‹"""
        print("   äº‹ä»¶è®¾ç½®è€…å‡†å¤‡ä¸­...")
        await asyncio.sleep(2)  # æ¨¡æ‹Ÿå‡†å¤‡æ—¶é—´
        print("   äº‹ä»¶è®¾ç½®è€…å‘å‡ºä¿¡å·!")
        event.set()  # è®¾ç½®äº‹ä»¶ï¼Œå”¤é†’æ‰€æœ‰ç­‰å¾…è€…

    # å¯åŠ¨ç­‰å¾…è€…å’Œäº‹ä»¶è®¾ç½®è€…
    waiters = [waiter(i+1) for i in range(4)]
    all_tasks = waiters + [event_setter()]

    await asyncio.gather(*all_tasks)
    print(f"   äº‹ä»¶å¤„ç†å®Œæˆï¼Œå…±æ”¶åˆ° {len(results_list)} ä¸ªç»“æœ\n")

    # 4. å¼‚æ­¥æ¡ä»¶å˜é‡ (asyncio.Condition)
    print("4. å¼‚æ­¥æ¡ä»¶å˜é‡æ¼”ç¤º:")

    condition = asyncio.Condition()
    shared_queue = []
    queue_size_limit = 3

    async def producer(producer_id, item_count):
        """ç”Ÿäº§è€…åç¨‹"""
        for i in range(item_count):
            async with condition:
                # ç­‰å¾…é˜Ÿåˆ—æœ‰ç©ºé—´
                while len(shared_queue) >= queue_size_limit:
                    print(f"   ç”Ÿäº§è€… {producer_id} ç­‰å¾…é˜Ÿåˆ—ç©ºé—´...")
                    await condition.wait()

                # ç”Ÿäº§ç‰©å“
                item = f"P{producer_id}-Item{i+1}"
                shared_queue.append(item)
                print(f"   ç”Ÿäº§è€… {producer_id} ç”Ÿäº§: {item} (é˜Ÿåˆ—é•¿åº¦: {len(shared_queue)})")

                # é€šçŸ¥æ¶ˆè´¹è€…
                condition.notify_all()

            await asyncio.sleep(0.1)  # æ¨¡æ‹Ÿç”Ÿäº§æ—¶é—´

    async def consumer(consumer_id, consume_count):
        """æ¶ˆè´¹è€…åç¨‹"""
        consumed = 0
        while consumed < consume_count:
            async with condition:
                # ç­‰å¾…é˜Ÿåˆ—æœ‰ç‰©å“
                while len(shared_queue) == 0:
                    print(f"   æ¶ˆè´¹è€… {consumer_id} ç­‰å¾…ç‰©å“...")
                    await condition.wait()

                # æ¶ˆè´¹ç‰©å“
                if shared_queue:
                    item = shared_queue.pop(0)
                    consumed += 1
                    print(f"   æ¶ˆè´¹è€… {consumer_id} æ¶ˆè´¹: {item} (é˜Ÿåˆ—é•¿åº¦: {len(shared_queue)})")

                    # é€šçŸ¥ç”Ÿäº§è€…
                    condition.notify_all()

            await asyncio.sleep(0.2)  # æ¨¡æ‹Ÿæ¶ˆè´¹æ—¶é—´

    # å¯åŠ¨ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…
    producers = [producer(i+1, 5) for i in range(2)]
    consumers = [consumer(i+1, 4) for i in range(2)]

    await asyncio.gather(*(producers + consumers))
    print(f"   ç”Ÿäº§æ¶ˆè´¹å®Œæˆï¼Œå‰©ä½™é˜Ÿåˆ—: {shared_queue}")

if __name__ == '__main__':
    asyncio.run(demonstrate_async_primitives())
```

---

## ç¬¬å››éƒ¨åˆ†æ€»ç»“

é€šè¿‡ç¬¬å››éƒ¨åˆ†çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å…¨é¢æŒæ¡äº†Pythonåç¨‹ä¸å¼‚æ­¥ç¼–ç¨‹ï¼š

### æ ¸å¿ƒæ¦‚å¿µå›é¡¾

1. **åç¨‹åŸºç¡€ç†è®º**ï¼š
   - åç¨‹çš„å®šä¹‰ã€ç‰¹ç‚¹å’Œä¼˜åŠ¿
   - åç¨‹ä¸çº¿ç¨‹çš„è¯¦ç»†å¯¹æ¯”
   - Pythonåç¨‹å‘å±•å†ç¨‹å’Œè¯­æ³•æ¼”è¿›

2. **async/awaitè¯­æ³•**ï¼š
   - `async` å…³é”®å­—å®šä¹‰åç¨‹å‡½æ•°
   - `await` å…³é”®å­—ç­‰å¾…å¯ç­‰å¾…å¯¹è±¡
   - ä¸åŒç±»å‹å¯ç­‰å¾…å¯¹è±¡çš„ä½¿ç”¨æ–¹æ³•

3. **äº‹ä»¶å¾ªç¯æœºåˆ¶**ï¼š
   - äº‹ä»¶å¾ªç¯çš„å·¥ä½œåŸç†å’Œç”Ÿå‘½å‘¨æœŸ
   - äº‹ä»¶å¾ªç¯çš„ç®¡ç†å’Œæ§åˆ¶æ–¹æ³•
   - ä»»åŠ¡è°ƒåº¦å’Œæ‰§è¡Œæœºåˆ¶

4. **asyncioæ¨¡å—**ï¼š
   - æ ¸å¿ƒAPIå’Œç»„ä»¶æ¶æ„
   - ä»»åŠ¡åˆ›å»ºã€ç®¡ç†å’Œå–æ¶ˆ
   - å¹¶å‘æ§åˆ¶å’Œå¼‚å¸¸å¤„ç†

5. **å¼‚æ­¥I/Oæ“ä½œ**ï¼š
   - å¼‚æ­¥æ–‡ä»¶æ“ä½œå’Œæ€§èƒ½ä¼˜åŠ¿
   - å¼‚æ­¥ç½‘ç»œè¯·æ±‚å’ŒHTTPæ“ä½œ
   - WebSocketå’Œå®æ—¶é€šä¿¡

6. **å¼‚æ­¥åŒæ­¥åŸè¯­**ï¼š
   - å¼‚æ­¥é”ã€ä¿¡å·é‡ã€äº‹ä»¶å’Œæ¡ä»¶å˜é‡
   - å¼‚æ­¥ç¯å¢ƒä¸‹çš„èµ„æºä¿æŠ¤å’Œåè°ƒ
   - ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼çš„å¼‚æ­¥å®ç°

### å¹¶å‘æ¨¡å‹é€‰æ‹©æŒ‡å—

| åœºæ™¯ç±»å‹ | æ¨èæ–¹æ¡ˆ | åŸå›  | æ³¨æ„äº‹é¡¹ |
|:---|:---|:---|:---|
| **Web APIæœåŠ¡** | åç¨‹ + asyncio | é«˜å¹¶å‘ã€I/Oå¯†é›† | éœ€è¦å¼‚æ­¥åº“æ”¯æŒ |
| **æ–‡ä»¶æ‰¹å¤„ç†** | åç¨‹ + aiofiles | å¼‚æ­¥I/Oä¼˜åŠ¿æ˜æ˜¾ | æ³¨æ„å†…å­˜ä½¿ç”¨ |
| **ç½‘ç»œçˆ¬è™«** | åç¨‹ + aiohttp | å¤§é‡ç½‘ç»œè¯·æ±‚ | æ§åˆ¶å¹¶å‘æ•°é‡ |
| **å®æ—¶é€šä¿¡** | åç¨‹ + WebSocket | é•¿è¿æ¥ç®¡ç† | å¤„ç†è¿æ¥æ–­å¼€ |
| **æ•°æ®è®¡ç®—** | å¤šè¿›ç¨‹ | CPUå¯†é›†å‹ | é¿å…GILé™åˆ¶ |
| **æ··åˆä»»åŠ¡** | å¤šè¿›ç¨‹ + åç¨‹ | å‘æŒ¥å„è‡ªä¼˜åŠ¿ | æ¶æ„å¤æ‚åº¦ |

åç¨‹å’Œå¼‚æ­¥ç¼–ç¨‹ä¸ºç°ä»£Pythonåº”ç”¨æä¾›äº†å¼ºå¤§çš„å¹¶å‘å¤„ç†èƒ½åŠ›ï¼Œç‰¹åˆ«é€‚åˆæ„å»ºé«˜æ€§èƒ½çš„I/Oå¯†é›†å‹åº”ç”¨ã€‚æ­£ç¡®ç†è§£å’Œä½¿ç”¨å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼ï¼Œèƒ½å¤Ÿæ˜¾è‘—æå‡åº”ç”¨çš„å“åº”æ€§å’Œååé‡ã€‚

---

# ç¬¬äº”éƒ¨åˆ†ï¼šå®æˆ˜åº”ç”¨ä¸æœ€ä½³å®è·µ

## 14. å¹¶å‘ç¼–ç¨‹æœ€ä½³å®è·µæ€»ç»“

### 14.1 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

| ä¼˜åŒ–ç»´åº¦ | å¤šè¿›ç¨‹ | å¤šçº¿ç¨‹ | åç¨‹ |
|:---|:---|:---|:---|
| **å¹¶å‘æ•°é‡** | CPUæ ¸å¿ƒæ•° | CPUæ ¸å¿ƒæ•°2-4å€ | æ•°åƒåˆ°æ•°ä¸‡ |
| **å†…å­˜ä½¿ç”¨** | é«˜ï¼ˆç‹¬ç«‹å†…å­˜ç©ºé—´ï¼‰ | ä¸­ï¼ˆå…±äº«å†…å­˜ï¼‰ | ä½ï¼ˆè½»é‡çº§ï¼‰ |
| **å¯åŠ¨å¼€é”€** | é«˜ | ä¸­ | ä½ |
| **ä¸Šä¸‹æ–‡åˆ‡æ¢** | é«˜å¼€é”€ | ä¸­å¼€é”€ | æä½å¼€é”€ |
| **è°ƒè¯•éš¾åº¦** | ä¸­ç­‰ | å›°éš¾ | ä¸­ç­‰ |
| **é”™è¯¯éš”ç¦»** | æœ€å¥½ | æœ€å·® | ä¸­ç­‰ |

### 14.2 å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ

```mermaid
graph TD
    A[å¹¶å‘ç¼–ç¨‹å¸¸è§é—®é¢˜] --> B[æ•°æ®ç«äº‰]
    A --> C[æ­»é”]
    A --> D[èµ„æºæ³„æ¼]
    A --> E[æ€§èƒ½ç“¶é¢ˆ]

    B --> B1[åŸå› : å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®å…±äº«æ•°æ®]
    B --> B2[è§£å†³: ä½¿ç”¨é”ã€åŸå­æ“ä½œã€æ— é”æ•°æ®ç»“æ„]

    C --> C1[åŸå› : å¾ªç¯ç­‰å¾…èµ„æº]
    C --> C2[è§£å†³: ç»Ÿä¸€é”é¡ºåºã€è¶…æ—¶æœºåˆ¶ã€æ­»é”æ£€æµ‹]

    D --> D1[åŸå› : æœªæ­£ç¡®é‡Šæ”¾èµ„æº]
    D --> D2[è§£å†³: ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ã€finallyå—]

    E --> E1[åŸå› : è¿‡åº¦åŒæ­¥ã€ä¸åˆç†å¹¶å‘æ•°]
    E --> E2[è§£å†³: æ€§èƒ½åˆ†æã€åˆç†è®¾è®¡ã€ä¼˜åŒ–ç®—æ³•]

    style B2 fill:#ccffcc
    style C2 fill:#ccffcc
    style D2 fill:#ccffcc
    style E2 fill:#ccffcc
```

## 16. ç»“è¯­ä¸æœªæ¥å‘å±•

### 16.1 çŸ¥è¯†ç‚¹æ€»ç»“

1. **ç†è®ºåŸºç¡€**ï¼šå¹¶å‘ä¸å¹¶è¡Œçš„åŒºåˆ«ã€è¿›ç¨‹çº¿ç¨‹åç¨‹çš„ç‰¹ç‚¹
2. **å¤šè¿›ç¨‹ç¼–ç¨‹**ï¼šè¿›ç¨‹åˆ›å»ºã€é€šä¿¡ã€æ± åŒ–ç®¡ç†ã€ç‰¹æ®Šè¿›ç¨‹ç±»å‹
3. **å¤šçº¿ç¨‹ç¼–ç¨‹**ï¼šçº¿ç¨‹ç®¡ç†ã€åŒæ­¥åŸè¯­ã€GILå½±å“ã€æ­»é”é¢„é˜²
4. **åç¨‹å¼‚æ­¥ç¼–ç¨‹**ï¼šasync/awaitè¯­æ³•ã€äº‹ä»¶å¾ªç¯ã€å¼‚æ­¥I/O
5. **å®æˆ˜åº”ç”¨**ï¼šæ€§èƒ½ä¼˜åŒ–ã€è°ƒè¯•ç›‘æ§ã€æœ€ä½³å®è·µ

### 16.2 æŠ€æœ¯å‘å±•è¶‹åŠ¿

```mermaid
timeline
    title Pythonå¹¶å‘ç¼–ç¨‹å‘å±•è¶‹åŠ¿
    section å½“å‰çŠ¶æ€
        æˆç†ŸæŠ€æœ¯æ ˆ : multiprocessing
                   : threading
                   : asyncioç”Ÿæ€

    section è¿‘æœŸå‘å±•
        æ€§èƒ½ä¼˜åŒ– : Python 3.12+ æ€§èƒ½æå‡
                : æ›´å¥½çš„asyncioæ”¯æŒ
                : åŸç”Ÿåç¨‹ä¼˜åŒ–

    section æœªæ¥æ–¹å‘
        è¯­è¨€å±‚é¢ : ç§»é™¤GILçš„è®¨è®º
                : æ›´å¥½çš„å¹¶è¡Œæ”¯æŒ
                : ç±»å‹ç³»ç»Ÿå¢å¼º

        ç”Ÿæ€ç³»ç»Ÿ : å¼‚æ­¥åº“å®Œå–„
                : å¾®æœåŠ¡æ¡†æ¶
                : äº‘åŸç”Ÿæ”¯æŒ
```

### 16.3 æ¨èèµ„æº

**å®˜æ–¹æ–‡æ¡£**ï¼š
- [Pythonå¹¶å‘ç¼–ç¨‹](https://docs.python.org/zh-cn/3/library/concurrency.html)
- [asyncioæ–‡æ¡£](https://docs.python.org/zh-cn/3/library/asyncio.html)
- [threadingæ–‡æ¡£](https://docs.python.org/zh-cn/3/library/threading.html)

**ä¼˜ç§€åº“æ¨è**ï¼š

- `aiohttp` - å¼‚æ­¥HTTPå®¢æˆ·ç«¯/æœåŠ¡å™¨
- `aiofiles` - å¼‚æ­¥æ–‡ä»¶æ“ä½œ
- `uvloop` - é«˜æ€§èƒ½å¼‚æ­¥äº‹ä»¶å¾ªç¯
- `concurrent.futures` - é«˜çº§å¹¶å‘æ¥å£

**æ€§èƒ½åˆ†æå·¥å…·**ï¼š

- `cProfile` - Pythonæ€§èƒ½åˆ†æ
- `py-spy` - ç”Ÿäº§ç¯å¢ƒæ€§èƒ½ç›‘æ§
- `asyncio-monitor` - å¼‚æ­¥ç¨‹åºç›‘æ§



