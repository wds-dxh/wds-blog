# ç¬¬äºŒéƒ¨åˆ†ï¼šå¤šè¿›ç¨‹

## 3. è¿›ç¨‹åŸºç¡€ç†è®º

### 3.1 è¿›ç¨‹çš„å®šä¹‰ä¸ç»„æˆ

#### 3.1.1 è¿›ç¨‹çš„å®šä¹‰

- **ç‹­ä¹‰å®šä¹‰**ï¼šè¿›ç¨‹æ˜¯æ­£åœ¨è¿è¡Œçš„ç¨‹åºå®ä¾‹ï¼Œæ¯”å¦‚è¿è¡Œä¸€ä¸ªpythonè„šæœ¬ã€‚
- **å¹¿ä¹‰å®šä¹‰**ï¼šè¿›ç¨‹æ˜¯ä¸€ä¸ªç¨‹åºåœ¨æ“ä½œç³»ç»Ÿä¸­çš„ä¸€æ¬¡æ‰§è¡Œå®ä¾‹ï¼ŒåŒ…å«ç¨‹åºã€æ•°æ®ã€ä»¥åŠç³»ç»Ÿä¸ºæ‰§è¡Œè¯¥ç¨‹åºåˆ†é…çš„èµ„æºã€‚

#### 3.1.2 è¿›ç¨‹ä¸ç¨‹åºçš„åŒºåˆ«

- **ç¨‹åº**æ˜¯é™æ€çš„ï¼Œå®ƒåªæ˜¯å­˜å‚¨åœ¨ç£ç›˜ä¸Šçš„ä»£ç æ–‡ä»¶ã€‚
- **è¿›ç¨‹**æ˜¯ç¨‹åºçš„åŠ¨æ€å®ä¾‹ï¼Œæ˜¯æ“ä½œç³»ç»Ÿè¿›è¡Œèµ„æºåˆ†é…å’Œç®¡ç†çš„åŸºæœ¬å•ä½ï¼ŒåŒ…å«ç¨‹åºä»£ç åŠå…¶è¿è¡Œæ—¶æ‰€éœ€çš„èµ„æºã€‚

ä¸€ä¸ªç¨‹åºå¯ä»¥æœ‰å¤šä¸ªè¿›ç¨‹å®ä¾‹ï¼Œæ¯ä¸ªè¿›ç¨‹äº’ç›¸ç‹¬ç«‹æ‰§è¡Œã€‚

#### 3.1.3 è¿›ç¨‹çš„ç»„æˆ

ä¸€ä¸ªè¿›ç¨‹ä¸»è¦ç”±ä»¥ä¸‹éƒ¨åˆ†ç»„æˆï¼š

1. **ç¨‹åºæ®µ**ï¼šå­˜å‚¨åœ¨å†…å­˜ä¸­çš„ä»£ç æ®µï¼Œæ˜¯è¿›ç¨‹æ‰§è¡Œçš„æŒ‡ä»¤é›†ã€‚
2. **æ•°æ®æ®µ**ï¼šè¿›ç¨‹æ‰§è¡Œæ—¶æ‰€éœ€çš„æ•°æ®ï¼ŒåŒ…æ‹¬å…¨å±€å˜é‡å’Œå±€éƒ¨å˜é‡ç­‰ã€‚
3. **è¿›ç¨‹æ§åˆ¶å—ï¼ˆPCBï¼‰**ï¼šè¿›ç¨‹æ§åˆ¶å—æ˜¯æ“ä½œç³»ç»Ÿç®¡ç†è¿›ç¨‹çš„å…³é”®ï¼Œå®ƒè®°å½•è¿›ç¨‹çš„çŠ¶æ€ã€ç¨‹åºè®¡æ•°å™¨ã€å¯„å­˜å™¨å†…å®¹ç­‰ä¿¡æ¯ã€‚

### 3.2 è¿›ç¨‹æ ‡è¯†ç¬¦ä¸å±‚æ¬¡å…³ç³»

#### 3.2.1 è¿›ç¨‹æ ‡è¯†ç¬¦ï¼ˆPIDï¼‰

æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„è¿›ç¨‹IDï¼ˆPIDï¼‰ï¼Œæ“ä½œç³»ç»Ÿé€šè¿‡PIDæ¥åŒºåˆ†å’Œç®¡ç†è¿›ç¨‹ã€‚é€šè¿‡`os.getpid()`å’Œ`os.getppid()`å¯ä»¥è·å–å½“å‰è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹çš„PIDã€‚

```python
import os
import time

if __name__ == '__main__':
    print(f"å½“å‰è¿›ç¨‹PID: {os.getpid()}")
    print(f"çˆ¶è¿›ç¨‹PID: {os.getppid()}")

    for i in range(3):
        time.sleep(1)
        print(f"ç¬¬{i+1}ç§’ - è¿›ç¨‹{os.getpid()}æ­£åœ¨è¿è¡Œ")
```

#### 3.2.2 çˆ¶è¿›ç¨‹ä¸å­è¿›ç¨‹è¯¦è§£

**çˆ¶è¿›ç¨‹ï¼ˆParent Processï¼‰**ï¼š

- åˆ›å»ºå…¶ä»–è¿›ç¨‹ï¼ˆå­è¿›ç¨‹ï¼‰çš„è¿›ç¨‹
- è´Ÿè´£ç®¡ç†å’Œç›‘æ§å­è¿›ç¨‹çš„æ‰§è¡Œ
- é€šå¸¸éœ€è¦ç­‰å¾…å­è¿›ç¨‹å®Œæˆæˆ–å›æ”¶å­è¿›ç¨‹èµ„æº
- å¯ä»¥é€šè¿‡`os.getppid()`åœ¨å­è¿›ç¨‹ä¸­è·å–çˆ¶è¿›ç¨‹PID

**å­è¿›ç¨‹ï¼ˆChild Processï¼‰**ï¼š

- ç”±çˆ¶è¿›ç¨‹åˆ›å»ºçš„æ–°è¿›ç¨‹
- æ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„è¿›ç¨‹ç©ºé—´å’ŒPID
- åˆ›å»ºæ—¶ä¼šç»§æ‰¿çˆ¶è¿›ç¨‹çš„ä»£ç ï¼Œä½†æ•°æ®ç©ºé—´æ˜¯ç‹¬ç«‹çš„
- å¯ä»¥æ‰§è¡Œä¸çˆ¶è¿›ç¨‹ç›¸åŒæˆ–ä¸åŒçš„ä»»åŠ¡

### 3.3 è¿›ç¨‹çŠ¶æ€ä¸è°ƒåº¦

#### 3.3.1 è¿›ç¨‹çŠ¶æ€

è¿›ç¨‹çš„çŠ¶æ€æè¿°äº†å®ƒåœ¨ç”Ÿå‘½å‘¨æœŸä¸­çš„ä¸åŒé˜¶æ®µï¼š

```mermaid
stateDiagram-v2
    [*] --> æ–°å»º: åˆ›å»ºè¿›ç¨‹
    æ–°å»º --> å°±ç»ª: è·å¾—é™¤CPUå¤–çš„èµ„æº
    å°±ç»ª --> è¿è¡Œ: è·å¾—CPUæ—¶é—´ç‰‡
    è¿è¡Œ --> å°±ç»ª: æ—¶é—´ç‰‡ç”¨å®Œ
    è¿è¡Œ --> é˜»å¡: ç­‰å¾…I/Oæˆ–äº‹ä»¶
    é˜»å¡ --> å°±ç»ª: I/Oå®Œæˆæˆ–äº‹ä»¶å‘ç”Ÿ
    è¿è¡Œ --> [*]: è¿›ç¨‹ç»“æŸ

    å°±ç»ª: Ready State<br/>å·²è·å¾—æ‰§è¡Œæ‰€éœ€èµ„æº<br/>ç­‰å¾…CPUè°ƒåº¦
    è¿è¡Œ: Running State<br/>æ­£åœ¨CPUä¸Šæ‰§è¡Œ<br/>æ‹¥æœ‰CPUæ§åˆ¶æƒ
    é˜»å¡: Blocked State<br/>ç­‰å¾…æŸäº›äº‹ä»¶<br/>å¦‚I/Oæ“ä½œå®Œæˆ
```

ä¸»è¦æœ‰ä¸‰ç§åŸºæœ¬çŠ¶æ€ï¼š

- **å°±ç»ªçŠ¶æ€ï¼ˆReadyï¼‰**ï¼šè¿›ç¨‹å·²è·å¾—æ‰§è¡Œæ‰€éœ€çš„èµ„æºï¼Œä½†æ­£åœ¨ç­‰å¾…CPUèµ„æºã€‚
- **è¿è¡ŒçŠ¶æ€ï¼ˆRunningï¼‰**ï¼šè¿›ç¨‹è·å¾—CPUèµ„æºå¹¶æ­£åœ¨æ‰§è¡Œã€‚
- **é˜»å¡çŠ¶æ€ï¼ˆBlockedï¼‰**ï¼šè¿›ç¨‹å› ç­‰å¾…æŸäº›äº‹ä»¶ï¼ˆå¦‚I/Oæ“ä½œï¼‰è€Œæ— æ³•ç»§ç»­æ‰§è¡Œï¼Œè¿›å…¥é˜»å¡çŠ¶æ€ã€‚

#### 3.3.2 è¿›ç¨‹è°ƒåº¦ç®—æ³•

è¿›ç¨‹çš„è°ƒåº¦æ˜¯æ“ä½œç³»ç»Ÿçš„æ ¸å¿ƒä»»åŠ¡ï¼Œå®ƒå†³å®šäº†å¤šä¸ªè¿›ç¨‹å¦‚ä½•å…±äº«CPUèµ„æºï¼š

```mermaid
graph TD
    A[è¿›ç¨‹è°ƒåº¦ç®—æ³•] --> B[FCFS<br/>å…ˆæ¥å…ˆæœåŠ¡]
    A --> C[SJF<br/>çŸ­ä½œä¸šä¼˜å…ˆ]
    A --> D[RR<br/>æ—¶é—´ç‰‡è½®è½¬]
    A --> E[MFQ<br/>å¤šçº§åé¦ˆé˜Ÿåˆ—]

    B --> B1[æŒ‰åˆ°è¾¾é¡ºåºæ‰§è¡Œ<br/>ç®€å•ä½†å¯èƒ½ç­‰å¾…æ—¶é—´é•¿]
    C --> C1[æ‰§è¡Œæ—¶é—´çŸ­çš„ä¼˜å…ˆ<br/>å¯èƒ½å¯¼è‡´é•¿ä½œä¸šé¥¥é¥¿]
    D --> D1[æ¯ä¸ªè¿›ç¨‹åˆ†é…å›ºå®šæ—¶é—´ç‰‡<br/>å…¬å¹³ä½†æœ‰åˆ‡æ¢å¼€é”€]
    E --> E1[ç»“åˆå¤šç§ç®—æ³•ä¼˜ç‚¹<br/>å¤æ‚ä½†æ•ˆæœå¥½]
```

1. **FCFSï¼ˆå…ˆæ¥å…ˆæœåŠ¡ï¼‰**ï¼šæŒ‰ç…§è¿›ç¨‹åˆ°è¾¾çš„é¡ºåºæ‰§è¡Œï¼Œé€‚åˆé•¿æ—¶é—´è¿è¡Œçš„ä½œä¸šã€‚
2. **SJFï¼ˆçŸ­ä½œä¸šä¼˜å…ˆï¼‰**ï¼šä¼˜å…ˆè°ƒåº¦æ‰§è¡Œæ—¶é—´çŸ­çš„ä½œä¸šï¼Œå¯èƒ½å¯¼è‡´é•¿ä½œä¸šé¥¥é¥¿ã€‚
3. **RRï¼ˆæ—¶é—´ç‰‡è½®è½¬ï¼‰**ï¼šä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…å›ºå®šçš„æ—¶é—´ç‰‡ï¼Œé€‚åˆå¤šä»»åŠ¡å¹¶å‘å¤„ç†ã€‚
4. **MFQï¼ˆå¤šçº§åé¦ˆé˜Ÿåˆ—ï¼‰**ï¼šç»“åˆäº†å¤šç§è°ƒåº¦ç®—æ³•çš„ä¼˜ç‚¹ï¼Œé€‚åˆå¤„ç†ä¸åŒç±»å‹çš„ä»»åŠ¡ã€‚

## 4. ç‰¹æ®Šè¿›ç¨‹ç±»å‹è¯¦è§£

### 4.1 å­¤å„¿è¿›ç¨‹æ·±å…¥è§£æ

**å­¤å„¿è¿›ç¨‹ï¼ˆOrphan Processï¼‰**æ˜¯æŒ‡çˆ¶è¿›ç¨‹åœ¨å­è¿›ç¨‹ç»“æŸä¹‹å‰å°±ç»ˆæ­¢äº†ï¼Œä½¿å¾—å­è¿›ç¨‹å¤±å»çˆ¶è¿›ç¨‹çš„è¿›ç¨‹ã€‚

```mermaid
sequenceDiagram
    participant çˆ¶è¿›ç¨‹ as Parent Process
    participant å­è¿›ç¨‹ as Child Process
    participant initè¿›ç¨‹ as Init Process (PID=1)

    çˆ¶è¿›ç¨‹->>å­è¿›ç¨‹: åˆ›å»ºå­è¿›ç¨‹
    Note over å­è¿›ç¨‹: å­è¿›ç¨‹å¼€å§‹æ‰§è¡Œ
    çˆ¶è¿›ç¨‹->>çˆ¶è¿›ç¨‹: çˆ¶è¿›ç¨‹æ„å¤–ç»ˆæ­¢
    Note over å­è¿›ç¨‹: å­è¿›ç¨‹å˜æˆå­¤å„¿è¿›ç¨‹
    initè¿›ç¨‹->>å­è¿›ç¨‹: initè¿›ç¨‹æ”¶å…»å­¤å„¿è¿›ç¨‹
    Note over å­è¿›ç¨‹: å­è¿›ç¨‹ç»§ç»­æ‰§è¡Œ
    å­è¿›ç¨‹->>initè¿›ç¨‹: å­è¿›ç¨‹ç»“æŸï¼Œå‘initæŠ¥å‘Š
```

#### 4.1.1 å­¤å„¿è¿›ç¨‹çš„ç‰¹ç‚¹

- **äº§ç”ŸåŸå› **ï¼šçˆ¶è¿›ç¨‹åœ¨å­è¿›ç¨‹ç»“æŸå‰æ„å¤–ç»ˆæ­¢æˆ–è¢«å¼ºåˆ¶æ€æ­»
- **ç³»ç»Ÿå¤„ç†**ï¼šå­¤å„¿è¿›ç¨‹ä¼šè¢«pid=1çš„initè¿›ç¨‹ï¼ˆç³»ç»Ÿå®ˆæŠ¤è¿›ç¨‹ï¼‰æ”¶å…»
- **èµ„æºå›æ”¶**ï¼šinitè¿›ç¨‹ä¼šå¯¹æ‰€æœ‰çš„å­¤å„¿è¿›ç¨‹è¿›è¡Œèµ„æºå›æ”¶
- **å±å®³ç¨‹åº¦**ï¼šå­¤å„¿è¿›ç¨‹ä¸ä¼šå¯¹ç³»ç»Ÿé€ æˆå±å®³ï¼Œå› ä¸ºæœ‰initè¿›ç¨‹è´Ÿè´£æ¸…ç†

#### 4.1.2 å­¤å„¿è¿›ç¨‹ç¤ºä¾‹

* æ³¨æ„åœ¨ **ç°ä»£ Linux æ¡Œé¢ç¯å¢ƒ**ï¼ˆUbuntu + systemd ç”¨æˆ·ä¼šè¯ï¼‰ä¸‹ï¼Œå­¤å„¿è¿›ç¨‹ **ä¸ä¼šç›´æ¥è¢« PID=1 çš„ init æ”¶å…»**ã€‚
* è¢«æ”¶å…»çš„å¥½å¤„å°±æ˜¯è‡ªåŠ¨çš„å›æ”¶å­è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€ï¼

```python
import os
import time
from multiprocessing import Process

def child_task():
    print(f"å­è¿›ç¨‹å¯åŠ¨ï¼ŒPID={os.getpid()}ï¼Œçˆ¶PID={os.getppid()}")
    for i in range(30):
        time.sleep(1)
        print(f"{i+1}ç§’ - å­è¿›ç¨‹PID={os.getpid()}ï¼Œçˆ¶PID={os.getppid()}")
        if os.getppid() == 1:
            print("ğŸ‘‰ å·²è¢« init æ”¶å…»ï¼Œæˆä¸ºå­¤å„¿")

if __name__ == "__main__":
    print(f"ä¸»è¿›ç¨‹PID={os.getpid()}")
    p = Process(target=child_task)
    p.start()

    time.sleep(3)
    print("ä¸»è¿›ç¨‹å¼ºåˆ¶é€€å‡º")
    os._exit(0)  # âš ï¸ ä¸»è¿›ç¨‹ç«‹å³æ¶ˆäº¡

```

**æµ‹è¯•æ–¹æ³•**ï¼š

```bash
# è¿è¡Œä¸Šè¿°ä»£ç åï¼Œåœ¨å¦ä¸€ä¸ªç»ˆç«¯ä¸­è§‚å¯Ÿè¿›ç¨‹
ps aux | grep python
```

### 4.2 åƒµå°¸è¿›ç¨‹æˆå› ä¸é¿å…

* çˆ¶è¿›ç¨‹æ­»æ‰æ—¶ï¼Œåƒµå°¸è¿›ç¨‹ä¼šè¢« init å›æ”¶

* ç®€å•ç†è§£å°±æ˜¯çˆ¹è¿˜åœ¨ä½†æ˜¯ä¸ç®¡ä»–å°±å˜åƒµå°¸äº†ï¼ ï¼ˆçˆ¹è¿˜åœ¨æ‰€ä»¥initæ— æ³•æ’æ‰‹å›æ”¶ï¼ï¼‰

**åƒµå°¸è¿›ç¨‹ï¼ˆZombie Processï¼‰**æ˜¯æŒ‡å­è¿›ç¨‹å·²ç»ç»“æŸï¼Œä½†çˆ¶è¿›ç¨‹è¿˜æ²¡æœ‰è°ƒç”¨`wait()`æˆ–ç±»ä¼¼ç³»ç»Ÿè°ƒç”¨æ¥æ”¶é›†å­è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€ä¿¡æ¯ã€‚

```mermaid
sequenceDiagram
    participant çˆ¶è¿›ç¨‹ as Parent Process
    participant å­è¿›ç¨‹ as Child Process
    participant æ“ä½œç³»ç»Ÿ as OS

    çˆ¶è¿›ç¨‹->>å­è¿›ç¨‹: åˆ›å»ºå­è¿›ç¨‹
    å­è¿›ç¨‹->>å­è¿›ç¨‹: æ‰§è¡Œä»»åŠ¡
    å­è¿›ç¨‹->>æ“ä½œç³»ç»Ÿ: ä»»åŠ¡å®Œæˆï¼Œè°ƒç”¨exit()
    Note over å­è¿›ç¨‹: å­è¿›ç¨‹å˜æˆåƒµå°¸çŠ¶æ€<br/>ç­‰å¾…çˆ¶è¿›ç¨‹æ”¶é›†é€€å‡ºä¿¡æ¯
    æ“ä½œç³»ç»Ÿ->>çˆ¶è¿›ç¨‹: å‘é€SIGCHLDä¿¡å·
    Note over çˆ¶è¿›ç¨‹: çˆ¶è¿›ç¨‹å¿™äºå…¶ä»–äº‹åŠ¡<br/>æœªåŠæ—¶å¤„ç†å­è¿›ç¨‹
    Note over å­è¿›ç¨‹: è¿›ç¨‹çŠ¶æ€æ˜¾ç¤ºä¸º Z (Zombie)<br/>å ç”¨è¿›ç¨‹è¡¨é¡¹ä½†æ— å®é™…èµ„æº
```

#### 4.2.1 åƒµå°¸è¿›ç¨‹çš„å±å®³

- **èµ„æºå ç”¨**ï¼šè™½ç„¶ä¸å ç”¨å®é™…çš„å†…å­˜å’ŒCPUï¼Œä½†ä¼šå ç”¨è¿›ç¨‹è¡¨é¡¹
- **ç³»ç»Ÿé™åˆ¶**ï¼šå¤§é‡åƒµå°¸è¿›ç¨‹ä¼šè€—å°½è¿›ç¨‹è¡¨ï¼Œå½±å“ç³»ç»Ÿåˆ›å»ºæ–°è¿›ç¨‹
- **çŠ¶æ€æ ‡è¯†**ï¼šåœ¨`ps`å‘½ä»¤ä¸­æ˜¾ç¤ºçŠ¶æ€ä¸º"Z"

#### 4.2.2 äº§ç”Ÿåƒµå°¸è¿›ç¨‹çš„ç¤ºä¾‹

```python
import time
import multiprocessing
import os

def zombie_child():
    """ä¼šå˜æˆåƒµå°¸è¿›ç¨‹çš„å­è¿›ç¨‹"""
    print(f"å­è¿›ç¨‹å¼€å§‹æ‰§è¡Œï¼ŒPID: {os.getpid()}")
    print("å­è¿›ç¨‹å³å°†ç»“æŸ...")
    time.sleep(2)
    print("å­è¿›ç¨‹ç»“æŸ")
    # å­è¿›ç¨‹ç»“æŸåï¼Œå¦‚æœçˆ¶è¿›ç¨‹ä¸è°ƒç”¨join()ï¼Œå°±ä¼šå˜æˆåƒµå°¸è¿›ç¨‹

if __name__ == '__main__':
    print(f"ä¸»è¿›ç¨‹PID: {os.getpid()}")

    # åˆ›å»ºå¤šä¸ªå­è¿›ç¨‹ä½†ä¸ç­‰å¾…å®ƒä»¬ç»“æŸ
    for i in range(3):
        process = multiprocessing.Process(target=zombie_child)
        process.start()
        # æ³¨æ„ï¼šè¿™é‡Œæ²¡æœ‰è°ƒç”¨ process.join()
        print(f"å­è¿›ç¨‹ {i+1} å·²å¯åŠ¨ï¼ŒPIDå¯èƒ½æ˜¯: {process.pid}")

    print("ä¸»è¿›ç¨‹ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡...")
    time.sleep(30)  # ä¸»è¿›ç¨‹ç»§ç»­è¿è¡Œ30ç§’ï¼Œå­è¿›ç¨‹å˜æˆåƒµå°¸

    print("ä¸»è¿›ç¨‹å³å°†ç»“æŸ")
```

**æ£€æŸ¥åƒµå°¸è¿›ç¨‹**ï¼š

```bash
# åœ¨å¦ä¸€ä¸ªç»ˆç«¯æ‰§è¡Œ
ps -ef | grep python
# ä¼šçœ‹åˆ°çŠ¶æ€ä¸º Z+ æˆ– <defunct> çš„è¿›ç¨‹
```

#### 4.2.3 é¿å…åƒµå°¸è¿›ç¨‹çš„æ–¹æ³•

* ä½¿ç”¨join()ç­‰å¾…å­è¿›ç¨‹ç»“æŸï¼ 

**æ›´ä¼˜é›…çš„å¤„ç†æ–¹å¼**ï¼š

* ä½¿ç”¨èµ„æºç®¡ç†å™¨ï¼Œé€€å‡ºçš„æ—¶å€™è‡ªåŠ¨çš„ç»ˆæ­¢æ‰€æœ‰å­è¿›ç¨‹

```python
import multiprocessing
import os
import time
from contextlib import contextmanager

@contextmanager
def managed_processes():
    """è¿›ç¨‹ç®¡ç†å™¨ï¼Œç¡®ä¿æ‰€æœ‰è¿›ç¨‹è¢«æ­£ç¡®æ¸…ç†"""
    processes = []
    try:
        yield processes
    finally:
        # ç­‰å¾…æ‰€æœ‰è¿›ç¨‹ç»“æŸ
        for process in processes:
            if process.is_alive():
                process.join(timeout=5)  # æœ€å¤šç­‰å¾…5ç§’
                if process.is_alive():
                    process.terminate()  # å¼ºåˆ¶ç»ˆæ­¢
                    process.join()
        print("æ‰€æœ‰è¿›ç¨‹å·²æ¸…ç†å®Œæ¯•")

def worker_task(name, duration):
    print(f"å·¥ä½œè¿›ç¨‹ {name} å¼€å§‹ï¼ŒPID: {os.getpid()}")
    time.sleep(duration)
    print(f"å·¥ä½œè¿›ç¨‹ {name} å®Œæˆ")

if __name__ == '__main__':
    with managed_processes() as processes:
        # åˆ›å»ºå¤šä¸ªè¿›ç¨‹
        for i in range(3):
            p = multiprocessing.Process(
                target=worker_task,
                args=(f"Task-{i+1}", 2)
            )
            p.start()
            processes.append(p)

        print("æ‰€æœ‰è¿›ç¨‹å·²å¯åŠ¨ï¼Œç­‰å¾…å®Œæˆ...")

    print("ç¨‹åºç»“æŸï¼Œæ— åƒµå°¸è¿›ç¨‹")
```

### 4.3 å®ˆæŠ¤è¿›ç¨‹ï¼ˆæ³¨æ„å’Œç³»ç»Ÿçš„å®ˆæŠ¤è¿›ç¨‹ä¸åŒï¼‰

**å®ˆæŠ¤è¿›ç¨‹ï¼ˆDaemon Processï¼‰**ä¹Ÿå«ç²¾çµè¿›ç¨‹ï¼Œæ˜¯ä¸€ç§ç‰¹æ®Šçš„è¿›ç¨‹ï¼Œä¸€èˆ¬åœ¨åå°è¿è¡Œï¼Œä¸ä¸ä»»ä½•æ§åˆ¶ç»ˆç«¯ç›¸å…³è”ï¼Œå¹¶ä¸”å‘¨æœŸæ€§åœ°æ‰§è¡ŒæŸç§ä»»åŠ¡æˆ–ç­‰å¾…å¤„ç†æŸäº›å‘ç”Ÿçš„äº‹ä»¶ã€‚

#### 4.3.1 å®ˆæŠ¤è¿›ç¨‹çš„ç‰¹ç‚¹

1. **ç”Ÿå­˜å‘¨æœŸ**ï¼šä¸€èˆ¬å¯åŠ¨äº†ä»¥åå°±ä¼šä¸€ç›´é©»ç•™åœ¨æ“ä½œç³»ç»Ÿä¸­ï¼Œç›´åˆ°**ä¸»è¿›ç¨‹ç»“æŸ**ã€‚
2. **è‡ªåŠ¨ç»“æŸ**ï¼šä¸»è¿›ç¨‹åˆ›å»ºäº†å®ˆæŠ¤è¿›ç¨‹ä»¥åï¼Œå®ˆæŠ¤è¿›ç¨‹ä½œä¸ºä¸€ä¸ªç‰¹æ®Šçš„å­è¿›ç¨‹ä¼šéšç€ä¸»è¿›ç¨‹çš„ä»£ç ç»“æŸè€Œè‡ªåŠ¨ç»“æŸã€‚
3. **è¿›ç¨‹é™åˆ¶**ï¼šå®ˆæŠ¤è¿›ç¨‹å†…ä¸å…è®¸å†å¼€å­è¿›ç¨‹ï¼ˆå­™å­è¿›ç¨‹ï¼‰ã€‚
4. **ç»ˆç«¯ç‹¬ç«‹**ï¼šå®ˆæŠ¤è¿›ç¨‹æ˜¯åœ¨åå°è¿è¡Œï¼Œå’Œç»ˆç«¯æ— å…³è”ï¼Œä¸ä¼šå ç€ç»ˆç«¯ï¼Œç»ˆç«¯å¯ä»¥æ‰§è¡Œå…¶ä»–å‘½ä»¤æˆ–æ“ä½œã€‚

#### 4.3.2 å®ˆæŠ¤è¿›ç¨‹ç¤ºä¾‹

```python
import time
import os
from multiprocessing import Process

def daemon_task():
    """å®ˆæŠ¤è¿›ç¨‹ä»»åŠ¡"""
    print(f"å®ˆæŠ¤è¿›ç¨‹å¯åŠ¨ï¼ŒPID: {os.getpid()}")
    count = 0
    while True:
        count += 1
        print(f"å®ˆæŠ¤è¿›ç¨‹è¿è¡Œä¸­... è®¡æ•°: {count}")
        time.sleep(2)

        # é¿å…æ— é™è¿è¡Œï¼Œå®é™…å®ˆæŠ¤è¿›ç¨‹é€šå¸¸æ˜¯æ— é™å¾ªç¯
        if count >= 10:
            print("å®ˆæŠ¤è¿›ç¨‹è¾¾åˆ°æœ€å¤§è®¡æ•°ï¼Œå‡†å¤‡ç»“æŸ")
            break

if __name__ == '__main__':
    print(f"ä¸»è¿›ç¨‹PID: {os.getpid()}")

    # åˆ›å»ºå®ˆæŠ¤è¿›ç¨‹
    daemon_process = Process(target=daemon_task)
    daemon_process.daemon = True  # è®¾ç½®ä¸ºå®ˆæŠ¤è¿›ç¨‹ï¼Œå¿…é¡»åœ¨start()ä¹‹å‰è®¾ç½®
    daemon_process.start()

    print("ä¸»è¿›ç¨‹ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡...")

    # ä¸»è¿›ç¨‹æ‰§è¡Œä¸€äº›ä»»åŠ¡
    for i in range(5):
        time.sleep(1)
        print(f"ä¸»è¿›ç¨‹å·¥ä½œä¸­... {i+1}/5")

    print("ä¸»è¿›ç¨‹å³å°†ç»“æŸ")
    time.sleep(1)
    print("ä¸»è¿›ç¨‹ç»“æŸ - å®ˆæŠ¤è¿›ç¨‹ä¹Ÿä¼šè‡ªåŠ¨ç»“æŸ")

    # æ³¨æ„ï¼šä¸éœ€è¦è°ƒç”¨ daemon_process.join()
    # å› ä¸ºå®ˆæŠ¤è¿›ç¨‹ä¼šéšä¸»è¿›ç¨‹ç»“æŸè€Œè‡ªåŠ¨ç»“æŸ
```

#### 4.3.3 å®ˆæŠ¤è¿›ç¨‹ vs æ™®é€šå­è¿›ç¨‹

| ç‰¹æ€§                  | æ™®é€šå­è¿›ç¨‹                                       | å®ˆæŠ¤è¿›ç¨‹ (`daemon=True`)                                     |
| --------------------- | ------------------------------------------------ | ------------------------------------------------------------ |
| **ç”Ÿå‘½å‘¨æœŸ**          | ç‹¬ç«‹è¿è¡Œï¼Œä¸»è¿›ç¨‹ç»“æŸåä»å¯ç»§ç»­æ‰§è¡Œï¼Œç›´åˆ°ä»»åŠ¡å®Œæˆ | éšä¸»è¿›ç¨‹ç»“æŸè€Œå¼ºåˆ¶ç»ˆæ­¢                                       |
| **ç”¨é€”**              | æ‰§è¡Œä¸»è¦ä»»åŠ¡æˆ–éœ€è¦ä¿è¯å®Œæˆçš„å·¥ä½œ                 | æ‰§è¡Œè¾…åŠ©æ€§æˆ–åå°ä»»åŠ¡ï¼Œä¸ä¿è¯å®Œæˆ                             |
| **ä¸»è¿›ç¨‹ç­‰å¾…**        | é»˜è®¤æƒ…å†µä¸‹ï¼Œ`join()` å¯ç­‰å¾…å…¶å®Œæˆ                | ä¸»è¿›ç¨‹é€€å‡ºæ—¶è‡ªåŠ¨ç»“æŸï¼Œ`join()` å¯ç­‰å¾…ï¼Œä½†ä¸»è¿›ç¨‹ç»“æŸå‰å¯èƒ½è¢«ç»ˆæ­¢ |
| **ä¸ç»ˆç«¯/è¾“å‡ºçš„å…³ç³»** | å¯ç»§æ‰¿ä¸»è¿›ç¨‹ç»ˆç«¯ï¼Œè¾“å‡ºå¯è§                       | ä¸ä¾èµ–ç»ˆç«¯ï¼Œé€šå¸¸ç”¨äºåå°è¾…åŠ©ä»»åŠ¡                             |
| **åˆ›å»ºæ–¹å¼**          | `Process(target=func)`                           | `p = Process(target=func); p.daemon = True`                  |
| **å…¸å‹åº”ç”¨**          | æ•°æ®å¤„ç†ã€è®¡ç®—ä»»åŠ¡ã€æ–‡ä»¶æ“ä½œ                     | æ—¥å¿—è®°å½•ã€çŠ¶æ€ç›‘æ§ã€å®šæ—¶æ¸…ç†ã€åå°è½®è¯¢                       |

## 5. è¿›ç¨‹åˆ›å»ºä¸ç®¡ç†

### 5.1 os.fork() çš„å·¥ä½œåŸç†

`os.fork()` æ˜¯åŸºäº Linux/Unix ç³»ç»Ÿçš„ç³»ç»Ÿè°ƒç”¨ï¼Œå®ƒç”¨äºåˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ã€‚Windows ç³»ç»Ÿä¸æ”¯æŒ `fork()`ï¼Œå› æ­¤åœ¨ Windows ä¸‹æ‰§è¡Œæ—¶ä¼šæŠ¥é”™ã€‚

#### 5.1.1 fork() å·¥ä½œæœºåˆ¶

* çˆ¶è¿›ç¨‹è¿”å›çš„æ˜¯å­è¿›ç¨‹çš„pid
* å­è¿›ç¨‹è¿”å›çš„æ˜¯çˆ¶è¿›ç¨‹çš„pidï¼Œå›ºå®šä¸º0

```mermaid
sequenceDiagram
    participant ä¸»è¿›ç¨‹ as Main Process
    participant OS as Operating System
    participant å­è¿›ç¨‹ as Child Process

    ä¸»è¿›ç¨‹->>OS: è°ƒç”¨ os.fork()
    OS->>OS: å¤åˆ¶è¿›ç¨‹å†…å­˜ç©ºé—´
    OS->>å­è¿›ç¨‹: åˆ›å»ºæ–°è¿›ç¨‹
    OS->>ä¸»è¿›ç¨‹: è¿”å›å­è¿›ç¨‹PID
    OS->>å­è¿›ç¨‹: è¿”å›0

    Note over ä¸»è¿›ç¨‹: pid != 0 (å­è¿›ç¨‹PID)
    Note over å­è¿›ç¨‹: pid == 0

    ä¸»è¿›ç¨‹->>ä¸»è¿›ç¨‹: æ‰§è¡Œçˆ¶è¿›ç¨‹ä»£ç åˆ†æ”¯
    å­è¿›ç¨‹->>å­è¿›ç¨‹: æ‰§è¡Œå­è¿›ç¨‹ä»£ç åˆ†æ”¯
```

#### 5.1.2 åŸºç¡€ç¤ºä¾‹

* åˆ›å»ºå­è¿›ç¨‹
* åˆ›å»ºå­è¿›ç¨‹çš„æ—¶å€™ï¼Œå­è¿›ç¨‹ä¸­è¿”å›çš„0ï¼Œçˆ¶è¿›ç¨‹è¿”å›çš„æ˜¯å­è¿›ç¨‹çš„PIDï¼ˆå› ä¸ºä¸€ä¸ªçˆ¶è¿›ç¨‹å¯èƒ½ä¼šæœ‰å¤šä¸ªå­è¿›ç¨‹ï¼‰

```python
import os

if __name__ == '__main__':
    w = 100
    print(f"forkå‰: PID={os.getpid()}, w={w}")

    pid = os.fork()  # åˆ›å»ºå­è¿›ç¨‹

    if pid == 0:
        # å­è¿›ç¨‹æ‰§è¡Œçš„ä»£ç 
        w = 200  # å­è¿›ç¨‹ä¿®æ”¹å˜é‡ï¼ˆä¸å½±å“çˆ¶è¿›ç¨‹ï¼‰
        print(f"å­è¿›ç¨‹: PID={os.getpid()}, PPID={os.getppid()}, w={w}")
        print("å­è¿›ç¨‹å·¥ä½œå®Œæˆ")
    else:
        # çˆ¶è¿›ç¨‹æ‰§è¡Œçš„ä»£ç 
        print(f"çˆ¶è¿›ç¨‹: PID={os.getpid()}, åˆ›å»ºäº†å­è¿›ç¨‹PID={pid}")
        print(f"çˆ¶è¿›ç¨‹: w={w}")  # çˆ¶è¿›ç¨‹çš„wä»ç„¶æ˜¯100

        # ç­‰å¾…å­è¿›ç¨‹ç»“æŸ
        os.waitpid(pid, 0)  # 0ä»£è¡¨é˜»å¡ç­‰å¾…å­è¿›ç¨‹ç»“æŸ
        print("çˆ¶è¿›ç¨‹ï¼šå­è¿›ç¨‹å·²ç»“æŸ")
```

#### 5.1.3 fork() çš„ä¼˜ç¼ºç‚¹

**ä¼˜ç‚¹**ï¼š

- åˆ›å»ºé€Ÿåº¦å¿«ï¼ˆå†™æ—¶å¤åˆ¶æœºåˆ¶ï¼‰
- å®Œå…¨çš„å†…å­˜éš”ç¦»ï¼Œå®‰å…¨æ€§é«˜
- ç¬¦åˆUnixå“²å­¦çš„ç®€æ´è®¾è®¡

**ç¼ºç‚¹**ï¼š

- ä»…æ”¯æŒUnix/Linuxç³»ç»Ÿ
- å†…å­˜ä½¿ç”¨é‡è¾ƒå¤§ï¼ˆè™½ç„¶æœ‰å†™æ—¶å¤åˆ¶ä¼˜åŒ–ï¼‰
- ä¸é€‚åˆéœ€è¦å…±äº«å¤§é‡æ•°æ®çš„åœºæ™¯
- fork åå¦‚æœä¸ `wait()` / `waitpid()` å›æ”¶å­è¿›ç¨‹ â†’ å­è¿›ç¨‹å˜**åƒµå°¸è¿›ç¨‹**

### 5.2 multiprocessing å®ç°å¤šè¿›ç¨‹

`multiprocessing` æ¨¡å—æ˜¯ Python æä¾›çš„å¤šè¿›ç¨‹åº“ï¼Œå®ƒæä¾›äº†æ¯” `os.fork()` æ›´ä¸°å¯Œçš„åŠŸèƒ½ï¼Œå¹¶ä¸”èƒ½åœ¨ Windows å’Œ Linux ä¸‹è·¨å¹³å°ä½¿ç”¨ã€‚

#### 5.2.1 åŸºç¡€ç”¨æ³•

* åˆ›å»ºå¹¶ç­‰å¾…å­è¿›ç¨‹æ‰§è¡Œç»“æŸ

```python
import os
import time
import multiprocessing

def worker_task(name, duration):
    """å·¥ä½œè¿›ç¨‹ä»»åŠ¡"""
    print(f"è¿›ç¨‹ {name} å¼€å§‹å·¥ä½œï¼ŒPID: {os.getpid()}")

    for i in range(duration):
        time.sleep(1)
        print(f"è¿›ç¨‹ {name} å·¥ä½œä¸­... {i+1}/{duration}")

    print(f"è¿›ç¨‹ {name} å·¥ä½œå®Œæˆ")
    return f"è¿›ç¨‹ {name} çš„ç»“æœ"

if __name__ == '__main__':
    print(f"ä¸»è¿›ç¨‹PID: {os.getpid()}")

    # åˆ›å»ºè¿›ç¨‹
    process = multiprocessing.Process(
        target=worker_task,
        args=("Worker-1", 3)
    )

    print("å¯åŠ¨å­è¿›ç¨‹...")
    process.start()

    print("ä¸»è¿›ç¨‹ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡")
    time.sleep(1)

    print("ç­‰å¾…å­è¿›ç¨‹ç»“æŸ...")
    process.join()

    print("æ‰€æœ‰ä»»åŠ¡å®Œæˆ")
```

#### 5.2.2 Processç±»çš„æ–¹æ³•å’Œå±æ€§

**å¸¸ç”¨æ–¹æ³•**ï¼š

| æ–¹æ³•å            | æè¿°                                                         |
| :---------------- | :----------------------------------------------------------- |
| p.start()         | åœ¨ä¸»è¿›ç¨‹ä¸­å¯åŠ¨å­è¿›ç¨‹pï¼Œå¹¶è°ƒç”¨è¯¥å­è¿›ç¨‹pä¸­çš„run()æ–¹æ³•          |
| p.run()           | å­è¿›ç¨‹på¯åŠ¨æ—¶è¿è¡Œçš„æ–¹æ³•ï¼Œå»è°ƒç”¨startæ–¹æ³•çš„å‚æ•°targetæŒ‡å®šçš„å‡½æ•°/æ–¹æ³• |
| p.join([timeout]) | ä¸»è¿›ç¨‹ç­‰å¾…å­è¿›ç¨‹ç»“æŸï¼Œå¯æŒ‡å®šè¶…æ—¶æ—¶é—´                         |
| p.terminate()     | å¼ºåˆ¶ç»ˆæ­¢å­è¿›ç¨‹pï¼ˆéœ€è¦è°¨æ…ä½¿ç”¨ï¼‰                              |
| p.is_alive()      | æ£€æµ‹è¿›ç¨‹æ˜¯å¦è¿˜å­˜æ´»                                           |
| p.kill()          | å¼ºåˆ¶æ€æ­»è¿›ç¨‹ï¼ˆPython 3.7+ï¼‰                                  |

**å¸¸ç”¨å±æ€§**ï¼š

| å±æ€§å     | æè¿°                                  |
| :--------- | :------------------------------------ |
| p.name     | è¿›ç¨‹çš„åç§°                            |
| p.pid      | è¿›ç¨‹çš„å”¯ä¸€æ ‡è¯†ç¬¦                      |
| p.daemon   | æ˜¯å¦ä¸ºå®ˆæŠ¤è¿›ç¨‹ï¼ˆå¿…é¡»åœ¨start()å‰è®¾ç½®ï¼‰ |
| p.exitcode | è¿›ç¨‹çš„é€€å‡ºç                           |

#### 5.2.3 ä¼ é€’å‚æ•°ï¼ˆåŒºåˆ«äºipcï¼Œåªæ˜¯åœ¨è¿è¡Œçš„æ—¶å€™ä¼ é€’å‚æ•°ï¼‰

1. **args å¿…é¡»é¡ºåºæ­£ç¡®**ï¼šä½ç½®å‚æ•°æ˜¯é é¡ºåºåŒ¹é…çš„ã€‚
   - å¦‚æœ `args=("å¼ ä¸‰",)` åªç»™äº†ä¸€ä¸ªå‚æ•°ï¼Œå°±ä¼šæŠ¥é”™ç¼ºå°‘ `age`ã€‚
2. **kwargs å¿…é¡»åå­—æ­£ç¡®**ï¼šå…³é”®å­—å‚æ•°è¦å’Œå‡½æ•°ç­¾åé‡Œçš„å‚æ•°åä¸€è‡´ã€‚
   - å¦‚æœå†™é”™ `{"nam": "æå››"}` ä¼šæŠ¥é”™ `unexpected keyword argument 'nam'`ã€‚
3. **æ··åˆæ—¶ï¼Œargs å…ˆåŒ¹é…å‰é¢çš„ä½ç½®å‚æ•°ï¼Œkwargs è´Ÿè´£è¡¥å……/è¦†ç›–**ã€‚

```python
import multiprocessing

def task_with_args(name, age, city="Unknown", **kwargs):
    """æ¥æ”¶ä¸åŒç±»å‹å‚æ•°çš„ä»»åŠ¡"""
    print(f"å§“å: {name}, å¹´é¾„: {age}, åŸå¸‚: {city}")
    print(f"å…¶ä»–ä¿¡æ¯: {kwargs}")

def demonstrate_arguments():
    """æ¼”ç¤ºä¸åŒçš„å‚æ•°ä¼ é€’æ–¹å¼"""
    processes = []

    # æ–¹å¼1: ä½¿ç”¨argsä¼ é€’ä½ç½®å‚æ•°
    p1 = multiprocessing.Process(
        target=task_with_args,
        args=("å¼ ä¸‰", 25)
    )

    # æ–¹å¼2: ä½¿ç”¨kwargsä¼ é€’å…³é”®å­—å‚æ•°
    p2 = multiprocessing.Process(
        target=task_with_args,
        kwargs={"name": "æå››", "age": 30, "city": "åŒ—äº¬"}
    )

    # æ–¹å¼3: æ··åˆä½¿ç”¨
    p3 = multiprocessing.Process(
        target=task_with_args,
        args=("ç‹äº”", 28),
        kwargs={"city": "ä¸Šæµ·", "job": "ç¨‹åºå‘˜", "hobby": "ç¼–ç¨‹"}
    )

    processes = [p1, p2, p3]

    # å¯åŠ¨å¹¶ç­‰å¾…æ‰€æœ‰è¿›ç¨‹
    for p in processes:
        p.start()

    for p in processes:
        p.join()

if __name__ == '__main__':
    demonstrate_arguments()
```

### 5.3 è‡ªå®šä¹‰Processç±»

#### 5.3.1 ç»§æ‰¿Processç±»

* é‡å†™runï¼Œè‡ªå®šä¹‰è¿è¡Œé€»è¾‘ï¼

```python
import os
import time
from multiprocessing import Process, current_process

class CustomWorker(Process):
    """è‡ªå®šä¹‰å·¥ä½œè¿›ç¨‹ç±»"""

    def __init__(self, task_name, work_duration, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.task_name = task_name
        self.work_duration = work_duration
        self.result = None

    def run(self):
        """é‡å†™runæ–¹æ³•ï¼Œå®šä¹‰è¿›ç¨‹è¦æ‰§è¡Œçš„ä»»åŠ¡"""
        current = current_process()
        print(f"è‡ªå®šä¹‰è¿›ç¨‹ {current.name} å¼€å§‹æ‰§è¡Œä»»åŠ¡: {self.task_name}")
        print(f"è¿›ç¨‹PID: {os.getpid()}")

        # æ‰§è¡Œå…·ä½“ä»»åŠ¡
        for i in range(self.work_duration):
            time.sleep(1)
            print(f"{current.name} - {self.task_name} è¿›åº¦: {i+1}/{self.work_duration}")

        self.result = f"{self.task_name} å®Œæˆ"
        print(f"è‡ªå®šä¹‰è¿›ç¨‹ {current.name} ä»»åŠ¡å®Œæˆ")

class DataProcessor(Process):
    """æ•°æ®å¤„ç†è¿›ç¨‹ç±»"""

    def __init__(self, data_list, process_func, name=None):
        super().__init__(name=name)
        self.data_list = data_list
        self.process_func = process_func
        self.processed_data = []

    def run(self):
        """å¤„ç†æ•°æ®"""
        print(f"æ•°æ®å¤„ç†è¿›ç¨‹ {self.name} å¼€å§‹å¤„ç† {len(self.data_list)} ä¸ªæ•°æ®é¡¹")

        for i, data in enumerate(self.data_list):
            processed = self.process_func(data)
            self.processed_data.append(processed)
            print(f"{self.name}: å¤„ç† {i+1}/{len(self.data_list)} - {data} -> {processed}")
            time.sleep(0.5)

        print(f"æ•°æ®å¤„ç†è¿›ç¨‹ {self.name} å®Œæˆ")

def square(x):
    """å¹³æ–¹å‡½æ•°"""
    return x * x

def demonstrate_custom_process():
    """æ¼”ç¤ºè‡ªå®šä¹‰è¿›ç¨‹ç±»"""
    print(f"ä¸»è¿›ç¨‹PID: {os.getpid()}")

    # åˆ›å»ºè‡ªå®šä¹‰å·¥ä½œè¿›ç¨‹
    workers = [
        CustomWorker("æ•°æ®æ¸…æ´—", 3, name="Cleaner"),
        CustomWorker("æ•°æ®åˆ†æ", 4, name="Analyzer"),
        CustomWorker("æŠ¥å‘Šç”Ÿæˆ", 2, name="Reporter")
    ]

    # åˆ›å»ºæ•°æ®å¤„ç†è¿›ç¨‹
    data_processor = DataProcessor(
        data_list=[1, 2, 3, 4, 5],
        process_func=square,
        name="DataProcessor"
    )

    all_processes = workers + [data_processor]

    # å¯åŠ¨æ‰€æœ‰è¿›ç¨‹
    for p in all_processes:
        p.start()
        print(f"å¯åŠ¨è¿›ç¨‹: {p.name}")

    # ç­‰å¾…æ‰€æœ‰è¿›ç¨‹å®Œæˆ
    for p in all_processes:
        p.join()
        print(f"è¿›ç¨‹ {p.name} å·²ç»“æŸ")

    print("æ‰€æœ‰è‡ªå®šä¹‰è¿›ç¨‹å·²å®Œæˆ")

if __name__ == '__main__':
    demonstrate_custom_process()
```

### 5.4 Windows ç³»ç»Ÿç‰¹æ®Šå¤„ç†

åœ¨ Windows ä¸‹ï¼ŒPython ä½¿ç”¨ `multiprocessing` æ¨¡å—æ—¶ä¼šé€šè¿‡å¯¼å…¥çˆ¶è¿›ç¨‹çš„ä»£ç æ¥åˆ›å»ºå­è¿›ç¨‹ï¼Œå› æ­¤éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

#### 5.4.1 Windowsä¸‹çš„è¿›ç¨‹åˆ›å»ºæœºåˆ¶

```mermaid
sequenceDiagram
    participant Main as ä¸»ç¨‹åº
    participant OS as Windows OS
    participant Child as å­è¿›ç¨‹
    participant Interpreter as Pythonè§£é‡Šå™¨

    Main->>OS: è°ƒç”¨ Process.start()
    OS->>Interpreter: å¯åŠ¨æ–°çš„Pythonè§£é‡Šå™¨
    Interpreter->>Main: é‡æ–°å¯¼å…¥ä¸»æ¨¡å—
    Note over Main: æ‰§è¡Œæ‰€æœ‰æ¨¡å—çº§ä»£ç 
    Interpreter->>Child: æ‰¾åˆ°targetå‡½æ•°å¹¶æ‰§è¡Œ
    Child->>Child: æ‰§è¡Œä»»åŠ¡
    Child->>OS: ä»»åŠ¡å®Œæˆï¼Œè¿›ç¨‹ç»“æŸ
```

#### 5.4.2 å¿…é¡»ä½¿ç”¨ `if __name__ == '__main__':`

**é”™è¯¯ç¤ºä¾‹ï¼ˆä¼šå¯¼è‡´æ— é™é€’å½’ï¼‰**ï¼š

```python
# é”™è¯¯ï¼šæ²¡æœ‰ä½¿ç”¨ if __name__ == '__main__'
import multiprocessing

def worker():
    print("å·¥ä½œè¿›ç¨‹æ‰§è¡Œ")

# å±é™©ï¼šåœ¨Windowsä¸‹ä¼šæ— é™åˆ›å»ºè¿›ç¨‹
process = multiprocessing.Process(target=worker)
process.start()
process.join()
```

**æ­£ç¡®ç¤ºä¾‹**ï¼š

```python
import multiprocessing
import os

def worker(name):
    print(f"å·¥ä½œè¿›ç¨‹ {name} æ‰§è¡Œï¼ŒPID: {os.getpid()}")

def safe_windows_example():
    """Windowså®‰å…¨çš„å¤šè¿›ç¨‹ç¤ºä¾‹"""
    print(f"ä¸»è¿›ç¨‹PID: {os.getpid()}")

    processes = []

    for i in range(3):
        p = multiprocessing.Process(
            target=worker,
            args=(f"Worker-{i+1}",)
        )
        processes.append(p)
        p.start()

    for p in processes:
        p.join()

    print("æ‰€æœ‰è¿›ç¨‹å®Œæˆ")

if __name__ == '__main__':
    # åªæœ‰åœ¨ä½œä¸ºä¸»ç¨‹åºè¿è¡Œæ—¶æ‰æ‰§è¡Œå¤šè¿›ç¨‹ä»£ç 
    safe_windows_example()
```

#### 5.4.3 è·¨å¹³å°å…¼å®¹æ€§å¤„ç†

```python
import multiprocessing
import os
import platform

def cross_platform_task(data):
    """è·¨å¹³å°ä»»åŠ¡"""
    system = platform.system()
    pid = os.getpid()
    print(f"ç³»ç»Ÿ: {system}, è¿›ç¨‹PID: {pid}, å¤„ç†æ•°æ®: {data}")
    return data * 2

def get_process_count():
    """æ ¹æ®ç³»ç»Ÿè·å–åˆé€‚çš„è¿›ç¨‹æ•°"""
    cpu_count = multiprocessing.cpu_count()
    system = platform.system()

    if system == "Windows":
        # Windowsä¸‹åˆ›å»ºè¿›ç¨‹å¼€é”€è¾ƒå¤§ï¼Œä½¿ç”¨è¾ƒå°‘çš„è¿›ç¨‹ï¼Œæˆ–æ‰§è¡Œå…¶ä»–çš„æ“ä½œ
        return min(4, cpu_count)
    else:
        # Unix-likeç³»ç»Ÿå¯ä»¥ä½¿ç”¨æ›´å¤šè¿›ç¨‹
        return cpu_count

def cross_platform_demo():
    """è·¨å¹³å°å¤šè¿›ç¨‹æ¼”ç¤º"""
    print(f"å½“å‰ç³»ç»Ÿ: {platform.system()}")
    print(f"CPUæ ¸å¿ƒæ•°: {multiprocessing.cpu_count()}")

    process_count = get_process_count()
    print(f"ä½¿ç”¨è¿›ç¨‹æ•°: {process_count}")

    # å‡†å¤‡æ•°æ®
    data_list = list(range(1, 11))

    # åˆ›å»ºè¿›ç¨‹æ± å¤„ç†æ•°æ®ï¼ˆè¿›ç¨‹æ± å°†åœ¨åé¢è¯¦ç»†ä»‹ç»ï¼‰
    with multiprocessing.Pool(process_count) as pool:
        results = pool.map(cross_platform_task, data_list)

    print(f"å¤„ç†ç»“æœ: {results}")

if __name__ == '__main__':
    cross_platform_demo()
```

## 6. è¿›ç¨‹é—´é€šä¿¡ä¸åŒæ­¥

### 6.1 è¿›ç¨‹æ•°æ®éš”ç¦»

åœ¨æ“ä½œç³»ç»Ÿä¸­ï¼Œçˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹çš„æ•°æ®æ®µæ˜¯éš”ç¦»çš„ã€‚å­è¿›ç¨‹åœ¨åˆ›å»ºæ—¶ä¼šå¤åˆ¶çˆ¶è¿›ç¨‹çš„å†…å­˜ç©ºé—´ï¼Œä½†å®ƒä»¬çš„æ•°æ®æ®µæ˜¯ç‹¬ç«‹çš„ã€‚å³ä½¿çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹æœ‰ç›¸åŒçš„ä»£ç æ®µï¼Œå®ƒä»¬çš„å†…å­˜ä¸­çš„æ•°æ®æ˜¯å„è‡ªç‹¬ç«‹çš„ã€‚

#### 6.1.1 æ•°æ®éš”ç¦»ç¤ºä¾‹

```python
import time, random
from multiprocessing import Process

num = 100

def func():
    global num
    num -= 1

if __name__ == '__main__':
    process_list = []
    for i in range(10):
        p = Process(target=func)
        p.start()
        process_list.append(p)
    t2 = time.time()
    for p in process_list:
        p.join()

    print(num)  # num=?
```



### 6.2 Queue é˜Ÿåˆ—é€šä¿¡

`Queue` æ˜¯ä¸€ä¸ªåŸºäºæ–‡ä»¶ç±»å‹çš„é€šä¿¡é˜Ÿåˆ—å¯¹è±¡ï¼Œå¯ä»¥ç”¨æ¥åœ¨è¿›ç¨‹é—´ä¼ é€’æ•°æ®ã€‚å®ƒæ”¯æŒå…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰æœºåˆ¶ï¼Œå¹¶ä¸”å†…ç½®äº†é”æœºåˆ¶æ¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚

#### 6.2.1 Queue åŸºç¡€ç”¨æ³•

```python
from multiprocessing import Process, Queue
import os
import time

def producer(queue, producer_id, item_count):
    """ç”Ÿäº§è€…è¿›ç¨‹"""
    print(f"ç”Ÿäº§è€… {producer_id} å¼€å§‹ç”Ÿäº§ï¼ŒPID: {os.getpid()}")

    for i in range(item_count):
        item = f"Producer-{producer_id}-Item-{i+1}"
        queue.put(item)
        print(f"ç”Ÿäº§è€… {producer_id} ç”Ÿäº§: {item}")
        time.sleep(0.5)

    # æ”¾å…¥ç»“æŸæ ‡å¿—
    queue.put(f"END-{producer_id}")
    print(f"ç”Ÿäº§è€… {producer_id} å®Œæˆ")

def consumer(queue, consumer_id):
    """æ¶ˆè´¹è€…è¿›ç¨‹"""
    print(f"æ¶ˆè´¹è€… {consumer_id} å¼€å§‹æ¶ˆè´¹ï¼ŒPID: {os.getpid()}")
    consumed_items = []

    while True:
        item = queue.get()  # ä»é˜Ÿåˆ—è·å–æ•°æ®

        if item.startswith("END"):
            print(f"æ¶ˆè´¹è€… {consumer_id} æ”¶åˆ°ç»“æŸä¿¡å·: {item}")
            queue.put(item)  # æŠŠç»“æŸä¿¡å·æ”¾å›å»ï¼Œä¾›å…¶ä»–æ¶ˆè´¹è€…ä½¿ç”¨
            break

        consumed_items.append(item)
        print(f"æ¶ˆè´¹è€… {consumer_id} æ¶ˆè´¹: {item}")
        time.sleep(0.3)

    print(f"æ¶ˆè´¹è€… {consumer_id} å®Œæˆï¼Œå…±æ¶ˆè´¹ {len(consumed_items)} ä¸ªå•†å“")

def queue_demo():
    """é˜Ÿåˆ—é€šä¿¡æ¼”ç¤º"""
    # åˆ›å»ºé˜Ÿåˆ—
    q = Queue(maxsize=10)  # è®¾ç½®æœ€å¤§å®¹é‡

    processes = []

    # åˆ›å»ºç”Ÿäº§è€…è¿›ç¨‹
    for i in range(2):
        p = Process(target=producer, args=(q, i+1, 3))
        p.start()
        processes.append(p)

    # åˆ›å»ºæ¶ˆè´¹è€…è¿›ç¨‹
    for i in range(2):
        p = Process(target=consumer, args=(q, i+1))
        p.start()
        processes.append(p)

    # ç­‰å¾…æ‰€æœ‰è¿›ç¨‹å®Œæˆ
    for p in processes:
        p.join()

    print("æ‰€æœ‰è¿›ç¨‹å®Œæˆ")

if __name__ == '__main__':
    queue_demo()
```

#### 6.2.2 ä½¿ç”¨Queueè¿›è¡Œä»»åŠ¡åˆ†å‘

```python
from multiprocessing import Process, Queue, current_process
import time
import random

def calculate_task(task_data):
    """è®¡ç®—ä»»åŠ¡"""
    task_id, numbers = task_data
    result = sum(x * x for x in numbers)
    time.sleep(random.uniform(0.5, 2.0))  # æ¨¡æ‹Ÿè®¡ç®—æ—¶é—´
    return task_id, result

def worker_process(task_queue, result_queue):
    """å·¥ä½œè¿›ç¨‹"""
    process = current_process()
    print(f"{process.name} å¼€å§‹å·¥ä½œ")

    completed_tasks = 0

    while True:
        try:
            # ä»ä»»åŠ¡é˜Ÿåˆ—è·å–ä»»åŠ¡
            task_data = task_queue.get(timeout=2)

            if task_data is None:  # ç»“æŸæ ‡å¿—
                print(f"{process.name} æ”¶åˆ°ç»“æŸä¿¡å·")
                break

            # æ‰§è¡Œä»»åŠ¡
            task_id, numbers = task_data
            print(f"{process.name} å¤„ç†ä»»åŠ¡ {task_id}")

            result = calculate_task(task_data)

            # å°†ç»“æœæ”¾å…¥ç»“æœé˜Ÿåˆ—
            result_queue.put(result)
            completed_tasks += 1

        except Exception as e:
            print(f"{process.name} å‘ç”Ÿé”™è¯¯: {e}")
            break

    print(f"{process.name} å®Œæˆ {completed_tasks} ä¸ªä»»åŠ¡")

def task_distribution_demo():
    """ä»»åŠ¡åˆ†å‘æ¼”ç¤º"""
    task_queue = Queue()
    result_queue = Queue()

    # å‡†å¤‡ä»»åŠ¡æ•°æ®
    tasks = []
    for i in range(10):
        numbers = [random.randint(1, 100) for _ in range(5)]
        tasks.append((f"Task-{i+1}", numbers))

    # å°†ä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—
    print("æ­£åœ¨åˆ†å‘ä»»åŠ¡...")
    for task in tasks:
        task_queue.put(task)
        print(f"åˆ†å‘ä»»åŠ¡: {task[0]}")

    # åˆ›å»ºå·¥ä½œè¿›ç¨‹
    workers = []
    for i in range(3):
        p = Process(
            target=worker_process,
            args=(task_queue, result_queue),
            name=f"Worker-{i+1}"
        )
        p.start()
        workers.append(p)

    # ç­‰å¾…ä¸€æ®µæ—¶é—´åå‘é€ç»“æŸä¿¡å·
    time.sleep(1)
    for _ in workers:
        task_queue.put(None)  # å‘é€ç»“æŸä¿¡å·

    # æ”¶é›†ç»“æœ
    print("æ­£åœ¨æ”¶é›†ç»“æœ...")
    results = []
    for _ in tasks:
        result = result_queue.get()
        results.append(result)
        print(f"æ”¶åˆ°ç»“æœ: {result}")

    # ç­‰å¾…æ‰€æœ‰å·¥ä½œè¿›ç¨‹å®Œæˆ
    for p in workers:
        p.join()

    print(f"æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼Œå…±æ”¶åˆ° {len(results)} ä¸ªç»“æœ")

if __name__ == '__main__':
    task_distribution_demo()
```

### 6.3 Pipe ç®¡é“é€šä¿¡

`Pipe` æ˜¯ä¸€ä¸ªåŸºäºæ–‡ä»¶ç±»å‹çš„**åŒå‘é€šä¿¡ç®¡é“**ï¼Œå…è®¸åœ¨ä¸¤ä¸ªè¿›ç¨‹é—´ä¼ é€’æ•°æ®ã€‚ä¸ `Queue` ä¸åŒï¼Œ`Pipe` æ²¡æœ‰å…ˆè¿›å…ˆå‡ºçš„æœºåˆ¶ï¼Œå¹¶ä¸”æ²¡æœ‰å†…ç½®é”ã€‚

#### 6.3.1 Pipe åŸºç¡€ç”¨æ³•

```python
from multiprocessing import Process, Pipe
import os
import time

def sender_process(conn, sender_id):
    """å‘é€è€…è¿›ç¨‹"""
    print(f"å‘é€è€… {sender_id} å¼€å§‹ï¼ŒPID: {os.getpid()}")

    messages = [
        f"Hello from {sender_id}",
        f"Message 1 from {sender_id}",
        f"Message 2 from {sender_id}",
        {"type": "data", "sender": sender_id, "value": 42},
        [1, 2, 3, 4, 5]
    ]

    for i, msg in enumerate(messages):
        conn.send(msg)
        print(f"å‘é€è€… {sender_id} å‘é€: {msg}")
        time.sleep(0.5)

    # å‘é€ç»“æŸä¿¡å·
    conn.send("END")
    conn.close()
    print(f"å‘é€è€… {sender_id} å®Œæˆ")

def receiver_process(conn, receiver_id):
    """æ¥æ”¶è€…è¿›ç¨‹"""
    print(f"æ¥æ”¶è€… {receiver_id} å¼€å§‹ï¼ŒPID: {os.getpid()}")
    received_count = 0

    while True:
        try:
            msg = conn.recv()
            if msg == "END":
                print(f"æ¥æ”¶è€… {receiver_id} æ”¶åˆ°ç»“æŸä¿¡å·")
                break

            received_count += 1
            print(f"æ¥æ”¶è€… {receiver_id} æ¥æ”¶: {msg} (ç±»å‹: {type(msg).__name__})")

        except EOFError:
            print(f"æ¥æ”¶è€… {receiver_id} è¿æ¥å…³é—­")
            break

    conn.close()
    print(f"æ¥æ”¶è€… {receiver_id} å®Œæˆï¼Œå…±æ¥æ”¶ {received_count} æ¡æ¶ˆæ¯")

def simple_pipe_demo():
    """ç®€å•çš„Pipeæ¼”ç¤º"""
    # åˆ›å»ºç®¡é“
    parent_conn, child_conn = Pipe()

    # åˆ›å»ºå‘é€è€…å’Œæ¥æ”¶è€…è¿›ç¨‹
    sender = Process(target=sender_process, args=(child_conn, "Sender-1"))
    receiver = Process(target=receiver_process, args=(parent_conn, "Receiver-1"))

    # å¯åŠ¨è¿›ç¨‹
    sender.start()
    receiver.start()

    # ç­‰å¾…å®Œæˆ
    sender.join()
    receiver.join()

    print("ç®€å•Pipeæ¼”ç¤ºå®Œæˆ")

if __name__ == '__main__':
    simple_pipe_demo()
```

#### 6.3.2 åŒå‘é€šä¿¡ç¤ºä¾‹

```python
from multiprocessing import Process, Pipe
import time
import random

def interactive_process(conn, process_name, message_count):
    """äº¤äº’è¿›ç¨‹ï¼Œæ—¢å‘é€ä¹Ÿæ¥æ”¶æ¶ˆæ¯"""
    print(f"{process_name} å¼€å§‹äº¤äº’")

    for i in range(message_count):
        # å‘é€æ¶ˆæ¯
        message = f"{process_name} çš„æ¶ˆæ¯ {i+1}: {random.randint(1, 100)}"
        conn.send(message)
        print(f"{process_name} å‘é€: {message}")

        # ç­‰å¾…å¹¶æ¥æ”¶å“åº”
        try:
            if conn.poll(timeout=2):  # ç­‰å¾…2ç§’
                response = conn.recv()
                print(f"{process_name} æ¥æ”¶: {response}")
            else:
                print(f"{process_name} æ²¡æœ‰æ”¶åˆ°å“åº”")
        except:
            print(f"{process_name} æ¥æ”¶å¼‚å¸¸")

        time.sleep(0.5)

    # å‘é€ç»“æŸä¿¡å·
    conn.send("FINISH")
    print(f"{process_name} å®Œæˆ")

def bidirectional_pipe_demo():
    """åŒå‘é€šä¿¡æ¼”ç¤º"""
    conn1, conn2 = Pipe()

    # åˆ›å»ºä¸¤ä¸ªäº¤äº’è¿›ç¨‹
    p1 = Process(target=interactive_process, args=(conn1, "Process-A", 3))
    p2 = Process(target=interactive_process, args=(conn2, "Process-B", 3))

    p1.start()
    p2.start()

    p1.join()
    p2.join()

    print("åŒå‘é€šä¿¡æ¼”ç¤ºå®Œæˆ")

if __name__ == '__main__':
    bidirectional_pipe_demo()
```

### 6.4 Queue vs Pipe å¯¹æ¯”

```mermaid
graph TD
    A[è¿›ç¨‹é—´é€šä¿¡æ–¹å¼] --> B[Queue é˜Ÿåˆ—]
    A --> C[Pipe ç®¡é“]

    B --> B1[ç‰¹ç‚¹<br/>- FIFOæœºåˆ¶<br/>- å†…ç½®é”<br/>- æ”¯æŒå¤šè¿›ç¨‹<br/>- çº¿ç¨‹å®‰å…¨]
    C --> C1[ç‰¹ç‚¹<br/>- åŒå‘é€šä¿¡<br/>- æ— å†…ç½®é”<br/>- ä»…æ”¯æŒä¸¤ä¸ªè¿›ç¨‹<br/>- é€Ÿåº¦æ›´å¿«]

    B --> B2[é€‚ç”¨åœºæ™¯<br/>- å¤šç”Ÿäº§è€…/æ¶ˆè´¹è€…<br/>- ä»»åŠ¡åˆ†å‘<br/>- å·¥ä½œé˜Ÿåˆ—]
    C --> C2[é€‚ç”¨åœºæ™¯<br/>- çˆ¶å­è¿›ç¨‹é€šä¿¡<br/>- å®æ—¶æ•°æ®äº¤æ¢<br/>- ç®€å•é€šä¿¡]

    style B1 fill:#ccffcc
    style C1 fill:#ffffcc
```

**å¯¹æ¯”è¡¨**ï¼š

| ç‰¹æ€§     | Queue        | Pipe     |
| :------- | :----------- | :------- |
| é€šä¿¡æ¨¡å¼ | å¤šå¯¹å¤š       | ä¸€å¯¹ä¸€   |
| æ•°æ®ç»“æ„ | FIFOé˜Ÿåˆ—     | åŒå‘é€šé“ |
| çº¿ç¨‹å®‰å…¨ | æ˜¯ï¼ˆå†…ç½®é”ï¼‰ | å¦       |
| æ€§èƒ½     | è¾ƒæ…¢         | è¾ƒå¿«     |
| å†…å­˜ä½¿ç”¨ | è¾ƒå¤§         | è¾ƒå°     |
| ç¼“å†²æ”¯æŒ | æ”¯æŒmaxsize  | æ—        |
| å¤æ‚åº¦   | è¾ƒå¤æ‚       | ç®€å•     |

### 6.5 è¿›ç¨‹é”æœºåˆ¶

åœ¨å¤šè¿›ç¨‹ç¯å¢ƒä¸­ï¼Œå¤šä¸ªè¿›ç¨‹è®¿é—®å…±äº«èµ„æºæ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œå¯ä»¥ä½¿ç”¨ **é”** æ¥åŒæ­¥å¤šä¸ªè¿›ç¨‹å¯¹å…±äº«èµ„æºçš„è®¿é—®ã€‚

#### 6.5.1 æ²¡æœ‰é”çš„é—®é¢˜æ¼”ç¤º

```python
import json
import time
import os
from multiprocessing import Process

def get_ticket_info(username):
    """æŸ¥è¯¢ä½™ç¥¨"""
    with open("ticket.json", "r") as f:
        data = json.load(f)
        print(f"{username} æŸ¥è¯¢ä½™ç¥¨ï¼š{data['count']} å¼ ")
        return data['count']

def buy_ticket_unsafe(username):
    """ä¸å®‰å…¨çš„è´­ç¥¨æ“ä½œ"""
    print(f"{username} å¼€å§‹è´­ç¥¨æµç¨‹")

    # æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
    time.sleep(0.1)

    # è¯»å–ç¥¨æ•°
    with open("ticket.json", "r") as f:
        data = json.load(f)
        print(f"{username} è¯»å–åˆ°ç¥¨æ•°ï¼š{data['count']}")

    if data["count"] > 0:
        # æ¨¡æ‹Ÿè´­ç¥¨å¤„ç†æ—¶é—´
        time.sleep(0.2)

        # å‡å°‘ç¥¨æ•°
        data["count"] -= 1
        print(f"{username} æˆåŠŸè´­ä¹°ç¥¨ï¼ä½™ç¥¨ï¼š{data['count']}")

        # å†™å›æ•°æ®
        with open("ticket.json", "w") as f:
            json.dump(data, f)
    else:
        print(f"{username} è´­ç¥¨å¤±è´¥ï¼ä½™ç¥¨ä¸è¶³")

def prepare_ticket_file():
    """å‡†å¤‡ç¥¨åŠ¡æ•°æ®æ–‡ä»¶"""
    ticket_data = {"count": 5}
    with open("ticket.json", "w") as f:
        json.dump(ticket_data, f)
    print(f"åˆå§‹åŒ–ç¥¨åŠ¡æ•°æ®ï¼š{ticket_data['count']} å¼ ")

def unsafe_ticket_demo():
    """ä¸å®‰å…¨çš„è´­ç¥¨æ¼”ç¤º"""
    print("=== ä¸å®‰å…¨çš„å¤šè¿›ç¨‹è´­ç¥¨æ¼”ç¤º ===")

    # å‡†å¤‡æ•°æ®
    prepare_ticket_file()

    # åˆ›å»ºå¤šä¸ªè´­ç¥¨è¿›ç¨‹
    processes = []
    users = ["Alice", "Bob", "Charlie", "David", "Eve", "Frank", "Grace"]

    for user in users:
        p = Process(target=buy_ticket_unsafe, args=(user,))
        processes.append(p)
        p.start()
        time.sleep(0.05)  # å°å»¶è¿Ÿï¼Œå¢åŠ ç«äº‰æ¦‚ç‡

    # ç­‰å¾…æ‰€æœ‰è¿›ç¨‹å®Œæˆ
    for p in processes:
        p.join()

    # æ£€æŸ¥æœ€ç»ˆç»“æœ
    with open("ticket.json", "r") as f:
        final_data = json.load(f)
        print(f"æœ€ç»ˆä½™ç¥¨ï¼š{final_data['count']} å¼ ")
        print(f"é—®é¢˜ï¼šå¯èƒ½å‡ºç°è¶…å–æƒ…å†µï¼")

    # æ¸…ç†æ–‡ä»¶
    os.remove("ticket.json")

if __name__ == '__main__':
    unsafe_ticket_demo()
```

#### 6.5.2 ä½¿ç”¨Lockè§£å†³é—®é¢˜

* åˆå§‹åŒ–ä¸€æŠŠé”ç„¶åæŠŠé”ä½œä¸ºå‚æ•°ä¼ é€’ç»™è¿›ç¨‹

```python
import json
import time
import os
from multiprocessing import Process, Lock

def buy_ticket_safe(username, lock):
    """å®‰å…¨çš„è´­ç¥¨æ“ä½œï¼ˆä½¿ç”¨é”ï¼‰"""
    print(f"{username} å¼€å§‹è´­ç¥¨æµç¨‹")

    # æŸ¥è¯¢æ“ä½œä¸éœ€è¦é”ï¼ˆåªè¯»ï¼‰
    with open("ticket.json", "r") as f:
        data = json.load(f)
        print(f"{username} æŸ¥è¯¢ä½™ç¥¨ï¼š{data['count']} å¼ ")

    # ä½¿ç”¨é”ä¿æŠ¤è´­ç¥¨æ“ä½œ
    with lock:  # è·å–é”
        print(f"{username} è·å¾—é”ï¼Œå¼€å§‹è´­ç¥¨...")

        # å†æ¬¡è¯»å–ï¼ˆç¡®ä¿æ•°æ®æœ€æ–°ï¼‰
        with open("ticket.json", "r") as f:
            data = json.load(f)

        if data["count"] > 0:
            # æ¨¡æ‹Ÿè´­ç¥¨å¤„ç†æ—¶é—´
            time.sleep(0.1)

            data["count"] -= 1
            print(f"{username} æˆåŠŸè´­ä¹°ç¥¨ï¼ä½™ç¥¨ï¼š{data['count']}")

            # å†™å›æ•°æ®
            with open("ticket.json", "w") as f:
                json.dump(data, f)
        else:
            print(f"{username} è´­ç¥¨å¤±è´¥ï¼ä½™ç¥¨ä¸è¶³")

        print(f"{username} é‡Šæ”¾é”")
    # è‡ªåŠ¨é‡Šæ”¾é”

def safe_ticket_demo():
    """å®‰å…¨çš„è´­ç¥¨æ¼”ç¤º"""
    print("=== å®‰å…¨çš„å¤šè¿›ç¨‹è´­ç¥¨æ¼”ç¤º ===")

    # å‡†å¤‡æ•°æ®
    ticket_data = {"count": 5}
    with open("ticket.json", "w") as f:
        json.dump(ticket_data, f)
    print(f"åˆå§‹åŒ–ç¥¨åŠ¡æ•°æ®ï¼š{ticket_data['count']} å¼ ")

    # åˆ›å»ºé”
    lock = Lock()

    # åˆ›å»ºå¤šä¸ªè´­ç¥¨è¿›ç¨‹
    processes = []
    users = ["Alice", "Bob", "Charlie", "David", "Eve", "Frank", "Grace"]

    for user in users:
        p = Process(target=buy_ticket_safe, args=(user, lock))
        processes.append(p)
        p.start()
        time.sleep(0.05)

    # ç­‰å¾…æ‰€æœ‰è¿›ç¨‹å®Œæˆ
    for p in processes:
        p.join()

    # æ£€æŸ¥æœ€ç»ˆç»“æœ
    with open("ticket.json", "r") as f:
        final_data = json.load(f)
        print(f"æœ€ç»ˆä½™ç¥¨ï¼š{final_data['count']} å¼ ")
        print("ç»“æœï¼šæ­£ç¡®ï¼Œæ²¡æœ‰è¶…å–ï¼")

    # æ¸…ç†æ–‡ä»¶
    os.remove("ticket.json")

if __name__ == '__main__':
    safe_ticket_demo()
```

### 6.6 IPC æ–¹å¼å¯¹æ¯”æ€»ç»“

```mermaid
graph TD
    A[è¿›ç¨‹é—´é€šä¿¡IPCæ–¹å¼] --> B[å†…å­˜å…±äº«ç±»]
    A --> C[æ¶ˆæ¯ä¼ é€’ç±»]
    A --> D[åŒæ­¥åŸè¯­ç±»]

    B --> B1[Queueé˜Ÿåˆ—<br/>Pipeç®¡é“<br/>Value/Array<br/>Manager]
    C --> C1[ä¿¡å·Signal<br/>å¥—æ¥å­—Socket<br/>æ–‡ä»¶File]
    D --> D1[Lockäº’æ–¥é”<br/>RLocké€’å½’é”<br/>Semaphoreä¿¡å·é‡<br/>Eventäº‹ä»¶]

    style B1 fill:#ccffcc
    style C1 fill:#ffffcc
    style D1 fill:#ffcccc
```

**IPCæ–¹å¼å¯¹æ¯”è¡¨**ï¼š

| æ–¹å¼    | å¤æ‚åº¦ | æ€§èƒ½ | å®‰å…¨æ€§ | é€‚ç”¨åœºæ™¯               |
| :------ | :----- | :--- | :----- | :--------------------- |
| Queue   | ä½     | ä¸­   | é«˜     | ä»»åŠ¡åˆ†å‘ã€ç”Ÿäº§è€…æ¶ˆè´¹è€… |
| Pipe    | ä½     | é«˜   | ä¸­     | çˆ¶å­è¿›ç¨‹é€šä¿¡ã€å®æ—¶æ•°æ® |
| Lock    | ä½     | ä¸­   | é«˜     | ä¿æŠ¤å…±äº«èµ„æº           |
| Manager | é«˜     | ä½   | é«˜     | å¤æ‚æ•°æ®å…±äº«           |
| Socket  | é«˜     | é«˜   | ä¸­     | ç½‘ç»œé€šä¿¡ã€è·¨æœºå™¨       |

## 7. è¿›ç¨‹æ± ä¸å­è¿›ç¨‹ç®¡ç†

### 7.1 è¿›ç¨‹æ±  (Pool) è¯¦è§£

å½“éœ€è¦å¯åŠ¨å¤§é‡çš„å­è¿›ç¨‹æ—¶ï¼Œç›´æ¥ä½¿ç”¨ `Process` åˆ›å»ºè¿›ç¨‹å¯èƒ½ä¼šå¯¼è‡´è¿›ç¨‹åˆ›å»ºå’Œç®¡ç†çš„å¼€é”€å˜å¾—è¿‡å¤§ã€‚ä¸ºäº†æé«˜æ•ˆç‡å’Œç®€åŒ–è¿›ç¨‹ç®¡ç†ï¼Œå¯ä»¥ä½¿ç”¨è¿›ç¨‹æ±  (`Pool`) æ¥æ‰¹é‡ç®¡ç†å­è¿›ç¨‹ã€‚

```mermaid
graph TD
    A[è¿›ç¨‹æ± ä¼˜åŠ¿] --> B[èµ„æºç®¡ç†]
    A --> C[ä»»åŠ¡è°ƒåº¦]
    A --> D[æ€§èƒ½ä¼˜åŒ–]

    B --> B1[é™åˆ¶åŒæ—¶è¿è¡Œè¿›ç¨‹æ•°<br/>é¿å…ç³»ç»Ÿè´Ÿæ‹…è¿‡é‡]
    C --> C1[è‡ªåŠ¨åˆ†é…ä»»åŠ¡åˆ°ç©ºé—²è¿›ç¨‹<br/>è¿›ç¨‹å¯é‡å¤ä½¿ç”¨]
    D --> D1[å‡å°‘è¿›ç¨‹åˆ›å»º/é”€æ¯å¼€é”€<br/>æé«˜æ•´ä½“æ€§èƒ½]

    style B1 fill:#ccffcc
    style C1 fill:#ffffcc
    style D1 fill:#ffcccc
```

#### 7.1.1 åŸºç¡€è¿›ç¨‹æ± ç¤ºä¾‹

```python
from multiprocessing import Pool
import os
import time
import random


def cpu_intensive_task(task_data):
    """è®¡ç®—å¯†é›†å‹ä»»åŠ¡"""
    task_id, numbers = task_data
    worker_pid = os.getpid()

    print(f"Task {task_id} å¼€å§‹ - Worker PID: {worker_pid}")

    # æ¨¡æ‹Ÿå¤æ‚è®¡ç®—
    result = 0
    for num in numbers:
        result += sum(i*i for i in range(num))

    # æ¨¡æ‹Ÿå¯å˜è®¡ç®—æ—¶é—´
    time.sleep(random.uniform(0.5, 2.0))

    print(f"Task {task_id} å®Œæˆ - Worker PID: {worker_pid}, Result: {result}")
    return task_id, result, worker_pid


def basic_pool_demo():
    """åŸºç¡€è¿›ç¨‹æ± æ¼”ç¤º"""
    print("=== åŸºç¡€è¿›ç¨‹æ± æ¼”ç¤º ===")
    print(f"ä¸»è¿›ç¨‹PID: {os.getpid()}")

    # å‡†å¤‡ä»»åŠ¡æ•°æ®
    tasks = []
    for i in range(8):
        numbers = [random.randint(50, 200) for _ in range(3)]
        tasks.append((f"Task-{i+1}", numbers))

    # åˆ›å»ºè¿›ç¨‹æ± ï¼ˆæœ€å¤š4ä¸ªè¿›ç¨‹åŒæ—¶æ‰§è¡Œï¼‰
    with Pool(processes=4) as pool:
        print("è¿›ç¨‹æ± å·²åˆ›å»ºï¼Œå¼€å§‹å¤„ç†ä»»åŠ¡...")

        start_time = time.time()

        # ä½¿ç”¨ map æ–¹æ³•æ‰¹é‡å¤„ç†ä»»åŠ¡
        results = pool.map(cpu_intensive_task, tasks)

        end_time = time.time()

    print(f"\næ‰€æœ‰ä»»åŠ¡å®Œæˆï¼Œæ€»è€—æ—¶: {end_time - start_time:.2f}ç§’")
    print("å¤„ç†ç»“æœ:")
    for task_id, result, worker_pid in results:
        print(f"  {task_id}: {result} (Worker: {worker_pid})")


if __name__ == '__main__':
    basic_pool_demo()

```

#### 7.1.2 è¿›ç¨‹æ± çš„ä¸åŒæ–¹æ³•

| æ–¹æ³•                        | ç‰¹ç‚¹                                                  | åœºæ™¯                                 |
| --------------------------- | ----------------------------------------------------- | ------------------------------------ |
| `pool.map(func, iterable)`  | é˜»å¡å¼ï¼ŒæŒ‰é¡ºåºè¿”å›ç»“æœï¼Œç±»ä¼¼å†…ç½®`map`                 | ä»»åŠ¡ç®€å•ã€é¡ºåºå¤„ç†ã€éœ€å®Œæ•´ç»“æœ       |
| `pool.map_async(...)`       | å¼‚æ­¥éé˜»å¡ï¼Œè¿”å›`AsyncResult`å¯¹è±¡ï¼Œéœ€`.get()`è·å–ç»“æœ | éœ€è¦å¹¶å‘æ‰§è¡Œ + åç»­å¤„ç†              |
| `pool.apply(func, args)`    | å•ä»»åŠ¡é˜»å¡è°ƒç”¨ï¼ˆä¸€æ¬¡åªæ´¾ä¸€ä¸ªä»»åŠ¡ï¼‰                    | è°ƒè¯•æˆ–ç‰¹æ®Šå•ä»»åŠ¡                     |
| `pool.apply_async(...)`     | å•ä»»åŠ¡å¼‚æ­¥è°ƒç”¨ï¼Œè¿”å›`AsyncResult`ï¼Œå¯åŠ å›è°ƒ           | çµæ´»æ§åˆ¶æ¯ä¸ªä»»åŠ¡ + å›è°ƒ              |
| `pool.imap(func, iterable)` | è¿”å›è¿­ä»£å™¨ï¼Œç»“æœæŒ‰è¾“å…¥é¡ºåºé€ä¸ªäº§ç”Ÿï¼Œè¾¹ç®—è¾¹å–          | æ•°æ®é‡å¤§ï¼Œè¾¹è®¡ç®—è¾¹å¤„ç†ï¼Œé™ä½å†…å­˜å ç”¨ |

```python
from multiprocessing import Pool, current_process
import time
import os

def sample_task(x):
    """ç¤ºä¾‹ä»»åŠ¡"""
    process = current_process()
    pid = os.getpid()
    print(f"Processing {x} in {process.name} (PID: {pid})")
    time.sleep(1)
    return x * x

def callback_success(result):
    """æˆåŠŸå›è°ƒå‡½æ•°"""
    print(f"Task completed successfully: {result}")

def callback_error(error):
    """é”™è¯¯å›è°ƒå‡½æ•°"""
    print(f"Task failed with error: {error}")

def pool_methods_demo():
    """è¿›ç¨‹æ± ä¸åŒæ–¹æ³•æ¼”ç¤º"""
    print("=== è¿›ç¨‹æ± æ–¹æ³•æ¼”ç¤º ===")

    with Pool(processes=3) as pool:
        data = [1, 2, 3, 4, 5]

        print("\n1. ä½¿ç”¨ map() - é˜™å¡å¼æ‰¹é‡å¤„ç†")
        results = pool.map(sample_task, data)
        print(f"Map ç»“æœ: {results}")

        print("\n2. ä½¿ç”¨ map_async() - å¼‚æ­¥æ‰¹é‡å¤„ç†")
        async_result = pool.map_async(sample_task, data)
        print("å¼‚æ­¥ä»»åŠ¡å·²æäº¤ï¼Œç­‰å¾…ç»“æœ...")
        results = async_result.get(timeout=10)  # ç­‰å¾…ç»“æœ
        print(f"Map_async ç»“æœ: {results}")

        print("\n3. ä½¿ç”¨ apply() - å•ä¸ªä»»åŠ¡é˜™å¡å¼")
        result = pool.apply(sample_task, (10,))
        print(f"Apply ç»“æœ: {result}")

        print("\n4. ä½¿ç”¨ apply_async() - å•ä¸ªä»»åŠ¡å¼‚æ­¥")
        async_results = []
        for i in range(3):
            ar = pool.apply_async(
                sample_task,
                (i + 20,),
                callback=callback_success,
                error_callback=callback_error
            )
            async_results.append(ar)

        # è·å–æ‰€æœ‰å¼‚æ­¥ç»“æœ
        final_results = [ar.get() for ar in async_results]
        print(f"Apply_async ç»“æœ: {final_results}")

        print("\n5. ä½¿ç”¨ imap() - è¿­ä»£å¼å¤„ç†")
        for i, result in enumerate(pool.imap(sample_task, [30, 31, 32])):
            print(f"Imap ç»“æœ {i+1}: {result}")

if __name__ == '__main__':
    pool_methods_demo()
```

#### 7.1.3 è¿›ç¨‹æ±  vs æ‰‹åŠ¨åˆ›å»ºè¿›ç¨‹å¯¹æ¯”

* **ä¸€æ¬¡æ€§å°ä»»åŠ¡ â†’ `Process` æ›´å¿«**

* **é‡å¤å¤§é‡ä»»åŠ¡ â†’ `Pool` æ›´å¿«ï¼ˆèŠ‚çœè¿›ç¨‹åˆ›å»ºå¼€é”€ï¼‰**

**poolæ›´å¿«ï¼š**

```python
from multiprocessing import Process, Pool
import time


def task(x):
    return sum(i*i for i in range(10_000))

# æ¯æ¬¡æ–°å»º 10 ä¸ªè¿›ç¨‹


def run_processes():
    for _ in range(100):  # é‡å¤ 100 æ‰¹
        ps = []
        for i in range(10):
            p = Process(target=task, args=(i,))
            ps.append(p)
            p.start()
        for p in ps:
            p.join()

# ç”¨è¿›ç¨‹æ± å¤ç”¨è¿›ç¨‹


def run_pool():
    with Pool(10) as pool:
        for _ in range(100):  # é‡å¤ 100 æ‰¹
            pool.map(task, range(10))


if __name__ == '__main__':
    t1 = time.time()
    run_processes()
    print("Process:", time.time()-t1)

    t2 = time.time()
    run_pool()
    print("Pool:", time.time()-t2)

```

**processæ›´å¿«**

```python
from multiprocessing import Process, Pool
import time, os

def task(x):
    return sum(i*i for i in range(10_0000))

# æ‰‹åŠ¨åˆ›å»º 10 ä¸ªè¿›ç¨‹
def run_processes():
    ps = []
    for i in range(10):
        p = Process(target=task, args=(i,))
        ps.append(p)
        p.start()
    for p in ps:
        p.join()

# ç”¨è¿›ç¨‹æ± 
def run_pool():
    with Pool(10) as pool:
        pool.map(task, range(10))

if __name__ == '__main__':
    t1 = time.time(); run_processes(); print("Process:", time.time()-t1)
    t2 = time.time(); run_pool(); print("Pool:", time.time()-t2)

```



### 7.2 subprocess æ¨¡å—è¯¦è§£

`subprocess` æ¨¡å—æ˜¯Pythonä¸­ç”¨äºåˆ›å»ºå’Œç®¡ç†å­è¿›ç¨‹çš„æ ‡å‡†åº“ã€‚å®ƒå…è®¸ä½ å¯åŠ¨æ–°çš„åº”ç”¨ç¨‹åºã€è¿æ¥åˆ°å®ƒä»¬çš„è¾“å…¥/è¾“å‡º/é”™è¯¯ç®¡é“ï¼Œå¹¶è·å¾—è¿”å›ç ã€‚

#### 7.2.1 æ ¸å¿ƒæ¦‚å¿µ

**ä¸»è¦åŠŸèƒ½ï¼š**

- æ‰§è¡Œå¤–éƒ¨å‘½ä»¤å’Œç¨‹åº
- æ•è·å‘½ä»¤çš„è¾“å‡ºå’Œé”™è¯¯
- å‘å­è¿›ç¨‹å‘é€è¾“å…¥
- æ§åˆ¶è¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ

**ä¸¤ç§ä¸»è¦æ–¹å¼ä»¥åŠåŒºåˆ«ï¼š**

**subprocess.run()**

- âœ… **åŒæ­¥** - ç­‰å¾…å‘½ä»¤å®Œæˆæ‰è¿”å›
- âœ… **ç®€å•** - ä¸€è¡Œä»£ç æå®š
- âœ… **å®‰å…¨** - è‡ªåŠ¨èµ„æºæ¸…ç†
- âŒ **é˜»å¡** - æ— æ³•å®æ—¶è·å–è¾“å‡º
- âŒ **æ§åˆ¶æœ‰é™** - åªèƒ½è®¾ç½®è¶…æ—¶

**subprocess.Popen**

- âœ… **å¼‚æ­¥** - ç«‹å³è¿”å›è¿›ç¨‹å¯¹è±¡
- âœ… **å®æ—¶** - å¯ä»¥è¾¹æ‰§è¡Œè¾¹è·å–è¾“å‡º
- âœ… **çµæ´»** - å®Œå…¨æ§åˆ¶è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸ
- âŒ **å¤æ‚** - éœ€è¦æ‰‹åŠ¨ç®¡ç†èµ„æº
- âŒ **å®¹æ˜“å‡ºé”™** - å¿˜è®°cleanupå¯èƒ½é€ æˆåƒµå°¸è¿›ç¨‹

#### 7.2.2 ä½¿ç”¨ subprocess.run()

```python
import subprocess
import sys
import os

def run_basic_commands():
    """è¿è¡ŒåŸºç¡€å‘½ä»¤"""
    print("=== åŸºç¡€å‘½ä»¤æ‰§è¡Œ ===")

    # 1. åŸºç¡€å‘½ä»¤æ‰§è¡Œ
    print("1. æ‰§è¡Œ ls å‘½ä»¤:")
    result = subprocess.run(['ls', '-la'], capture_output=True, text=True)
    print(f"  è¿”å›ç : {result.returncode}")
    print(f"  è¾“å‡ºå‰5è¡Œ:\n{chr(10).join(result.stdout.split(chr(10))[:5])}")

    # 2. æ£€æŸ¥Pythonç‰ˆæœ¬
    print("\n2. æ£€æŸ¥Pythonç‰ˆæœ¬:")
    result = subprocess.run([sys.executable, '--version'],
                          capture_output=True, text=True)
    print(f"  Pythonç‰ˆæœ¬: {result.stdout.strip()}")

    # 3. æ‰§è¡Œç³»ç»Ÿå‘½ä»¤
    if os.name == 'posix':  # Unix-likeç³»ç»Ÿ
        print("\n3. è·å–ç³»ç»Ÿä¿¡æ¯:")
        result = subprocess.run(['uname', '-a'], capture_output=True, text=True)
        print(f"  ç³»ç»Ÿä¿¡æ¯: {result.stdout.strip()}")

    # 4. å¤„ç†é”™è¯¯
    print("\n4. å¤„ç†å‘½ä»¤é”™è¯¯:")
    result = subprocess.run(['nonexistent_command'],
                          capture_output=True, text=True)
    print(f"  è¿”å›ç : {result.returncode}")
    print(f"  é”™è¯¯è¾“å‡º: {result.stderr.strip()}")

def run_with_input():
    """å¸¦è¾“å…¥çš„å‘½ä»¤æ‰§è¡Œ"""
    print("\n=== å¸¦è¾“å…¥çš„å‘½ä»¤æ‰§è¡Œ ===")

    # ä½¿ç”¨grepå‘½ä»¤è¿‡æ»¤æ–‡æœ¬
    text_input = """apple
                    banana
                    cherry
                    apricot
                    blueberry"""

    result = subprocess.run(['grep', 'ap'],
                          input=text_input,
                          text=True,
                          capture_output=True)

    print(f"Grep ç»“æœ:\n{result.stdout}")

def run_python_script():
    """æ‰§è¡ŒPythonä»£ç """
    print("=== æ‰§è¡ŒPythonä»£ç  ===")

    python_code = """
                import sys
                import os
                print(f"Hello from subprocess!")
                print(f"Current PID: {os.getpid()}")
                print(f"Arguments: {sys.argv[1:]}")
                for i in range(3):
                    print(f"Count: {i+1}")
                """

    # æ‰§è¡Œå†…è”Pythonä»£ç 
    result = subprocess.run([sys.executable, '-c', python_code, 'arg1', 'arg2'],
                          capture_output=True, text=True)

    print(f"Pythonè„šæœ¬è¾“å‡º:\n{result.stdout}")

def subprocess_run_demo():
    """
subprocess.run() æ¼”ç¤º"""
    run_basic_commands()
    run_with_input()
    run_python_script()

if __name__ == '__main__':
    subprocess_run_demo()
```

#### 7.2.3 ä½¿ç”¨ subprocess.Popen

`Popen` æä¾›æ›´åº•å±‚çš„æ§åˆ¶ï¼Œé€‚åˆéœ€è¦å®æ—¶äº¤äº’çš„åœºæ™¯ï¼š

```python
import subprocess
import time
import threading

def popen_basic_example():
    """åŸºç¡€Popenç¤ºä¾‹"""
    print("=== åŸºç¡€Popenç¤ºä¾‹ ===")

    # åˆ›å»ºå­è¿›ç¨‹
    process = subprocess.Popen(
        ['python', '-c', '''import time
for i in range(5):
    print(f"Output {i+1}")
    time.sleep(1)'''],
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        text=True
    )

    print(f"å­è¿›ç¨‹PID: {process.pid}")
    print("ç­‰å¾…å­è¿›ç¨‹å®Œæˆ...")

    # ç­‰å¾…å®Œæˆå¹¶è·å–ç»“æœ
    stdout, stderr = process.communicate()

    print(f"è¿”å›ç : {process.returncode}")
    print(f"è¾“å‡º:\n{stdout}")
    if stderr:
        print(f"é”™è¯¯:\n{stderr}")

def popen_realtime_output():
    """å®æ—¶è¾“å‡ºç¤ºä¾‹"""
    print("\n=== å®æ—¶è¾“å‡ºç¤ºä¾‹ ===")

    # åˆ›å»ºä¸€ä¸ªæŒç»­è¾“å‡ºçš„è¿›ç¨‹
    process = subprocess.Popen(
        ['python', '-c', '''
    import time
    import sys
    for i in range(10):
    print(f"Real-time output {i+1}")
    sys.stdout.flush()  # åˆ·æ–°ç¼“å†²åŒº
    time.sleep(0.5)'''],
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        text=True,
        bufsize=1  # è¡Œç¼“å†²
    )

    print("å®æ—¶è¾“å‡º:")

    # è¯»å–å®æ—¶è¾“å‡º
    while True:
        output = process.stdout.readline()
        if output == '' and process.poll() is not None:
            break
        if output:
            print(f"  {output.strip()}")

    # è·å–ä»»ä½•å‰©ä½™è¾“å‡º
    remaining_output, stderr = process.communicate()
    if remaining_output:
        print(f"  {remaining_output}")

    print(f"è¿›ç¨‹ç»“æŸï¼Œè¿”å›ç : {process.returncode}")

def popen_interactive_example():
    """äº¤äº’å¼è¿›ç¨‹ç¤ºä¾‹"""
    print("\n=== äº¤äº’å¼è¿›ç¨‹ç¤ºä¾‹ ===")

    # å¯åŠ¨ä¸€ä¸ªPythonäº¤äº’å¼è§£é‡Šå™¨
    process = subprocess.Popen(
        ['python', '-i'],
        stdin=subprocess.PIPE,
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        text=True,
        bufsize=1
    )

    # å‘é€å‘½ä»¤å¹¶è¯»å–ç»“æœ
    commands = [
        "print('Hello from interactive Python!')",
        "x = 10",
        "y = 20",
        "print(f'x + y = {x + y}')",
        "import math",
        "print(f'sqrt(100) = {math.sqrt(100)}')",
        "exit()"  # é€€å‡ºPython
    ]

    for cmd in commands:
        print(f">>> {cmd}")
        process.stdin.write(cmd + '\n')
        process.stdin.flush()
        time.sleep(0.1)  # ç­‰å¾…è¾“å‡º

    # ç­‰å¾…è¿›ç¨‹ç»“æŸ
    stdout, stderr = process.communicate()

    print("è¾“å‡º:")
    # è¿‡æ»¤ä¸€äº›Pythonäº¤äº’å¼çš„å¹²æ‰°ä¿¡æ¯
    lines = stdout.split('\n')
    for line in lines:
        if line.strip() and not line.startswith('>>>') and not line.startswith('...'):
            print(f"  {line}")

def subprocess_popen_demo():
    """
subprocess.Popen æ¼”ç¤º"""
    popen_basic_example()
    popen_realtime_output()
    popen_interactive_example()

if __name__ == '__main__':
    subprocess_popen_demo()
```

#### 7.2.4 é”™è¯¯å¤„ç†å’Œè¶…æ—¶æ§åˆ¶

```python
import subprocess
import time

def error_handling_demo():
    """é”™è¯¯å¤„ç†æ¼”ç¤º"""
    print("=== é”™è¯¯å¤„ç†æ¼”ç¤º ===")

    # 1. ä½¿ç”¨check=Trueæ£€æŸ¥é”™è¯¯
    try:
        result = subprocess.run(
            ['python', '-c', 'raise ValueError("Something went wrong!")'],
            check=True,  # å¦‚æœè¿”å›ç é0åˆ™æŠ›å‡ºå¼‚å¸¸
            capture_output=True,
            text=True
        )
    except subprocess.CalledProcessError as e:
        print(f"1. å‘½ä»¤æ‰§è¡Œå¤±è´¥:")
        print(f"   è¿”å›ç : {e.returncode}")
        print(f"   é”™è¯¯è¾“å‡º: {e.stderr.strip()}")

    # 2. æ‰‹åŠ¨æ£€æŸ¥è¿”å›ç 
    print("\n2. æ‰‹åŠ¨æ£€æŸ¥è¿”å›ç :")
    result = subprocess.run(
        ['ls', '/nonexistent/directory'],
        capture_output=True,
        text=True
    )

    if result.returncode != 0:
        print(f"   å‘½ä»¤å¤±è´¥ï¼Œè¿”å›ç : {result.returncode}")
        print(f"   é”™è¯¯ä¿¡æ¯: {result.stderr.strip()}")

    # 3. å¤„ç†æ–‡ä»¶ä¸å­˜åœ¨çš„æƒ…å†µ
    try:
        result = subprocess.run(
            ['nonexistent_program'],
            check=True,
            capture_output=True
        )
    except FileNotFoundError:
        print("\n3. ç¨‹åºä¸å­˜åœ¨")
    except subprocess.CalledProcessError as e:
        print(f"\n3. ç¨‹åºæ‰§è¡Œå¤±è´¥: {e}")

def timeout_demo():
    """è¶…æ—¶æ§åˆ¶æ¼”ç¤º"""
    print("\n=== è¶…æ—¶æ§åˆ¶æ¼”ç¤º ===")

    # 1. subprocess.run çš„è¶…æ—¶
    try:
        print("1. æ‰§è¡Œè€æ—¶å‘½ä»¤ï¼ˆè®¾ç½®2ç§’è¶…æ—¶ï¼‰:")
        result = subprocess.run(
            ['python', '-c', 'import time; time.sleep(5); print("Done")'],
            timeout=2,  # 2ç§’è¶…æ—¶
            capture_output=True,
            text=True
        )
        print(f"   ç»“æœ: {result.stdout}")
    except subprocess.TimeoutExpired:
        print("   å‘½ä»¤æ‰§è¡Œè¶…æ—¶")

    # 2. Popen çš„è¶…æ—¶æ§åˆ¶
    print("\n2. Popen è¶…æ—¶æ§åˆ¶:")
    process = subprocess.Popen(
        ['python', '-c', '''
import time
print("Starting long task...")
for i in range(10):
    print(f"Step {i+1}")
    time.sleep(1)
print("Task completed")'''],
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        text=True
    )

    try:
        stdout, stderr = process.communicate(timeout=3)
        print(f"   è¾“å‡º: {stdout}")
    except subprocess.TimeoutExpired:
        print("   è¿›ç¨‹è¶…æ—¶ï¼Œæ­£åœ¨ç»ˆæ­¢...")
        process.kill()  # ç»ˆæ­¢è¿›ç¨‹
        stdout, stderr = process.communicate()  # æ¸…ç†ç¼“å†²åŒº
        print("   è¿›ç¨‹å·²ç»ˆæ­¢")

def advanced_subprocess_demo():
    """é«˜çº§subprocessåŠŸèƒ½æ¼”ç¤º"""
    error_handling_demo()
    timeout_demo()

if __name__ == '__main__':
    advanced_subprocess_demo()
```

## æ€»ç»“

åœ¨ç¬¬äºŒéƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬æ·±å…¥å­¦ä¹ äº†Pythonå¤šè¿›ç¨‹ç¼–ç¨‹çš„æ‰€æœ‰å…³é”®æ¦‚å¿µï¼š

1. **è¿›ç¨‹åŸºç¡€ç†è®º**ï¼šè¿›ç¨‹çš„å®šä¹‰ã€ç»„æˆã€çŠ¶æ€è½¬æ¢å’Œè°ƒåº¦ç®—æ³•
2. **ç‰¹æ®Šè¿›ç¨‹ç±»å‹**ï¼šå­¤å„¿è¿›ç¨‹ã€åƒµå°¸è¿›ç¨‹ã€å®ˆæŠ¤è¿›ç¨‹çš„æ·±å…¥åˆ†æ
3. **è¿›ç¨‹åˆ›å»ºä¸ç®¡ç†**ï¼šos.fork()å’Œmultiprocessingæ¨¡å—çš„å…¨é¢ä½¿ç”¨
4. **è¿›ç¨‹é—´é€šä¿¡**ï¼šQueueã€Pipeç­‰é€šä¿¡æœºåˆ¶å’ŒåŒæ­¥åŸè¯­
5. **é«˜çº§è¿›ç¨‹ç®¡ç†**ï¼šè¿›ç¨‹æ± å’Œsubprocessæ¨¡å—çš„å®é™…åº”ç”¨

# 